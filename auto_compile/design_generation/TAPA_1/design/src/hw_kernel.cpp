#include "util.h"
/**
 *  This file is automatically generated by PolySA CodeGen.
 *  Version: 1.0
 *  Authos: Jie Wang
 */

// vendor headers
#include <tapa.h>
#include "ap_int.h"
#include "ap_fixed.h"

// common headers
#include <stdio.h>
#include <string.h>
using namespace hls;

#define cal_aligned_size(x,y) ((x+y-1)/y*y)
#define unpack(num, i) num(((4-i)*8)-1, ((4-i)*8)-8)

typedef ap_uint<192> U1_ConfigInst;

// Data types
typedef float U1_data_t0;
typedef ap_uint<512> U1_bus_t0;
#define U1_DATA0_WIDTH 32
#define U1_DATA0_PACK_FACTOR (512/U1_DATA0_WIDTH)
typedef float U1_data_t1;
typedef ap_uint<512> U1_bus_t1;
#define U1_DATA1_WIDTH 32
#define U1_DATA1_PACK_FACTOR (512/U1_DATA1_WIDTH)
typedef float U1_data_t2;
typedef ap_uint<512> U1_bus_t2;
#define U1_DATA2_WIDTH 32
#define U1_DATA2_PACK_FACTOR (512/U1_DATA2_WIDTH)
typedef unsigned int uint;
union ufloat{
  float f;
  unsigned int u;
};

// Macros
#define U1_SA_ROWS 8
#define U1_SA_COLS 9
#define U1_SIMD_FACTOR 8
#define U1_DATA0_FC_SIMD_FACTOR 8
#define U1_DATA0_FC_GROUP_FACTOR 1
#define U1_DATA0_FC_SPLIT_FACTOR 1
#define U1_DATA1_FC_SIMD_FACTOR 8
#define U1_DATA1_FC_GROUP_FACTOR 1
#define U1_DATA1_FC_SPLIT_FACTOR 1
#define U1_DATA2_FC_SIMD_FACTOR 8
#define U1_DATA2_FC_GROUP_FACTOR 1
#define U1_DATA2_FC_SPLIT_FACTOR 1

// Functions and structs
struct U1_Data0TransferChannelType{
  U1_Data0TransferChannelType(){}
  U1_Data0TransferChannelType(
    ap_uint<U1_DATA0_WIDTH*U1_DATA0_FC_SIMD_FACTOR> data_t,
    unsigned int feeder_id_t,
    bool new_pair_t,
    bool last_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    feeder_id = feeder_id_t;
    new_pair = new_pair_t;
    last_pair = last_pair_t;
    FILTER_S = filter_s_t;
  }
  ap_uint<U1_DATA0_WIDTH*U1_DATA0_FC_SIMD_FACTOR> data;
  unsigned int feeder_id;
  bool new_pair;
  bool last_pair;
  unsigned int FILTER_S;
};

struct U1_Data1TransferChannelType{
  U1_Data1TransferChannelType(){}
  U1_Data1TransferChannelType(
    ap_uint<U1_DATA1_WIDTH*U1_DATA1_FC_SIMD_FACTOR> data_t,
    unsigned int feeder_id_t,
    bool new_pair_t,
    bool last_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    feeder_id = feeder_id_t;
    new_pair = new_pair_t;
    last_pair = last_pair_t;
    FILTER_S = filter_s_t;
  }
  ap_uint<U1_DATA1_WIDTH*U1_DATA1_FC_SIMD_FACTOR> data;
  unsigned int feeder_id;
  bool new_pair;
  bool last_pair;
  unsigned int FILTER_S;
};

struct U1_Data2TransferChannelType{
  U1_Data2TransferChannelType(){}
  U1_Data2TransferChannelType(
    ap_uint<U1_DATA2_WIDTH*U1_DATA2_FC_SIMD_FACTOR> data_t){
    data = data_t;
  }
  ap_uint<U1_DATA2_WIDTH*U1_DATA2_FC_SIMD_FACTOR> data;
};

struct U1_Data0PEChannelType{
  U1_Data0PEChannelType(){}
  U1_Data0PEChannelType(
    ap_uint<256> data_t
  ){
    data = data_t;
  }
  U1_Data0PEChannelType(
    ap_uint<256> data_t,
    bool new_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    new_pair = new_pair_t;
    FILTER_S = filter_s_t;
  }
  U1_Data0PEChannelType(
    ap_uint<256> data_t,
    bool new_pair_t,
    bool last_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    new_pair = new_pair_t;
    last_pair = last_pair_t;
    FILTER_S = filter_s_t;
  }
  ap_uint<256> data;
  bool new_pair;
  bool last_pair;
  unsigned int FILTER_S;
};

typedef ap_uint<256> U1_Data0SIMDType;

struct U1_Data1PEChannelType{
  U1_Data1PEChannelType(){}
  U1_Data1PEChannelType(
    ap_uint<256> data_t
  ){
    data = data_t;
  }
  U1_Data1PEChannelType(
    ap_uint<256> data_t,
    bool new_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    new_pair = new_pair_t;
    FILTER_S = filter_s_t;
  }
  U1_Data1PEChannelType(
    ap_uint<256> data_t,
    bool new_pair_t,
    bool last_pair_t,
    unsigned int filter_s_t
  ){
    data = data_t;
    new_pair = new_pair_t;
    last_pair = last_pair_t;
    FILTER_S = filter_s_t;
  }
  ap_uint<256> data;
  bool new_pair;
  bool last_pair;
  unsigned int FILTER_S;
};

typedef ap_uint<256> U1_Data1SIMDType;

struct U1_Data2PEChannelType{
  U1_Data2PEChannelType(){}
  U1_Data2PEChannelType(
    U1_data_t2 data_t){
    data = data_t;
  }
  U1_data_t2 data;
};

/**
 *  This file is automatically generated by PolySA CodeGen.
 *  Version: 1.0
 *  Authos: Jie Wang
 */

//#include "common_header_U1.h"

void U1_DataFeed0Head(
  uint start_inst, uint end_inst,
  tapa::istream<ap_uint<U1_DATA0_WIDTH * U1_DATA0_FC_SIMD_FACTOR> > &fifo_transfer_in,
  tapa::ostream<U1_Data0TransferChannelType> &fifo_transfer_out0,
  tapa::istream<U1_ConfigInst> &fifo_kernel_config_in,
  tapa::ostream<U1_ConfigInst> &fifo_kernel_config_out,
  tapa::ostream<uint> &fifo_config_out0,
  tapa::ostream<uint> &fifo_config_out1,
  tapa::ostream<ap_uint<U1_DATA0_WIDTH * U1_DATA0_FC_SIMD_FACTOR> > &fifo_bypass_data,
  tapa::ostream<uint> &fifo_config_bypass
){
#pragma HLS INLINE off
#pragma HLS DATA_PACK variable=fifo_transfer_out0
  bool inst_done = 0;
  uint inst = 0;
  int inst_count = end_inst - start_inst;
  fifo_config_out0.write(inst_count);
  fifo_config_out1.write(inst_count);
  while(!inst_done){
  // loader buffer
  ap_uint<U1_DATA0_WIDTH * U1_DATA0_FC_SIMD_FACTOR> cin_buf[CIN_BUFF / U1_DATA0_FC_SIMD_FACTOR];
  #if U1_DataFeed0Head_MEM == 0
    #pragma HLS bind_storage variable=cin_buf type=RAM_T2P impl=BRAM
  #elif U1_DataFeed0Head_MEM == 1
    #pragma HLS bind_storage variable=cin_buf type=RAM_T2P impl=URAM
  #endif
  #pragma HLS ARRAY_PARTITION variable=cin_buf dim=1 block factor=1

  // Read instructions
  U1_ConfigInst inst0 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst0);
  U1_ConfigInst inst1 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst1);
  U1_ConfigInst inst2 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst2);
  U1_ConfigInst inst3 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst3);
  U1_ConfigInst inst4 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst4);
  U1_ConfigInst inst5 = fifo_kernel_config_in.read();
  fifo_kernel_config_out.write(inst5);
	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);
		// Refer to cin_load module to understand the meaning of the instructions
		// inst0
	ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
		// inst1
	ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
		// inst2
	ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
	ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
	ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
	ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
	ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
	ap_uint<8>  FILTER_S2_H      = inst2(32*4+23, 32*4+16);
	ap_uint<8>  FILTER_S2_W      = inst2(32*4+31, 32*4+24);
	ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
		// inst3
	ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
	ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
	ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
	ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
	ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
	ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

	ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
	ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
	ap_uint<1>  CONV_EN        = LAYER_EN[2];
	ap_uint<1>  RELU_EN        = LAYER_EN[3];
	ap_uint<1>  RELU6_EN       = LAYER_EN[4];
	ap_uint<1>  POOL_EN        = LAYER_EN[5];
	ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
	ap_uint<1>  BIAS_EN        = LAYER_EN[7];
	ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
	uint FILTER_S = (CONV_EN == 1)? (uint)FILTER_S2_H: 1;
	bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
	bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
	bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
  fifo_config_out0.write(CONV_EN);
  fifo_config_out1.write(CONV_EN);

  switch(CONV_EN){
  case 0:{
    for (int layer_iter = 0; layer_iter < LAYER_BATCH; layer_iter++){
      // Read instructions
      fifo_config_bypass.write(LAYER_IN_NUM_HW);
      fifo_config_bypass.write(LAYER_OUT_NUM_HW);
      fifo_config_bypass.write(LAYER_IN_H_HW);
      fifo_config_bypass.write(LAYER_IN_W_HW);

      fifo_config_bypass.write(LAYER_IN_NUM_T);
      fifo_config_bypass.write(LAYER_OUT_NUM_T);
      fifo_config_bypass.write(LAYER_IN_H_T);
      fifo_config_bypass.write(LAYER_IN_W_T);

      fifo_config_bypass.write(FILTER_S2_H);
      fifo_config_bypass.write(FILTER_S2_W);
      fifo_config_bypass.write(STRIDE);
        // Refer to cin_load module to understand the meaning of the instructions
        // inst0
      LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
      LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
      LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
      LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
      LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
      LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
        // inst1
      LAYER_IN_NUM     = inst1(32*0+31, 32*0);
      LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
      LAYER_IN_H       = inst1(32*2+31, 32*2);
      LAYER_IN_W       = inst1(32*3+31, 32*3);
      LAYER_OUT_H      = inst1(32*4+31, 32*4);
      LAYER_OUT_W      = inst1(32*5+31, 32*5);
        // inst2
      CIN_OFFSET       = inst2(32*0+31, 32*0);
      WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
      BIAS_OFFSET      = inst2(32*2+31, 32*2);
      COUT_OFFSET      = inst2(32*3+31, 32*3);
      FILTER_S1        = inst2(32*4+15, 32*4);
      FILTER_S2_H      = inst2(32*4+23, 32*4+16);
      FILTER_S2_W      = inst2(32*4+31, 32*4+24);
      STRIDE           = inst2(32*5+31, 32*5);
        // inst3
      LAYER_EN         = inst3(32*0+31, 32*0);
      PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
      LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
      LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
      LAYER_IN_H_T     = inst3(32*3+31, 32*3);
      LAYER_IN_W_T     = inst3(32*4+31, 32*4);

      CONV_1ST_EN      = LAYER_EN[0];
      DEPTH_CONV_EN    = LAYER_EN[1];
      CONV_EN          = LAYER_EN[2];
      RELU_EN          = LAYER_EN[3];
      RELU6_EN         = LAYER_EN[4];
      POOL_EN          = LAYER_EN[5];
      UP_SAMPLE_EN     = LAYER_EN[6]; 	// reserved

        // Set up some configuration signals
      FILTER_S = (CONV_EN == 1)? (uint)FILTER_S2_H: 1;
      separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
      conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
      max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);

      int in_h_iter = 0;
      int in_w_iter = 0;
      int out_num_iter = 0;
      int in_num_iter = 0;
      bool done1 = 0;
      while(!done1){
        if ((max_pool && out_num_iter == 0) || (UP_SAMPLE_EN && out_num_iter == 0)){
          int o = 0;
          int h = 0;
          int w = 0;
          bool done2 = 0;
          while(!done2){
            #pragma HLS PIPELINE II=1
            DepthConvData0Type tmp = fifo_transfer_in.read();
            fifo_bypass_data.write(tmp);
              // Repeat until the whole tile is read
            w++;
            if (w == LAYER_IN_W_T + FILTER_S - 1){
              w = 0;
              h++;
              if (h == LAYER_IN_H_T + FILTER_S - 1){
                h = 0;
                o++;
                if (o == LAYER_IN_NUM_T / CONV_LANE){
                  o = 0;
                  done2 = 1;
                }
              }
            }
          }
        }
          // Repeat until all the tiles are read
          // Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
        in_num_iter += LAYER_IN_NUM_T;
        if (in_num_iter >= LAYER_IN_NUM){
          in_num_iter = 0;
          in_w_iter += LAYER_IN_W_T;
          if (in_w_iter >= LAYER_IN_W){
            in_w_iter = 0;
            in_h_iter += LAYER_IN_H_T;
            if (in_h_iter >= LAYER_IN_H){
              in_h_iter = 0;
              done1 = 1;
            }
          }
        }
      }
    }
  }break;
  case 1:{
    ap_uint<3> layer_iter = 0;
    bool done1 = 0;
    while(!done1){
      if (layer_iter > 0){
        // Read instructions
        inst0 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst0);
        inst1 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst1);
        inst2 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst2);
        inst3 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst3);
        inst4 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst4);
        inst5 = fifo_kernel_config_in.read();
        fifo_kernel_config_out.write(inst5);
      }
      ap_uint<32> EXT_LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
      ap_uint<32> EXT_LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
      ap_uint<32> EXT_LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
      ap_uint<32> EXT_LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
      ap_uint<32> EXT_LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
      ap_uint<32> EXT_LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
      // inst1
      ap_uint<32> EXT_LAYER_IN_NUM     = inst1(32*0+31, 32*0);
      ap_uint<32> EXT_LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
      ap_uint<32> EXT_LAYER_IN_H       = inst1(32*2+31, 32*2);
      ap_uint<32> EXT_LAYER_IN_W       = inst1(32*3+31, 32*3);
      ap_uint<32> EXT_LAYER_OUT_H      = inst1(32*4+31, 32*4);
      ap_uint<32> EXT_LAYER_OUT_W      = inst1(32*5+31, 32*5);
      // inst2
      ap_uint<32> EXT_CIN_OFFSET       = inst2(32*0+31, 32*0);
      ap_uint<32> EXT_WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
      ap_uint<32> EXT_BIAS_OFFSET      = inst2(32*2+31, 32*2);
      ap_uint<32> EXT_COUT_OFFSET      = inst2(32*3+31, 32*3);
      ap_uint<16> EXT_FILTER_S1        = inst2(32*4+15, 32*4);
      ap_uint<8>  EXT_FILTER_S2_H      = inst2(32*4+23, 32*4+16);
      ap_uint<8>  EXT_FILTER_S2_W      = inst2(32*4+31, 32*4+24);
      ap_uint<32> EXT_STRIDE           = inst2(32*5+31, 32*5);
      // inst3
      ap_uint<32> EXT_LAYER_EN         = inst3(32*0+31, 32*0);
      ap_uint<32> EXT_PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
      ap_uint<16> EXT_LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
      ap_uint<16> EXT_LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
      ap_uint<32> EXT_LAYER_IN_IMG_H_T = inst3(32*3+31, 32*3);
      ap_uint<32> EXT_LAYER_IN_IMG_W_T = inst3(32*4+31, 32*4);
      ap_uint<1>  EXT_CONV_1ST_EN      = EXT_LAYER_EN[0];
      ap_uint<1>  EXT_DEPTH_CONV_EN    = EXT_LAYER_EN[1];
      ap_uint<1>  EXT_CONV_EN          = EXT_LAYER_EN[2];
      ap_uint<1>  EXT_RELU_EN          = EXT_LAYER_EN[3];
      ap_uint<1>  EXT_RELU6_EN         = EXT_LAYER_EN[4];
      ap_uint<1>  EXT_POOL_EN          = EXT_LAYER_EN[5];

      ap_uint<32> EXT_LAYER_TASK_NUM1        = inst4(32*0+31, 32*0);
      ap_uint<32> EXT_LAYER_TASK_NUM2        = inst4(32*1+31, 32*1);
      ap_uint<32> EXT_LAYER_LOCAL_ACCUM_NUM  = inst4(32*2+31, 32*2);
      ap_uint<32> EXT_LAYER_LOCAL_REG_NUM    = inst4(32*3+31, 32*3);
      ap_uint<32> EXT_LAYER_ROW_IL_FACTOR    = inst4(32*4+31, 32*4);
      ap_uint<32> EXT_LAYER_COL_IL_FACTOR    = inst4(32*5+31, 32*5);

      ap_uint<16> EXT_LAYER_CONV_TYPE     = inst5(32*0+15, 32*0);
      ap_uint<8>  EXT_FILTER_D0_H         = inst5(32*0+23, 32*0+16);
      ap_uint<8>  EXT_FILTER_D0_W         = inst5(32*0+31, 32*0+24);
      ap_uint<8>  EXT_FILTER_D1_H         = inst5(32*1+7, 32*1);
      ap_uint<8>  EXT_FILTER_D1_W         = inst5(32*1+15, 32*1+8);
      ap_uint<16> EXT_LAYER_DILATION_RATE = inst5(32*1+31, 32*1+16);
      ap_uint<16> EXT_LAYER_TCONV_STRIDE  = inst5(32*2+15, 32*2);
      ap_uint<16> EXT_K_NUM               = inst5(32*2+31, 32*2+16);
      ap_uint<32> EXT_KH                  = inst5(32*3+31, 32*3);
      ap_uint<32> EXT_KW                  = inst5(32*4+31, 32*4);

      bool separable_conv = (EXT_DEPTH_CONV_EN == 1) && (EXT_CONV_EN == 1);
      bool conv2d = (EXT_DEPTH_CONV_EN == 0) && (EXT_CONV_EN == 1);
      bool max_pool = (EXT_DEPTH_CONV_EN == 0) && (EXT_CONV_EN == 0);
      uint stride1 = (EXT_DEPTH_CONV_EN == 0)? 1 : (uint)EXT_STRIDE;
      uint stride2 = (EXT_DEPTH_CONV_EN == 0)? (uint)EXT_STRIDE : 1;

      uint LAYER_IN_IMG_H = (EXT_DEPTH_CONV_EN == 1)? (uint)EXT_LAYER_IN_H_HW - (uint)EXT_FILTER_S1 + 1: (uint)EXT_LAYER_IN_H_HW;
      uint LAYER_IN_IMG_W = (EXT_DEPTH_CONV_EN == 1)? (uint)EXT_LAYER_IN_W_HW - (uint)EXT_FILTER_S1 + 1: (uint)EXT_LAYER_IN_W_HW;
      uint LAYER_OUT_IMG_H = EXT_LAYER_OUT_H;
      uint LAYER_OUT_IMG_W = EXT_LAYER_OUT_W;
      uint LAYER_IN_NUM = EXT_LAYER_IN_NUM_HW;
      uint LAYER_OUT_NUM = EXT_LAYER_OUT_NUM_HW;
      uint LAYER_IN_NUM_T = EXT_LAYER_IN_NUM_T;
      uint LAYER_OUT_NUM_T = EXT_LAYER_OUT_NUM_T;
      uint LAYER_IN_IMG_H_T;
      uint LAYER_IN_IMG_W_T;
      if (stride1 == 1){
        LAYER_IN_IMG_H_T = EXT_LAYER_IN_IMG_H_T;
        LAYER_IN_IMG_W_T = EXT_LAYER_IN_IMG_W_T;
      } else if (stride1 == 2){
        LAYER_IN_IMG_H_T = EXT_LAYER_IN_IMG_H_T / 2;
        LAYER_IN_IMG_W_T = EXT_LAYER_IN_IMG_W_T / 2;
      }
      uint LAYER_FILTER_S_H = EXT_FILTER_S2_H;
      uint LAYER_FILTER_S_W = EXT_FILTER_S2_W;
      uint LAYER_STRIDE = stride2;

      uint LAYER_TASK_NUM1 = EXT_LAYER_TASK_NUM1;
      uint LAYER_TASK_NUM2 = EXT_LAYER_TASK_NUM2;
      uint LAYER_LOCAL_ACCUM_NUM = EXT_LAYER_LOCAL_ACCUM_NUM;
      uint LAYER_LOCAL_REG_NUM = EXT_LAYER_LOCAL_REG_NUM;
      uint LAYER_ROW_IL_FACTOR = EXT_LAYER_ROW_IL_FACTOR;
      uint LAYER_COL_IL_FACTOR = EXT_LAYER_COL_IL_FACTOR;

      uint LAYER_CONV_TYPE = EXT_LAYER_CONV_TYPE;
      uint FILTER_D0_H = EXT_FILTER_D0_H;
      uint FILTER_D0_W = EXT_FILTER_D0_W;
      uint FILTER_D1_H = EXT_FILTER_D1_H;
      uint FILTER_D1_W = EXT_FILTER_D1_W;
      uint LAYER_DILATION_RATE = EXT_LAYER_DILATION_RATE;
      uint LAYER_TCONV_STRIDE = EXT_LAYER_TCONV_STRIDE;
      uint K_NUM = EXT_K_NUM;
      ap_uint<32> KH = EXT_KH;
      ap_uint<32> KW = EXT_KW;
      // write out configurations
      fifo_config_out0.write(LAYER_IN_NUM_T);
      fifo_config_out0.write(LAYER_OUT_NUM_T);
      fifo_config_out0.write(LAYER_IN_IMG_H_T);
      fifo_config_out0.write(LAYER_IN_IMG_W_T);
      fifo_config_out0.write(LAYER_FILTER_S_H);
      fifo_config_out0.write(LAYER_FILTER_S_W);
      fifo_config_out0.write(LAYER_TASK_NUM1);
      fifo_config_out0.write(LAYER_TASK_NUM2);
      fifo_config_out0.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out0.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out0.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out0.write(LAYER_COL_IL_FACTOR);
      fifo_config_out0.write(LAYER_STRIDE);
      fifo_config_out0.write(LAYER_BATCH);

      fifo_config_out0.write(LAYER_CONV_TYPE);
      fifo_config_out0.write(FILTER_D0_H);
      fifo_config_out0.write(FILTER_D0_W);
      fifo_config_out0.write(FILTER_D1_H);	
      fifo_config_out0.write(FILTER_D1_W);	
      fifo_config_out0.write(LAYER_DILATION_RATE);
      fifo_config_out0.write(LAYER_TCONV_STRIDE);
      fifo_config_out0.write(K_NUM);
      fifo_config_out0.write(KH);
      fifo_config_out0.write(KW);
      fifo_config_out1.write(LAYER_IN_NUM);
      fifo_config_out1.write(LAYER_IN_NUM_T);
      fifo_config_out1.write(LAYER_OUT_NUM_T);
      fifo_config_out1.write(LAYER_IN_IMG_H_T);
      fifo_config_out1.write(LAYER_IN_IMG_W_T);
      fifo_config_out1.write(LAYER_FILTER_S_H);
      fifo_config_out1.write(LAYER_FILTER_S_W);
      fifo_config_out1.write(LAYER_TASK_NUM1);
      fifo_config_out1.write(LAYER_TASK_NUM2);
      fifo_config_out1.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out1.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out1.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out1.write(LAYER_COL_IL_FACTOR);
      fifo_config_out1.write(LAYER_STRIDE);
      fifo_config_out1.write(LAYER_BATCH);

      fifo_config_out1.write(LAYER_CONV_TYPE);
      fifo_config_out1.write(FILTER_D0_H);
      fifo_config_out1.write(FILTER_D0_W);
      fifo_config_out1.write(FILTER_D1_H);	
      fifo_config_out1.write(FILTER_D1_W);	
      fifo_config_out1.write(LAYER_DILATION_RATE);
      fifo_config_out1.write(LAYER_TCONV_STRIDE);
      fifo_config_out1.write(K_NUM);
      fifo_config_out1.write(KH);
      fifo_config_out1.write(KW);
      ap_uint<29> task_iter = 0;
      ap_uint<10> in_num_t = 0;
      bool done2 = 0;
      while(!done2){
        if (FILTER_D0_W > 1 || FILTER_D0_H > 1){ //TODO this is to check overlapping tiles
          bool done3 = 0;
          ap_uint<10> ii = 0;
          ap_uint<12> hh = 0;
          ap_uint<12> ww = 0;
          while(!done3){
#pragma HLS PIPELINE II=1
            uint cin_local_idx = hh *  (LAYER_IN_IMG_W_T + FILTER_D0_W - LAYER_STRIDE) * LAYER_IN_NUM_T + ww * LAYER_IN_NUM_T + ii * U1_DATA0_FC_SIMD_FACTOR;
            cin_buf[cin_local_idx / U1_DATA0_FC_SIMD_FACTOR] = fifo_transfer_in.read();
            ww++;
            if (ww == LAYER_IN_IMG_W_T + FILTER_D0_W - LAYER_STRIDE){
              ww = 0;
              hh++;
              if (hh == LAYER_IN_IMG_H_T + FILTER_D0_H - LAYER_STRIDE){
                hh = 0;
                ii++;
                if (ii == LAYER_IN_NUM_T / U1_DATA0_FC_SIMD_FACTOR){
                  ii = 0;
                  done3 = 1;
                }
              }
            }
          }
        }
        bool init_final = (in_num_t == 0);
        bool last = (in_num_t == (LAYER_IN_NUM - LAYER_IN_NUM_T));
        // write to SA
        ap_uint<U1_DATA0_WIDTH * U1_DATA0_FC_SIMD_FACTOR> sel_tmp0[U1_DATA0_PACK_FACTOR / U1_DATA0_FC_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=sel_tmp0 complete dim=1
        ap_uint<10> t3 = 0;
        ap_uint<12> t1 = 0;
        ap_uint<7> t0 = 0;
        ap_uint<9> t2 = 0;
        bool done4 = 0;
        while(!done4){
#pragma HLS PIPELINE II=1
          uint local_in_img_w = t0 * (LAYER_IN_IMG_W_T / U1_SA_COLS) + t2;
          uint local_in_num = in_num_t + t3 * U1_DATA0_FC_SIMD_FACTOR;
          uint local_in_img_h = t1;
          uint feeder_id = t0 / U1_DATA0_FC_GROUP_FACTOR;
          ap_uint<U1_DATA0_WIDTH * U1_DATA0_FC_SIMD_FACTOR> wide_data0;
          if (FILTER_D0_W > 1 || FILTER_D0_H > 1){
            uint cin_local_index = local_in_img_h * (LAYER_IN_IMG_W_T + FILTER_D0_W - LAYER_STRIDE) * LAYER_IN_NUM_T + local_in_img_w * LAYER_IN_NUM_T + t3 * U1_DATA0_FC_SIMD_FACTOR;
            uint cin_bus_index = cin_local_index / U1_DATA0_FC_SIMD_FACTOR;
            wide_data0 = cin_buf[cin_bus_index];
          } else {
            wide_data0 = fifo_transfer_in.read();
          }
          fifo_transfer_out0.write(U1_Data0TransferChannelType(
            wide_data0,
            (uint)feeder_id, init_final, last, 1));

          t2++;
          if (t2 == LAYER_IN_IMG_W_T / U1_SA_COLS + FILTER_D0_W - LAYER_STRIDE){
            t2 = 0;
            t0++;
            if (t0 == U1_SA_COLS / U1_DATA0_FC_SPLIT_FACTOR){
              t0 = 0;
              t1++;
              if (t1 == LAYER_IN_IMG_H_T + FILTER_D0_H - LAYER_STRIDE){
                t1 = 0;
                t3++;
                if (t3 == LAYER_IN_NUM_T / U1_DATA0_FC_SIMD_FACTOR){
                  t3 = 0;
                  done4 = 1;
                }
              }
            }
          }
        }

        in_num_t += LAYER_IN_NUM_T;
        if (in_num_t == LAYER_IN_NUM){
          in_num_t = 0;
          task_iter++;
          if (task_iter == LAYER_TASK_NUM2){
            task_iter = 0;
            done2 = 1;
          }
        }
      }
      layer_iter++;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done1 = 1;
      }
    }
  }break;
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataFeed1Head(
  tapa::istream<ap_uint<U1_DATA1_WIDTH * U1_DATA1_FC_SIMD_FACTOR> > &fifo_transfer_in,
  tapa::ostream<U1_Data1TransferChannelType> &fifo_transfer_out0,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS INLINE off
#pragma HLS DATA_PACK variable=fifo_transfer_out0
  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM = fifo_config_in.read();
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // loader buffer
  ap_uint<U1_DATA1_WIDTH * U1_DATA1_FC_SIMD_FACTOR> weight_buf[WEIGHT_BUFF / U1_DATA1_FC_SIMD_FACTOR];
  #if U1_DataFeed1Head_MEM == 0
    #pragma HLS bind_storage variable=weight_buf type=RAM_T2P impl=BRAM
  #elif U1_DataFeed1Head_MEM == 1
    #pragma HLS bind_storage variable=weight_buf type=RAM_T2P impl=URAM
  #endif
#pragma HLS ARRAY_PARTITION variable=weight_buf dim=1 block factor=1

  bool done1 = 0;
  ap_uint<3> layer_iter = 0;
  while(!done1){
    if (layer_iter > 0){
      LAYER_IN_NUM = fifo_config_in.read();
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
    }
    // write out configurations
    fifo_config_out.write(LAYER_IN_NUM_T);
    fifo_config_out.write(LAYER_OUT_NUM_T);
    fifo_config_out.write(LAYER_IN_IMG_H_T);
    fifo_config_out.write(LAYER_IN_IMG_W_T);
    fifo_config_out.write(LAYER_FILTER_S_H);
    fifo_config_out.write(LAYER_FILTER_S_W);
    fifo_config_out.write(LAYER_TASK_NUM1);
    fifo_config_out.write(LAYER_TASK_NUM2);
    fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
    fifo_config_out.write(LAYER_LOCAL_REG_NUM);
    fifo_config_out.write(LAYER_ROW_IL_FACTOR);
    fifo_config_out.write(LAYER_COL_IL_FACTOR);
    fifo_config_out.write(LAYER_STRIDE);
    fifo_config_out.write(LAYER_BATCH);

    fifo_config_out.write(LAYER_CONV_TYPE);
    fifo_config_out.write(FILTER_D0_H);
    fifo_config_out.write(FILTER_D0_W);
    fifo_config_out.write(FILTER_D1_H);	
    fifo_config_out.write(FILTER_D1_W);	
    fifo_config_out.write(LAYER_DILATION_RATE);
    fifo_config_out.write(LAYER_TCONV_STRIDE);
    fifo_config_out.write(K_NUM);
    fifo_config_out.write(KH);
    fifo_config_out.write(KW);
    bool done2 = 0;
    uint task_iter = 0;
    ap_uint<10> in_num_t = 0;
    while(!done2){
      bool init_final = (in_num_t == 0);
      bool last = (in_num_t == (LAYER_IN_NUM - LAYER_IN_NUM_T));
      // write to SA
      ap_uint<U1_DATA1_WIDTH * U1_DATA1_FC_SIMD_FACTOR> sel_tmp0[U1_DATA1_PACK_FACTOR / U1_DATA1_FC_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=sel_tmp0 complete dim=1
      ap_uint<6> t0 = 0;
      ap_uint<6> t1 = 0;
      ap_uint<6> t2 = 0;
      ap_uint<6> t3 = 0;
      ap_uint<10> t4 = 0;
      bool done3 = 0;
      while(!done3){
#pragma HLS PIPELINE II=1
        ap_uint<6> feeder_id = t0 / U1_DATA1_FC_GROUP_FACTOR;
        ap_uint<U1_DATA1_WIDTH * U1_DATA1_FC_SIMD_FACTOR> wide_data0;
        wide_data0 = fifo_transfer_in.read();
        fifo_transfer_out0.write(U1_Data1TransferChannelType(
          wide_data0,
          (uint)feeder_id, init_final, last, 1));

        t4++;
        if (t4 == LAYER_IN_NUM_T / U1_DATA1_FC_SIMD_FACTOR){
          t4 = 0;
          t3++;
          if (t3 == FILTER_D1_H){
            t3 = 0;
            t2++;
            if (t2 == FILTER_D1_W){
              t2 = 0;
              t1++;
              if (t1 == LAYER_ROW_IL_FACTOR){
                t1 = 0;
                t0++;
                if (t0 == U1_SA_ROWS / U1_DATA1_FC_SPLIT_FACTOR){
                  t0 = 0;
                  done3 = 1;
                }
              }
            }
          }
        }
      }

      in_num_t += LAYER_IN_NUM_T;
      if (in_num_t == LAYER_IN_NUM){
        in_num_t = 0;
        task_iter++;
        if (task_iter == LAYER_TASK_NUM2){
          task_iter = 0;
          done2 = 1;
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataCollect2Head(
  tapa::istream<ap_uint<U1_DATA2_WIDTH * U1_DATA2_FC_SIMD_FACTOR> > &fifo_data_bypass,
  tapa::istream<uint> &fifo_config_bypass,
  tapa::ostream<ap_uint<U1_DATA2_WIDTH * U1_DATA2_FC_SIMD_FACTOR> > &fifo_transfer_out,
  tapa::istream<U1_Data2TransferChannelType> &fifo_transfer_in0,
  tapa::istream<uint> &fifo_config_in
){
#pragma HLS INLINE off
#pragma HLS DATA_PACK variable=fifo_transfer_in0
  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // loader buffer
  ap_uint<U1_DATA2_WIDTH * U1_DATA2_FC_SIMD_FACTOR> cout_buf[COUT_BUFF / U1_DATA2_FC_SIMD_FACTOR];
  #if U1_DataCollect2Head_MEM == 0
    #pragma HLS bind_storage variable=cout_buf type=RAM_T2P impl=BRAM
  #elif U1_DataCollect2Head_MEM == 1
    #pragma HLS bind_storage variable=cout_buf type=RAM_T2P impl=URAM
  #endif
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  while(!done1){
    if (layer_iter > 0){
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
    }
    int task_num = 0;
    ap_uint<10> t3 = 0;
    ap_uint<8> t1 = 0;
    ap_uint<8> t1_bound = LAYER_IN_IMG_H_T*LAYER_TCONV_STRIDE / LAYER_STRIDE;
    ap_uint<7> t0 = 0;
    ap_uint<9> t2 = 0;
    ap_uint<9> t2_bound = LAYER_IN_IMG_W_T*LAYER_TCONV_STRIDE / U1_SA_COLS / LAYER_STRIDE;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
      U1_Data2TransferChannelType fifo_data0 = fifo_transfer_in0.read();
      fifo_transfer_out.write(fifo_data0.data);
      t2++;
      if (t2 == t2_bound){
        t2 = 0;
        t0++;
        if (t0 == U1_SA_COLS / U1_DATA2_FC_SPLIT_FACTOR){
          t0 = 0;
          t1++;
          if (t1 == t1_bound){
            t1 = 0;
            t3++;
            if (t3 == LAYER_OUT_NUM_T / U1_DATA2_FC_SIMD_FACTOR){
              t3 = 0;
              task_num++;
              if (task_num == LAYER_TASK_NUM2){
                task_num = 0;
                done2 = 1;
              }
            }
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }else{
    uint LAYER_IN_NUM_HW = fifo_config_bypass.read();
    uint LAYER_OUT_NUM_HW = fifo_config_bypass.read();
    uint LAYER_IN_H_HW = fifo_config_bypass.read();
    uint LAYER_IN_W_HW = fifo_config_bypass.read();

    uint LAYER_IN_NUM_T = fifo_config_bypass.read();
    uint LAYER_OUT_NUM_T = fifo_config_bypass.read();
    uint LAYER_IN_H_T = fifo_config_bypass.read();
    uint LAYER_IN_W_T = fifo_config_bypass.read();

    uint FILTER_S_H = fifo_config_bypass.read();
    uint FILTER_S_W = fifo_config_bypass.read();
    uint LAYER_STRIDE = fifo_config_bypass.read();
    int in_h_iter = 0;
    int in_w_iter = 0;
    int out_num_iter = 0;
    int in_num_iter = 0;
    bool done1 = 0;
    while(!done1){
      int o = 0;
      int h = 0;
      int w = 0;
      bool done2 = 0;
      while(!done2){
        #pragma HLS PIPELINE II=1
        DepthConvData0Type tmp = fifo_data_bypass.read();
        fifo_transfer_out.write(tmp);
          // Repeat until the whole tile is read
        w++;
        if (w == LAYER_IN_W_T + FILTER_S_W - 1){
          w = 0;
          h++;
          if (h == LAYER_IN_H_T + FILTER_S_H - 1){
            h = 0;
            o++;
            if (o == LAYER_IN_NUM_T / CONV_LANE){
              o = 0;
              done2 = 1;
            }
          }
        }
      }
        // Repeat until all the tiles are read
        // Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
      in_num_iter += LAYER_IN_NUM_T;
      if (in_num_iter >= LAYER_IN_NUM_HW){
        in_num_iter = 0;
        in_w_iter += LAYER_IN_W_T;
        if (in_w_iter >= LAYER_IN_W_HW){
          in_w_iter = 0;
          in_h_iter += LAYER_IN_H_T;
          if (in_h_iter >= LAYER_IN_H_HW){
            in_h_iter = 0;
            done1 = 1;
          }
        }
      }
    }
    // while(!fifo_data_bypass.empty()){
    //   #pragma HLS PIPELINE II=1
    //   fifo_transfer_out.write(fifo_data_bypass.read());
    // }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

/**
 *  This file is automatically generated by PolySA CodeGen.
 *  Version: 1.0
 *  Authos: Jie Wang
 */

//#include "common_header_U1.h"

void U1_Data0FeedData0(
  U1_Data0TransferChannelType buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE/U1_DATA0_FC_SIMD_FACTOR],
  tapa::ostream<U1_Data0PEChannelType> &fifo_feed_0,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  ap_uint<8> LAYER_FILTER_D_H,
  ap_uint<8> LAYER_FILTER_D_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR,
  uint LAYER_DILATION_RATE,
  uint K_NUM,
  ap_uint<32> KH,
  ap_uint<32> KW
){
#pragma HLS INLINE off
  bool more_to_feed_to_sys_arr = true;

  ap_uint<7> c0_counter = 0;
  ap_uint<4> c1_counter = 0;
  ap_uint<7> c2_counter = 0;
  ap_uint<4> c3_counter = 0;
  ap_uint<4> c4_counter = 0;
  ap_uint<6> c5_counter = 0;
  ap_uint<5> i = 0;

  ap_uint<8> c0_counter_bound;
  if (LAYER_STRIDE == 1){
    c0_counter_bound = LAYER_IN_IMG_H_T;
  } else if (LAYER_STRIDE == 2){
    c0_counter_bound = LAYER_IN_IMG_H_T / 2;
  }

  ap_uint<8> K_H[4] = {
    unpack(KH, 0),
    unpack(KH, 1),
    unpack(KH, 2),
    unpack(KH, 3)
  };
  ap_uint<8> K_W[4] = {
    unpack(KW, 0),
    unpack(KW, 1),
    unpack(KW, 2),
    unpack(KW, 3)
  };
  #pragma HLS ARRAY_PARTITION variable=K_H complete
  #pragma HLS ARRAY_PARTITION variable=K_W complete
  ap_uint<U1_DATA0_WIDTH*U1_SIMD_FACTOR> sel_tmp_0[U1_DATA0_FC_SIMD_FACTOR/U1_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=sel_tmp_0 complete dim=1

  while(more_to_feed_to_sys_arr){
#pragma HLS PIPELINE II=1
    ap_uint<21> buffer_ind_to_feed_to_sys_arr;
    ap_uint<21> w_idx, h_idx;
    if (LAYER_STRIDE == 1){
      w_idx = c2_counter + c4_counter*LAYER_DILATION_RATE;
      h_idx = c0_counter + c3_counter*LAYER_DILATION_RATE;
    } else if (LAYER_STRIDE == 2){
      w_idx = c2_counter * 2 + c4_counter;
      h_idx = c0_counter * 2 + c3_counter;
    }
    ap_uint<21> w_bound = LAYER_COL_IL_FACTOR * LAYER_STRIDE + LAYER_FILTER_S_W - LAYER_STRIDE;
    ap_uint<21> h_bound = LAYER_IN_IMG_H_T + LAYER_FILTER_S_H - LAYER_STRIDE;
    #pragma HLS BIND_OP variable=buffer_ind_to_feed_to_sys_arr op=mul impl=fabric latency=1
    buffer_ind_to_feed_to_sys_arr = (w_idx + h_idx * w_bound + c5_counter * U1_SIMD_FACTOR / U1_DATA0_FC_SIMD_FACTOR * h_bound * w_bound) * U1_DATA0_FC_SIMD_FACTOR + c5_counter * U1_SIMD_FACTOR % U1_DATA0_FC_SIMD_FACTOR;

    ap_uint<21> wide_index = buffer_ind_to_feed_to_sys_arr / U1_DATA0_FC_SIMD_FACTOR + (K_W[0]-K_W[i]) + (K_H[0]-K_H[i]) * (LAYER_COL_IL_FACTOR+LAYER_FILTER_S_W-LAYER_STRIDE);
    ap_uint<21> wide_offset = buffer_ind_to_feed_to_sys_arr % U1_DATA0_FC_SIMD_FACTOR;

    U1_Data0TransferChannelType buf_data_0 = buffer[0][wide_index];
    ap_uint<U1_DATA0_WIDTH*U1_DATA0_FC_SIMD_FACTOR> wide_data_0 = buf_data_0.data;
    ap_uint<U1_DATA0_WIDTH*U1_SIMD_FACTOR> data_to_feed_0;
    for (int s = 0; s < U1_DATA0_FC_SIMD_FACTOR / U1_SIMD_FACTOR; s++){
#pragma HLS UNROLL
      sel_tmp_0[s] = wide_data_0(U1_DATA0_WIDTH * U1_SIMD_FACTOR-1, 0);
      wide_data_0 = wide_data_0 >> (U1_DATA0_WIDTH * U1_SIMD_FACTOR);
    }
    data_to_feed_0 = sel_tmp_0[wide_offset / U1_SIMD_FACTOR];

    U1_Data0PEChannelType fifo_data_to_feed_0;
    fifo_data_to_feed_0 = U1_Data0PEChannelType(data_to_feed_0, buf_data_0.new_pair, buf_data_0.last_pair, buf_data_0.FILTER_S);
    fifo_feed_0.write(fifo_data_to_feed_0);

    // counter logic
    c0_counter++;
    if (c0_counter == c0_counter_bound){
      c0_counter = 0;
      c1_counter++;
      if (c1_counter == LAYER_ROW_IL_FACTOR){
        c1_counter = 0;
        c2_counter++;
        if (c2_counter == LAYER_COL_IL_FACTOR){
          c2_counter = 0;
          c3_counter++;
          if (c3_counter == K_H[i]){
            c3_counter = 0;
            c4_counter++;
            if (c4_counter == K_W[i]){
              c4_counter = 0;
              c5_counter++;
              if (c5_counter == LAYER_IN_NUM_T / U1_SIMD_FACTOR){
                c5_counter = 0;
                i++;
                if (i == K_NUM){
                  i = 0;
                  more_to_feed_to_sys_arr = false;
                }
              }
            }
          }
        }
      }
    }
  }
}

void U1_Data1FeedData0(
  U1_Data1TransferChannelType buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE/U1_DATA1_FC_SIMD_FACTOR],
  tapa::ostream<U1_Data1PEChannelType> &fifo_feed_0,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR,
  uint K_NUM,
  ap_uint<32> KH,
  ap_uint<32> KW
){
#pragma HLS INLINE off
  bool more_to_feed_to_sys_arr = true;

  ap_uint<7> c0_counter = 0;
  ap_uint<4> c1_counter = 0;
  ap_uint<7> c2_counter = 0;
  ap_uint<4> c3_counter = 0;
  ap_uint<4> c4_counter = 0;
  ap_uint<6> c5_counter = 0;
  ap_uint<5> i = 0;

  ap_uint<8> c0_counter_bound;
  ap_uint<6> offsets[4] = {0};
  #pragma HLS ARRAY_PARTITION variable=offsets complete
  if(K_NUM==4){
    offsets[0] = 0*LAYER_FILTER_S_H + 0                                  ;
    offsets[1] = 0*LAYER_FILTER_S_H + 0                   + unpack(KW,0) ;
    offsets[2] = unpack(KH,0)*LAYER_FILTER_S_H + 0                       ;
    offsets[3] = unpack(KH,0)*LAYER_FILTER_S_H + 0        + unpack(KW,2) ;
  }
  ap_uint<8> K_H[4] = {
    unpack(KH, 0),
    unpack(KH, 1),
    unpack(KH, 2),
    unpack(KH, 3)
  };
  ap_uint<8> K_W[4] = {
    unpack(KW, 0),
    unpack(KW, 1),
    unpack(KW, 2),
    unpack(KW, 3)
  };
  #pragma HLS ARRAY_PARTITION variable=K_H complete
  #pragma HLS ARRAY_PARTITION variable=K_W complete
    if (LAYER_STRIDE == 1){
    c0_counter_bound = LAYER_IN_IMG_H_T;
  } else if (LAYER_STRIDE == 2){
    c0_counter_bound = LAYER_IN_IMG_H_T / 2;
  }

  ap_uint<U1_DATA1_WIDTH*U1_SIMD_FACTOR> sel_tmp_0[U1_DATA1_FC_SIMD_FACTOR/U1_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=sel_tmp_0 complete dim=1

  while(more_to_feed_to_sys_arr){
#pragma HLS PIPELINE II=1
    ap_uint<17> buffer_ind_to_feed_to_sys_arr;
    buffer_ind_to_feed_to_sys_arr = c1_counter * LAYER_FILTER_S_H * LAYER_FILTER_S_W * LAYER_IN_NUM_T + c3_counter * LAYER_FILTER_S_W * LAYER_IN_NUM_T + (c4_counter+offsets[i]) * LAYER_IN_NUM_T + c5_counter * U1_SIMD_FACTOR;
    ap_uint<17> wide_index = buffer_ind_to_feed_to_sys_arr / U1_DATA1_FC_SIMD_FACTOR;
    ap_uint<17> wide_offset = buffer_ind_to_feed_to_sys_arr % U1_DATA1_FC_SIMD_FACTOR;

    U1_Data1TransferChannelType buf_data_0 = buffer[0][wide_index];
    ap_uint<U1_DATA1_WIDTH*U1_DATA1_FC_SIMD_FACTOR> wide_data_0 = buf_data_0.data;
    ap_uint<U1_DATA1_WIDTH*U1_SIMD_FACTOR> data_to_feed_0;
    for (int s = 0; s < U1_DATA1_FC_SIMD_FACTOR/U1_SIMD_FACTOR; s++){
#pragma HLS UNROLL
      sel_tmp_0[s] = wide_data_0(U1_DATA1_WIDTH * U1_SIMD_FACTOR-1, 0);
      wide_data_0 = wide_data_0 >> (U1_DATA1_WIDTH * U1_SIMD_FACTOR);
    }
    data_to_feed_0 = sel_tmp_0[wide_offset / U1_SIMD_FACTOR];

    U1_Data1PEChannelType fifo_data_to_feed_0;
    fifo_data_to_feed_0 = U1_Data1PEChannelType(data_to_feed_0, buf_data_0.new_pair, buf_data_0.last_pair, buf_data_0.FILTER_S);
    fifo_feed_0.write(fifo_data_to_feed_0);

    // counter logic
    c0_counter++;
    if (c0_counter == c0_counter_bound){
      c0_counter = 0;
      c1_counter++;
      if (c1_counter == LAYER_ROW_IL_FACTOR){
        c1_counter = 0;
        c2_counter++;
        if (c2_counter == LAYER_COL_IL_FACTOR){
          c2_counter = 0;
          c3_counter++;
          if (c3_counter == K_H[i]){
            c3_counter = 0;
            c4_counter++;
            if (c4_counter == K_W[i]){
              c4_counter = 0;
              c5_counter++;
              if (c5_counter == LAYER_IN_NUM_T / U1_SIMD_FACTOR){
                c5_counter = 0;
                i++;
                if (i == K_NUM){
                  i = 0;
                more_to_feed_to_sys_arr = false;
                }
              }
            }
          }
        }
      }
    }
  }
}

void U1_Data0ReadData0(
  U1_Data0TransferChannelType buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR],
  tapa::istream<U1_Data0TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data0TransferChannelType> &fifo_transfer_out,
  unsigned int engine_id,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR
){
#pragma HLS INLINE off
  bool LAST_ENGINE = (engine_id == 9 / U1_DATA0_FC_SPLIT_FACTOR - 1);
  ap_uint<21> transfer_counter = 0;
  ap_uint<21> data0_buf_size;
  ap_uint<21> local_transfer_size;
  bool more_to_write_to_buffer = true;
  bool more_to_feed_to_sys_arr = false;
  bool more_to_forward = true;
  ap_uint<18> buffer_write_counter = 0;
  ap_uint<3> buffer_gs_id = 0;

  // the first read
  #pragma HLS BIND_OP variable=data0_buf_size op=mul impl=fabric latency=1
  #pragma HLS BIND_OP variable=local_transfer_size op=mul impl=fabric latency=1
  data0_buf_size = LAYER_IN_NUM_T * (LAYER_IN_IMG_H_T + LAYER_FILTER_S_H - LAYER_STRIDE) * (LAYER_COL_IL_FACTOR * LAYER_STRIDE + LAYER_FILTER_S_W - LAYER_STRIDE) / U1_DATA0_FC_SIMD_FACTOR;
  local_transfer_size = data0_buf_size * (9 / U1_DATA0_FC_SPLIT_FACTOR - engine_id) * U1_DATA0_FC_GROUP_FACTOR;

  while(more_to_forward){
#pragma HLS PIPELINE II=1
    U1_Data0TransferChannelType data_read_from_fifo = fifo_transfer_in.read();
    bool data_is_to_buffer;
    bool data_is_to_forward;
    unsigned int feeder_id = data_read_from_fifo.feeder_id;
    data_is_to_buffer = LAST_ENGINE || (!LAST_ENGINE && feeder_id == engine_id);
    data_is_to_forward = !LAST_ENGINE && (feeder_id != engine_id);
    if (!LAST_ENGINE){
      if (data_is_to_forward){
        fifo_transfer_out.write(data_read_from_fifo);
      }
    }
    ap_uint<18> buffer_ind_to_write_to_buffer = buffer_write_counter;

    if (data_is_to_buffer){
      buffer[buffer_gs_id][buffer_ind_to_write_to_buffer] = data_read_from_fifo;
      buffer_write_counter++;
      if (buffer_write_counter == data0_buf_size){
        buffer_write_counter = 0;
        buffer_gs_id++;
        if (buffer_gs_id == U1_DATA0_FC_GROUP_FACTOR){
          buffer_gs_id = 0;
          more_to_write_to_buffer = false;
        }
      }
    }
    transfer_counter++;
    if (transfer_counter == local_transfer_size){
      transfer_counter = 0;
      more_to_forward = false;
    }
  }

}

void U1_Data0ReadDataLast(
  U1_Data0TransferChannelType buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR],
  tapa::istream<U1_Data0TransferChannelType> &fifo_transfer_in,
  unsigned int engine_id,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR
){
#pragma HLS INLINE off
  bool LAST_ENGINE = (engine_id == 9 / U1_DATA0_FC_SPLIT_FACTOR - 1);
  bool buffer_id_to_write_to_buffer = 0;
  bool buffer_id_to_feed_to_sys_arr = 1;
  ap_uint<21> transfer_counter = 0;
  ap_uint<21> data0_buf_size;
  ap_uint<21> local_transfer_size;
  bool more_to_write_to_buffer = true;
  bool more_to_feed_to_sys_arr = false;
  bool more_to_forward = true;
  ap_uint<18> buffer_write_counter = 0;
  ap_uint<3> buffer_gs_id = 0;

  // the first read
  #pragma HLS BIND_OP variable=data0_buf_size op=mul impl=fabric latency=1
  #pragma HLS BIND_OP variable=local_transfer_size op=mul impl=fabric latency=1
  data0_buf_size = LAYER_IN_NUM_T * (LAYER_IN_IMG_H_T + LAYER_FILTER_S_H - LAYER_STRIDE) * (LAYER_COL_IL_FACTOR * LAYER_STRIDE + LAYER_FILTER_S_W - LAYER_STRIDE) / U1_DATA0_FC_SIMD_FACTOR;
  local_transfer_size = data0_buf_size * (9 / U1_DATA0_FC_SPLIT_FACTOR - engine_id) * U1_DATA0_FC_GROUP_FACTOR;

  while(more_to_forward){
#pragma HLS PIPELINE II=1
    U1_Data0TransferChannelType data_read_from_fifo = fifo_transfer_in.read();
    bool data_is_to_buffer;
    bool data_is_to_forward;
    unsigned int feeder_id = data_read_from_fifo.feeder_id;
    data_is_to_buffer = LAST_ENGINE || (!LAST_ENGINE && feeder_id == engine_id);
    data_is_to_forward = !LAST_ENGINE && (feeder_id != engine_id);
    ap_uint<18> buffer_ind_to_write_to_buffer = buffer_write_counter;

    if (data_is_to_buffer){
      buffer[buffer_gs_id][buffer_ind_to_write_to_buffer] = data_read_from_fifo;
      buffer_write_counter++;
      if (buffer_write_counter == data0_buf_size){
        buffer_write_counter = 0;
        buffer_gs_id++;
        if (buffer_gs_id == U1_DATA0_FC_GROUP_FACTOR){
          buffer_gs_id = 0;
          more_to_write_to_buffer = false;
        }
      }
    }
    transfer_counter++;
    if (transfer_counter == local_transfer_size){
      transfer_counter = 0;
      more_to_forward = false;
    }
  }

}

void U1_Data1ReadData0(
  U1_Data1TransferChannelType buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR],
  tapa::istream<U1_Data1TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data1TransferChannelType> &fifo_transfer_out,
  unsigned int engine_id,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR
){
#pragma HLS INLINE off
  bool LAST_ENGINE = (engine_id == 8 / U1_DATA1_FC_SPLIT_FACTOR - 1);
  ap_uint<17> transfer_counter = 0;
  ap_uint<17> data1_buf_size;
  ap_uint<17> local_transfer_size;
  bool more_to_write_to_buffer = true;
  bool more_to_feed_to_sys_arr = false;
  bool more_to_forward = true;
  ap_uint<14> buffer_write_counter = 0;
  ap_uint<3> buffer_gs_id = 0;

  // the first read
  #pragma HLS BIND_OP variable=data1_buf_size op=mul impl=fabric latency=1
  #pragma HLS BIND_OP variable=local_transfer_size op=mul impl=fabric latency=1
  data1_buf_size = LAYER_IN_NUM_T * LAYER_ROW_IL_FACTOR * LAYER_FILTER_S_H * LAYER_FILTER_S_W / U1_DATA1_FC_SIMD_FACTOR;
  local_transfer_size = data1_buf_size * (8 / U1_DATA1_FC_SPLIT_FACTOR - engine_id) * U1_DATA1_FC_GROUP_FACTOR;

  while(more_to_forward){
#pragma HLS PIPELINE II=1
    U1_Data1TransferChannelType data_read_from_fifo = fifo_transfer_in.read();
    bool data_is_to_buffer;
    bool data_is_to_forward;
    unsigned int feeder_id = data_read_from_fifo.feeder_id;
    data_is_to_buffer = LAST_ENGINE || (!LAST_ENGINE && feeder_id == engine_id);
    data_is_to_forward = !LAST_ENGINE && (feeder_id != engine_id);
    if (!LAST_ENGINE){
      if (data_is_to_forward){
        fifo_transfer_out.write(data_read_from_fifo);
      }
    }
    ap_uint<14> buffer_ind_to_write_to_buffer = buffer_write_counter;

    if (data_is_to_buffer){
      buffer[buffer_gs_id][buffer_ind_to_write_to_buffer] = data_read_from_fifo;
      buffer_write_counter++;
      if (buffer_write_counter == data1_buf_size){
        buffer_write_counter = 0;
        buffer_gs_id++;
        if (buffer_gs_id == U1_DATA1_FC_GROUP_FACTOR){
          buffer_gs_id = 0;
          more_to_write_to_buffer = false;
        }
      }
    }
    transfer_counter++;
    if (transfer_counter == local_transfer_size){
      transfer_counter = 0;
      more_to_forward = false;
    }
  }

}

void U1_Data1ReadDataLast(
  U1_Data1TransferChannelType buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR],
  tapa::istream<U1_Data1TransferChannelType> &fifo_transfer_in,
  unsigned int engine_id,
  uint LAYER_IN_NUM_T,
  uint LAYER_IN_IMG_H_T,
  ap_uint<8> LAYER_FILTER_S_H,
  ap_uint<8> LAYER_FILTER_S_W,
  uint LAYER_STRIDE,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR
){
#pragma HLS INLINE off
  bool LAST_ENGINE = (engine_id == 8 / U1_DATA1_FC_SPLIT_FACTOR - 1);
  bool buffer_id_to_write_to_buffer = 0;
  bool buffer_id_to_feed_to_sys_arr = 1;
  ap_uint<17> transfer_counter = 0;
  ap_uint<17> data1_buf_size;
  ap_uint<17> local_transfer_size;
  bool more_to_write_to_buffer = true;
  bool more_to_feed_to_sys_arr = false;
  bool more_to_forward = true;
  ap_uint<14> buffer_write_counter = 0;
  ap_uint<3> buffer_gs_id = 0;

  // the first read
  #pragma HLS BIND_OP variable=data1_buf_size op=mul impl=fabric latency=1
  #pragma HLS BIND_OP variable=local_transfer_size op=mul impl=fabric latency=1
  data1_buf_size = LAYER_IN_NUM_T * LAYER_ROW_IL_FACTOR * LAYER_FILTER_S_H * LAYER_FILTER_S_W / U1_DATA1_FC_SIMD_FACTOR;
  local_transfer_size = data1_buf_size * (8 / U1_DATA1_FC_SPLIT_FACTOR - engine_id) * U1_DATA1_FC_GROUP_FACTOR;

  while(more_to_forward){
#pragma HLS PIPELINE II=1
    U1_Data1TransferChannelType data_read_from_fifo = fifo_transfer_in.read();
    bool data_is_to_buffer;
    bool data_is_to_forward;
    unsigned int feeder_id = data_read_from_fifo.feeder_id;
    data_is_to_buffer = LAST_ENGINE || (!LAST_ENGINE && feeder_id == engine_id);
    data_is_to_forward = !LAST_ENGINE && (feeder_id != engine_id);
    ap_uint<14> buffer_ind_to_write_to_buffer = buffer_write_counter;

    if (data_is_to_buffer){
      buffer[buffer_gs_id][buffer_ind_to_write_to_buffer] = data_read_from_fifo;
      buffer_write_counter++;
      if (buffer_write_counter == data1_buf_size){
        buffer_write_counter = 0;
        buffer_gs_id++;
        if (buffer_gs_id == U1_DATA1_FC_GROUP_FACTOR){
          buffer_gs_id = 0;
          more_to_write_to_buffer = false;
        }
      }
    }
    transfer_counter++;
    if (transfer_counter == local_transfer_size){
      transfer_counter = 0;
      more_to_forward = false;
    }
  }

}

void U1_DataFeed0Engine0(
  tapa::istream<U1_Data0TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data0TransferChannelType> &fifo_transfer_out,
  tapa::ostream<U1_Data0PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out0,
  tapa::ostream<uint> &fifo_config_out1
){
#pragma HLS DATA_PACK variable=fifo_transfer_in
#pragma HLS DATA_PACK variable=fifo_transfer_out
#pragma HLS DATA_PACK variable=fifo_feed_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out0.write(inst_count);
  fifo_config_out1.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out0.write(CONV_EN);
  fifo_config_out1.write(CONV_EN);
  if(CONV_EN){
  uint task_iter = 0;
  uint LAYER_IN_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint FILTER_D0_H_prev;
  uint FILTER_D0_W_prev;
  uint FILTER_D1_H_prev;
  uint FILTER_D1_W_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_ROW_IL_FACTOR_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint dummy;
  uint LAYER_DILATION_RATE_prev;
  uint K_NUM_prev;
  ap_uint<32> KH_prev;
  ap_uint<32> KW_prev;

  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out0.write(LAYER_IN_NUM_T);
  fifo_config_out0.write(LAYER_OUT_NUM_T);
  fifo_config_out0.write(LAYER_IN_IMG_H_T);
  fifo_config_out0.write(LAYER_IN_IMG_W_T);
  fifo_config_out0.write(LAYER_FILTER_S_H);
  fifo_config_out0.write(LAYER_FILTER_S_W);
  fifo_config_out0.write(LAYER_TASK_NUM1);
  fifo_config_out0.write(LAYER_TASK_NUM2);
  fifo_config_out0.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out0.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out0.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out0.write(LAYER_COL_IL_FACTOR);
  fifo_config_out0.write(LAYER_STRIDE);
  fifo_config_out0.write(LAYER_BATCH);

  fifo_config_out0.write(LAYER_CONV_TYPE);
  fifo_config_out0.write(FILTER_D0_H);
  fifo_config_out0.write(FILTER_D0_W);
  fifo_config_out0.write(FILTER_D1_H);	
  fifo_config_out0.write(FILTER_D1_W);	
  fifo_config_out0.write(LAYER_DILATION_RATE);
  fifo_config_out0.write(LAYER_TCONV_STRIDE);
  fifo_config_out0.write(K_NUM);
  fifo_config_out0.write(KH);
  fifo_config_out0.write(KW);
  fifo_config_out1.write(LAYER_IN_NUM_T);
  fifo_config_out1.write(LAYER_OUT_NUM_T);
  fifo_config_out1.write(LAYER_IN_IMG_H_T);
  fifo_config_out1.write(LAYER_IN_IMG_W_T);
  fifo_config_out1.write(LAYER_FILTER_S_H);
  fifo_config_out1.write(LAYER_FILTER_S_W);
  fifo_config_out1.write(LAYER_TASK_NUM1);
  fifo_config_out1.write(LAYER_TASK_NUM2);
  fifo_config_out1.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out1.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out1.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out1.write(LAYER_COL_IL_FACTOR);
  fifo_config_out1.write(LAYER_STRIDE);
  fifo_config_out1.write(LAYER_BATCH);

  fifo_config_out1.write(LAYER_CONV_TYPE);
  fifo_config_out1.write(FILTER_D0_H);
  fifo_config_out1.write(FILTER_D0_W);
  fifo_config_out1.write(FILTER_D1_H);	
  fifo_config_out1.write(FILTER_D1_W);	
  fifo_config_out1.write(LAYER_DILATION_RATE);
  fifo_config_out1.write(LAYER_TCONV_STRIDE);
  fifo_config_out1.write(K_NUM);
  fifo_config_out1.write(KH);
  fifo_config_out1.write(KW);
  U1_Data0TransferChannelType ping_buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR];
  U1_Data0TransferChannelType pong_buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR];
  #if U1_DataFeed0Engine0_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataFeed0Engine0_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
  #pragma HLS DATA_PACK variable=ping_buffer
  #pragma HLS DATA_PACK variable=pong_buffer
  #pragma HLS ARRAY_PARTITION variable=ping_buffer dim=1 complete
  #pragma HLS ARRAY_PARTITION variable=pong_buffer dim=1 complete

  unsigned int initial_round = 0;

  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      dummy = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out0.write(LAYER_IN_NUM_T);
      fifo_config_out0.write(LAYER_OUT_NUM_T);
      fifo_config_out0.write(LAYER_IN_IMG_H_T);
      fifo_config_out0.write(LAYER_IN_IMG_W_T);
      fifo_config_out0.write(LAYER_FILTER_S_H);
      fifo_config_out0.write(LAYER_FILTER_S_W);
      fifo_config_out0.write(LAYER_TASK_NUM1);
      fifo_config_out0.write(LAYER_TASK_NUM2);
      fifo_config_out0.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out0.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out0.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out0.write(LAYER_COL_IL_FACTOR);
      fifo_config_out0.write(LAYER_STRIDE);
      fifo_config_out0.write(LAYER_BATCH);

      fifo_config_out0.write(LAYER_CONV_TYPE);
      fifo_config_out0.write(FILTER_D0_H);
      fifo_config_out0.write(FILTER_D0_W);
      fifo_config_out0.write(FILTER_D1_H);	
      fifo_config_out0.write(FILTER_D1_W);	
      fifo_config_out0.write(LAYER_DILATION_RATE);
      fifo_config_out0.write(LAYER_TCONV_STRIDE);
      fifo_config_out0.write(K_NUM);
      fifo_config_out0.write(KH);
      fifo_config_out0.write(KW);
      fifo_config_out1.write(LAYER_IN_NUM_T);
      fifo_config_out1.write(LAYER_OUT_NUM_T);
      fifo_config_out1.write(LAYER_IN_IMG_H_T);
      fifo_config_out1.write(LAYER_IN_IMG_W_T);
      fifo_config_out1.write(LAYER_FILTER_S_H);
      fifo_config_out1.write(LAYER_FILTER_S_W);
      fifo_config_out1.write(LAYER_TASK_NUM1);
      fifo_config_out1.write(LAYER_TASK_NUM2);
      fifo_config_out1.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out1.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out1.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out1.write(LAYER_COL_IL_FACTOR);
      fifo_config_out1.write(LAYER_STRIDE);
      fifo_config_out1.write(LAYER_BATCH);

      fifo_config_out1.write(LAYER_CONV_TYPE);
      fifo_config_out1.write(FILTER_D0_H);
      fifo_config_out1.write(FILTER_D0_W);
      fifo_config_out1.write(FILTER_D1_H);	
      fifo_config_out1.write(FILTER_D1_W);	
      fifo_config_out1.write(LAYER_DILATION_RATE);
      fifo_config_out1.write(LAYER_TCONV_STRIDE);
      fifo_config_out1.write(K_NUM);
      fifo_config_out1.write(KH);
      fifo_config_out1.write(KW);
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data0ReadData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
    } else {
      if (initial_round % 2 == 1){
        U1_Data0ReadData0(pong_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data0FeedData0(
          ping_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D0_H_prev,
          FILTER_D0_W_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          LAYER_DILATION_RATE_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      } else {
        U1_Data0ReadData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data0FeedData0(
          pong_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D0_H_prev,
          FILTER_D0_W_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          LAYER_DILATION_RATE_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      }
    }

    initial_round++;
    LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    FILTER_D0_H_prev = FILTER_D0_H;
    FILTER_D0_W_prev = FILTER_D0_W;
    FILTER_D1_H_prev = FILTER_D1_H;
    FILTER_D1_W_prev = FILTER_D1_W;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_ROW_IL_FACTOR_prev = LAYER_ROW_IL_FACTOR;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    LAYER_DILATION_RATE_prev = LAYER_DILATION_RATE;
    K_NUM_prev = K_NUM;
    KH_prev = KH;
    KW_prev = KW;
    task_iter++;
    if (task_iter == LAYER_TASK_NUM1){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data0FeedData0(
      ping_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D0_H_prev,
      FILTER_D0_W_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      LAYER_DILATION_RATE_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  } else {
    U1_Data0FeedData0(
      pong_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D0_H_prev,
      FILTER_D0_W_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      LAYER_DILATION_RATE_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataFeed0Engine0_wrapper(
  tapa::istream<U1_Data0TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data0TransferChannelType> &fifo_transfer_out,
  tapa::ostream<U1_Data0PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out0,
  tapa::ostream<uint> &fifo_config_out1
){
  U1_DataFeed0Engine0(
    fifo_transfer_in,
    fifo_transfer_out, 
    fifo_feed_0,
    engine_id,
    fifo_config_in,
    fifo_config_out0,
    fifo_config_out1
  );
}

void U1_DataFeed0EngineLast(
  tapa::istream<U1_Data0TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data0PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out1
){
#pragma HLS DATA_PACK variable=fifo_transfer_in
#pragma HLS DATA_PACK variable=fifo_feed_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out1.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out1.write(CONV_EN);
  if(CONV_EN){
  uint task_iter = 0;
  uint LAYER_IN_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint FILTER_D0_H_prev;
  uint FILTER_D0_W_prev;
  uint FILTER_D1_H_prev;
  uint FILTER_D1_W_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_ROW_IL_FACTOR_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint dummy;
  uint LAYER_DILATION_RATE_prev;
  uint K_NUM_prev;
  ap_uint<32> KH_prev;
  ap_uint<32> KW_prev;

  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out1.write(LAYER_IN_NUM_T);
  fifo_config_out1.write(LAYER_OUT_NUM_T);
  fifo_config_out1.write(LAYER_IN_IMG_H_T);
  fifo_config_out1.write(LAYER_IN_IMG_W_T);
  fifo_config_out1.write(LAYER_FILTER_S_H);
  fifo_config_out1.write(LAYER_FILTER_S_W);
  fifo_config_out1.write(LAYER_TASK_NUM1);
  fifo_config_out1.write(LAYER_TASK_NUM2);
  fifo_config_out1.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out1.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out1.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out1.write(LAYER_COL_IL_FACTOR);
  fifo_config_out1.write(LAYER_STRIDE);
  fifo_config_out1.write(LAYER_BATCH);

  fifo_config_out1.write(LAYER_CONV_TYPE);
  fifo_config_out1.write(FILTER_D0_H);
  fifo_config_out1.write(FILTER_D0_W);
  fifo_config_out1.write(FILTER_D1_H);	
  fifo_config_out1.write(FILTER_D1_W);	
  fifo_config_out1.write(LAYER_DILATION_RATE);
  fifo_config_out1.write(LAYER_TCONV_STRIDE);
  fifo_config_out1.write(K_NUM);
  fifo_config_out1.write(KH);
  fifo_config_out1.write(KW);
  U1_Data0TransferChannelType ping_buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR];
  U1_Data0TransferChannelType pong_buffer[U1_DATA0_FC_GROUP_FACTOR][U1_DATA0_BUF_SIZE / U1_DATA0_FC_SIMD_FACTOR];
  #if U1_DataFeed0EngineLast_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataFeed0EngineLast_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
#pragma HLS DATA_PACK variable=ping_buffer
#pragma HLS DATA_PACK variable=pong_buffer
#pragma HLS ARRAY_PARTITION variable=ping_buffer dim=1 complete
#pragma HLS ARRAY_PARTITION variable=pong_buffer dim=1 complete

  unsigned int initial_round = 0;

  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      dummy = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out1.write(LAYER_IN_NUM_T);
      fifo_config_out1.write(LAYER_OUT_NUM_T);
      fifo_config_out1.write(LAYER_IN_IMG_H_T);
      fifo_config_out1.write(LAYER_IN_IMG_W_T);
      fifo_config_out1.write(LAYER_FILTER_S_H);
      fifo_config_out1.write(LAYER_FILTER_S_W);
      fifo_config_out1.write(LAYER_TASK_NUM1);
      fifo_config_out1.write(LAYER_TASK_NUM2);
      fifo_config_out1.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out1.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out1.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out1.write(LAYER_COL_IL_FACTOR);
      fifo_config_out1.write(LAYER_STRIDE);
      fifo_config_out1.write(LAYER_BATCH);

      fifo_config_out1.write(LAYER_CONV_TYPE);
      fifo_config_out1.write(FILTER_D0_H);
      fifo_config_out1.write(FILTER_D0_W);
      fifo_config_out1.write(FILTER_D1_H);	
      fifo_config_out1.write(FILTER_D1_W);	
      fifo_config_out1.write(LAYER_DILATION_RATE);
      fifo_config_out1.write(LAYER_TCONV_STRIDE);
      fifo_config_out1.write(K_NUM);
      fifo_config_out1.write(KH);
      fifo_config_out1.write(KW);
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data0ReadDataLast(ping_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
    } else {
      if (initial_round % 2 == 1){
        U1_Data0ReadDataLast(pong_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data0FeedData0(
          ping_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D0_H_prev,
          FILTER_D0_W_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          LAYER_DILATION_RATE_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      } else {
        U1_Data0ReadDataLast(ping_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D0_H, FILTER_D0_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data0FeedData0(
          pong_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D0_H_prev,
          FILTER_D0_W_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          LAYER_DILATION_RATE_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      }
    }

    initial_round++;
    LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    FILTER_D0_H_prev = FILTER_D0_H;
    FILTER_D0_W_prev = FILTER_D0_W;
    FILTER_D1_H_prev = FILTER_D1_H;
    FILTER_D1_W_prev = FILTER_D1_W;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_ROW_IL_FACTOR_prev = LAYER_ROW_IL_FACTOR;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    LAYER_DILATION_RATE_prev = LAYER_DILATION_RATE;
    K_NUM_prev = K_NUM;
    KH_prev = KH;
    KW_prev = KW;
    task_iter++;
    if (task_iter == LAYER_TASK_NUM1){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data0FeedData0(
      ping_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D0_H_prev,
      FILTER_D0_W_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      LAYER_DILATION_RATE_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  } else {
    U1_Data0FeedData0(
      pong_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D0_H_prev,
      FILTER_D0_W_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      LAYER_DILATION_RATE_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataFeed1Engine0(
  tapa::istream<U1_Data1TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data1TransferChannelType> &fifo_transfer_out,
  tapa::ostream<U1_Data1PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out0
){
#pragma HLS DATA_PACK variable=fifo_transfer_in
#pragma HLS DATA_PACK variable=fifo_transfer_out
#pragma HLS DATA_PACK variable=fifo_feed_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out0.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out0.write(CONV_EN);
  if(CONV_EN){
  uint task_iter = 0;
  uint LAYER_IN_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint FILTER_D1_H_prev;
  uint FILTER_D1_W_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_ROW_IL_FACTOR_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint dummy;
  uint K_NUM_prev;
  ap_uint<32> KH_prev;
  ap_uint<32> KW_prev;

  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out0.write(LAYER_IN_NUM_T);
  fifo_config_out0.write(LAYER_OUT_NUM_T);
  fifo_config_out0.write(LAYER_IN_IMG_H_T);
  fifo_config_out0.write(LAYER_IN_IMG_W_T);
  fifo_config_out0.write(LAYER_FILTER_S_H);
  fifo_config_out0.write(LAYER_FILTER_S_W);
  fifo_config_out0.write(LAYER_TASK_NUM1);
  fifo_config_out0.write(LAYER_TASK_NUM2);
  fifo_config_out0.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out0.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out0.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out0.write(LAYER_COL_IL_FACTOR);
  fifo_config_out0.write(LAYER_STRIDE);
  fifo_config_out0.write(LAYER_BATCH);

  fifo_config_out0.write(LAYER_CONV_TYPE);
  fifo_config_out0.write(FILTER_D0_H);
  fifo_config_out0.write(FILTER_D0_W);
  fifo_config_out0.write(FILTER_D1_H);	
  fifo_config_out0.write(FILTER_D1_W);	
  fifo_config_out0.write(LAYER_DILATION_RATE);
  fifo_config_out0.write(LAYER_TCONV_STRIDE);
  fifo_config_out0.write(K_NUM);
  fifo_config_out0.write(KH);
  fifo_config_out0.write(KW);
  U1_Data1TransferChannelType ping_buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR];
  U1_Data1TransferChannelType pong_buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR];
  #if U1_DataFeed1Engine0_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataFeed1Engine0_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
  #pragma HLS DATA_PACK variable=ping_buffer
  #pragma HLS DATA_PACK variable=pong_buffer
  #pragma HLS ARRAY_PARTITION variable=ping_buffer dim=1 complete
  #pragma HLS ARRAY_PARTITION variable=pong_buffer dim=1 complete

  unsigned int initial_round = 0;

  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      dummy = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out0.write(LAYER_IN_NUM_T);
      fifo_config_out0.write(LAYER_OUT_NUM_T);
      fifo_config_out0.write(LAYER_IN_IMG_H_T);
      fifo_config_out0.write(LAYER_IN_IMG_W_T);
      fifo_config_out0.write(LAYER_FILTER_S_H);
      fifo_config_out0.write(LAYER_FILTER_S_W);
      fifo_config_out0.write(LAYER_TASK_NUM1);
      fifo_config_out0.write(LAYER_TASK_NUM2);
      fifo_config_out0.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out0.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out0.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out0.write(LAYER_COL_IL_FACTOR);
      fifo_config_out0.write(LAYER_STRIDE);
      fifo_config_out0.write(LAYER_BATCH);

      fifo_config_out0.write(LAYER_CONV_TYPE);
      fifo_config_out0.write(FILTER_D0_H);
      fifo_config_out0.write(FILTER_D0_W);
      fifo_config_out0.write(FILTER_D1_H);	
      fifo_config_out0.write(FILTER_D1_W);	
      fifo_config_out0.write(LAYER_DILATION_RATE);
      fifo_config_out0.write(LAYER_TCONV_STRIDE);
      fifo_config_out0.write(K_NUM);
      fifo_config_out0.write(KH);
      fifo_config_out0.write(KW);
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data1ReadData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
    } else {
      if (initial_round % 2 == 1){
        U1_Data1ReadData0(pong_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data1FeedData0(
          ping_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      } else {
        U1_Data1ReadData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data1FeedData0(
          pong_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      }
    }

    initial_round++;
    LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    FILTER_D1_H_prev = FILTER_D1_H;
    FILTER_D1_W_prev = FILTER_D1_W;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_ROW_IL_FACTOR_prev = LAYER_ROW_IL_FACTOR;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    K_NUM_prev = K_NUM;
    KH_prev = KH;
    KW_prev = KW;
    task_iter++;
    if (task_iter == LAYER_TASK_NUM1){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data1FeedData0(
      ping_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  } else {
    U1_Data1FeedData0(
      pong_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataFeed1Engine0_wrapper(
  tapa::istream<U1_Data1TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data1TransferChannelType> &fifo_transfer_out,
  tapa::ostream<U1_Data1PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out0
){
  U1_DataFeed1Engine0(
    fifo_transfer_in,
    fifo_transfer_out, 
    fifo_feed_0,
    engine_id,
    fifo_config_in,
    fifo_config_out0
  );
}

void U1_DataFeed1EngineLast(
  tapa::istream<U1_Data1TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data1PEChannelType> &fifo_feed_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in
){
#pragma HLS DATA_PACK variable=fifo_transfer_in
#pragma HLS DATA_PACK variable=fifo_feed_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  if(CONV_EN){
  uint task_iter = 0;
  uint LAYER_IN_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint FILTER_D1_H_prev;
  uint FILTER_D1_W_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_ROW_IL_FACTOR_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint dummy;
  uint K_NUM_prev;
  ap_uint<32> KH_prev;
  ap_uint<32> KW_prev;

  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  U1_Data1TransferChannelType ping_buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR];
  U1_Data1TransferChannelType pong_buffer[U1_DATA1_FC_GROUP_FACTOR][U1_DATA1_BUF_SIZE / U1_DATA1_FC_SIMD_FACTOR];
  #if U1_DataFeed1EngineLast_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataFeed1EngineLast_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
#pragma HLS DATA_PACK variable=ping_buffer
#pragma HLS DATA_PACK variable=pong_buffer
#pragma HLS ARRAY_PARTITION variable=ping_buffer dim=1 complete
#pragma HLS ARRAY_PARTITION variable=pong_buffer dim=1 complete

  unsigned int initial_round = 0;

  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      dummy = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data1ReadDataLast(ping_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
    } else {
      if (initial_round % 2 == 1){
        U1_Data1ReadDataLast(pong_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data1FeedData0(
          ping_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      } else {
        U1_Data1ReadDataLast(ping_buffer, fifo_transfer_in, engine_id, LAYER_IN_NUM_T, LAYER_IN_IMG_H_T, FILTER_D1_H, FILTER_D1_W, LAYER_STRIDE, LAYER_ROW_IL_FACTOR, LAYER_COL_IL_FACTOR);
        U1_Data1FeedData0(
          pong_buffer,
          fifo_feed_0,
          LAYER_IN_NUM_T_prev,
          LAYER_IN_IMG_H_T_prev,
          FILTER_D1_H_prev,
          FILTER_D1_W_prev,
          LAYER_STRIDE_prev,
          LAYER_ROW_IL_FACTOR_prev,
          LAYER_COL_IL_FACTOR_prev,
          K_NUM_prev,
          KH_prev,
          KW_prev);
      }
    }

    initial_round++;
    LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    FILTER_D1_H_prev = FILTER_D1_H;
    FILTER_D1_W_prev = FILTER_D1_W;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_ROW_IL_FACTOR_prev = LAYER_ROW_IL_FACTOR;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    K_NUM_prev = K_NUM;
    KH_prev = KH;
    KW_prev = KW;
    task_iter++;
    if (task_iter == LAYER_TASK_NUM1){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data1FeedData0(
      ping_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  } else {
    U1_Data1FeedData0(
      pong_buffer,
      fifo_feed_0,
      LAYER_IN_NUM_T_prev,
      LAYER_IN_IMG_H_T_prev,
      FILTER_D1_H_prev,
      FILTER_D1_W_prev,
      LAYER_STRIDE_prev,
      LAYER_ROW_IL_FACTOR_prev,
      LAYER_COL_IL_FACTOR_prev,
      K_NUM_prev,
      KH_prev,
      KW_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

/**
 *  This file is automatically generated by PolySA CodeGen.
 *  Version: 1.0
 *  Authos: Jie Wang
 */

//#include "common_header_U1.h"

void U1_Data2WriteData0(
  U1_data_t2 buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR],
  tapa::istream<U1_Data2TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data2TransferChannelType> &fifo_transfer_out,
  unsigned int engine_id,
  uint LAYER_OUT_NUM_T,
  uint LAYER_IN_IMG_H_T,
  uint LAYER_IN_IMG_W_T,
  uint LAYER_COL_IL_FACTOR,
  uint LAYER_STRIDE,
  uint LAYER_TCONV_STRIDE
){
#pragma HLS INLINE off

  bool LAST_ENGINE = (engine_id == 9 / U1_DATA2_FC_SPLIT_FACTOR - 1);

  bool more_to_read_from_buffer = true;
  bool more_to_collect_from_sys_arr = true;
  bool data_is_from_local_buffer;
  bool data_is_from_external_buffer;
  ap_uint<7> oo = 0;
  ap_uint<9> h = 0;
  ap_uint<9> h_bound = LAYER_IN_IMG_H_T*LAYER_TCONV_STRIDE / LAYER_STRIDE;
  ap_uint<13> w = 0;
  ap_uint<13> w_bound = LAYER_IN_IMG_W_T*LAYER_TCONV_STRIDE / LAYER_STRIDE;
  LAYER_COL_IL_FACTOR *= LAYER_TCONV_STRIDE;
  bool done = 0;

  while(!done){
#pragma HLS PIPELINE II=1
    ap_uint<22> local_buf_idx = h * LAYER_COL_IL_FACTOR * LAYER_OUT_NUM_T + (w % LAYER_COL_IL_FACTOR) * LAYER_OUT_NUM_T + oo * U1_DATA2_FC_SIMD_FACTOR;
    #pragma HLS BIND_OP variable=local_buf_idx op=mul impl=fabric latency=1
    if (w >= engine_id * LAYER_COL_IL_FACTOR){
      ap_uint<13> collector_id = w / LAYER_COL_IL_FACTOR;
      data_is_from_local_buffer = (collector_id == engine_id);
      data_is_from_external_buffer = !data_is_from_local_buffer;

      U1_Data2TransferChannelType data_write_to_fifo;

      if (data_is_from_external_buffer){
        data_write_to_fifo = fifo_transfer_in.read();
      } else {
        U1_data_t2 data0 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][0];
        ap_uint<U1_DATA2_WIDTH> data0_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data0);
        U1_data_t2 data1 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][1];
        ap_uint<U1_DATA2_WIDTH> data1_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data1);
        U1_data_t2 data2 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][2];
        ap_uint<U1_DATA2_WIDTH> data2_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data2);
        U1_data_t2 data3 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][3];
        ap_uint<U1_DATA2_WIDTH> data3_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data3);
        U1_data_t2 data4 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][4];
        ap_uint<U1_DATA2_WIDTH> data4_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data4);
        U1_data_t2 data5 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][5];
        ap_uint<U1_DATA2_WIDTH> data5_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data5);
        U1_data_t2 data6 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][6];
        ap_uint<U1_DATA2_WIDTH> data6_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data6);
        U1_data_t2 data7 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][7];
        ap_uint<U1_DATA2_WIDTH> data7_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data7);
        ap_uint<U1_DATA2_WIDTH * U1_DATA2_FC_SIMD_FACTOR> pack_data = (
          data7_cast,
          data6_cast,
          data5_cast,
          data4_cast,
          data3_cast,
          data2_cast,
          data1_cast,
          data0_cast
        );
        data_write_to_fifo.data = pack_data;
      }

      fifo_transfer_out.write(data_write_to_fifo);
    }
    w++;
    if (w == w_bound){
      w = 0;
      h++;
      if (h == h_bound){
        h = 0;
        oo++;
        if (oo == LAYER_OUT_NUM_T / U1_DATA2_FC_SIMD_FACTOR){
          oo = 0;
          done = 1;
        }
      }
    }
  }

}

void U1_Data2WriteDataLast(
  U1_data_t2 buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR],
  tapa::ostream<U1_Data2TransferChannelType> &fifo_transfer_out,
  unsigned int engine_id,
  uint LAYER_OUT_NUM_T,
  uint LAYER_IN_IMG_H_T,
  uint LAYER_IN_IMG_W_T,
  uint LAYER_COL_IL_FACTOR,
  uint LAYER_STRIDE,
  uint LAYER_TCONV_STRIDE
){
#pragma HLS INLINE off

  bool LAST_ENGINE = (engine_id == 9 / U1_DATA2_FC_SPLIT_FACTOR - 1);

  bool more_to_read_from_buffer = true;
  bool more_to_collect_from_sys_arr = true;
  bool data_is_from_local_buffer;
  bool data_is_from_external_buffer;
  ap_uint<7> oo = 0;
  ap_uint<9> h = 0;
  ap_uint<9> h_bound = LAYER_IN_IMG_H_T*LAYER_TCONV_STRIDE / LAYER_STRIDE;
  ap_uint<13> w = 0;
  ap_uint<13> w_bound = LAYER_IN_IMG_W_T*LAYER_TCONV_STRIDE / LAYER_STRIDE;
  LAYER_COL_IL_FACTOR *= LAYER_TCONV_STRIDE;
  bool done = 0;

  while(!done){
#pragma HLS PIPELINE II=1
    ap_uint<22> local_buf_idx = h * LAYER_COL_IL_FACTOR * LAYER_OUT_NUM_T + (w % LAYER_COL_IL_FACTOR) * LAYER_OUT_NUM_T + oo * U1_DATA2_FC_SIMD_FACTOR;
    #pragma HLS BIND_OP variable=local_buf_idx op=mul impl=fabric latency=1
    if (w >= engine_id * LAYER_COL_IL_FACTOR){
      ap_uint<13> collector_id = w / LAYER_COL_IL_FACTOR;
      data_is_from_local_buffer = (collector_id == engine_id);
      data_is_from_external_buffer = !data_is_from_local_buffer;

      U1_Data2TransferChannelType data_write_to_fifo;

      if (data_is_from_external_buffer){
      } else {
        U1_data_t2 data0 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][0];
        ap_uint<U1_DATA2_WIDTH> data0_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data0);
        U1_data_t2 data1 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][1];
        ap_uint<U1_DATA2_WIDTH> data1_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data1);
        U1_data_t2 data2 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][2];
        ap_uint<U1_DATA2_WIDTH> data2_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data2);
        U1_data_t2 data3 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][3];
        ap_uint<U1_DATA2_WIDTH> data3_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data3);
        U1_data_t2 data4 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][4];
        ap_uint<U1_DATA2_WIDTH> data4_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data4);
        U1_data_t2 data5 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][5];
        ap_uint<U1_DATA2_WIDTH> data5_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data5);
        U1_data_t2 data6 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][6];
        ap_uint<U1_DATA2_WIDTH> data6_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data6);
        U1_data_t2 data7 = buffer[0][local_buf_idx / U1_DATA2_FC_SIMD_FACTOR][7];
        ap_uint<U1_DATA2_WIDTH> data7_cast = Reinterpret<ap_uint<U1_DATA2_WIDTH> >(data7);
        ap_uint<U1_DATA2_WIDTH * U1_DATA2_FC_SIMD_FACTOR> pack_data = (
          data7_cast,
          data6_cast,
          data5_cast,
          data4_cast,
          data3_cast,
          data2_cast,
          data1_cast,
          data0_cast
        );
        data_write_to_fifo.data = pack_data;
      }

      fifo_transfer_out.write(data_write_to_fifo);
    }
    w++;
    if (w == w_bound){
      w = 0;
      h++;
      if (h == h_bound){
        h = 0;
        oo++;
        if (oo == LAYER_OUT_NUM_T / U1_DATA2_FC_SIMD_FACTOR){
          oo = 0;
          done = 1;
        }
      }
    }
  }

}

void U1_Data2ReadData0(
  U1_data_t2 buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR],
  tapa::istream<U1_Data2PEChannelType> &fifo_collect_0,
  uint LAYER_IN_IMG_H_T,
  uint LAYER_ROW_IL_FACTOR,
  uint LAYER_COL_IL_FACTOR,
  uint LAYER_STRIDE,
  uint LAYER_TCONV_STRIDE
){
#pragma HLS INLINE off

  bool more_to_collect_from_sys_arr = true;
  ap_uint<3> buffer_gs_id = 0;
  ap_uint<21> buffer_read_counter = 0;
  ap_uint<7> c0_counter = 0;
  ap_uint<4> c1_counter = 0;
  ap_uint<7> c2_counter = 0;
  ap_uint<4> c3_counter = 0;
  ap_uint<10> col_counter = 0;
  ap_uint<10> row_counter = 0;
  ap_uint<8> c0_counter_bound = LAYER_IN_IMG_H_T / LAYER_STRIDE;

  while(more_to_collect_from_sys_arr){
#pragma HLS PIPELINE II=1
    ap_uint<20> offset0 = c0_counter * LAYER_COL_IL_FACTOR*LAYER_TCONV_STRIDE*LAYER_TCONV_STRIDE * U1_SA_ROWS * LAYER_ROW_IL_FACTOR;
    ap_uint<20> offset1 = c2_counter*LAYER_TCONV_STRIDE * U1_SA_ROWS * LAYER_ROW_IL_FACTOR;
    ap_uint<20> offset2 = ((U1_SA_ROWS - 1 - c3_counter) * LAYER_ROW_IL_FACTOR + c1_counter);
    ap_uint<20> offset3 = U1_SA_ROWS*(row_counter*LAYER_COL_IL_FACTOR*LAYER_ROW_IL_FACTOR*LAYER_TCONV_STRIDE+LAYER_ROW_IL_FACTOR*col_counter);
    #pragma HLS BIND_OP variable=offset0 op=mul impl=fabric latency=1
    #pragma HLS BIND_OP variable=offset1 op=mul impl=fabric latency=1
    #pragma HLS BIND_OP variable=offset2 op=mul impl=fabric latency=1
    #pragma HLS BIND_OP variable=offset3 op=mul impl=fabric latency=1

    ap_uint<21> buffer_ind_to_collect_from_sys_arr = offset0 + offset1 + offset2 + offset3;
    U1_Data2PEChannelType data_to_collect_0;
    data_to_collect_0 = fifo_collect_0.read();
    buffer[0][buffer_ind_to_collect_from_sys_arr / U1_DATA2_FC_SIMD_FACTOR][buffer_ind_to_collect_from_sys_arr % U1_DATA2_FC_SIMD_FACTOR] = data_to_collect_0.data;

    // counter logic
    c0_counter++;
    if (c0_counter == c0_counter_bound){
      c0_counter = 0;
      c1_counter++;
      if (c1_counter == LAYER_ROW_IL_FACTOR){
        c1_counter = 0;
        c2_counter++;
        if (c2_counter == LAYER_COL_IL_FACTOR){
          c2_counter = 0;
          col_counter++;
          if (col_counter == LAYER_TCONV_STRIDE){
            col_counter = 0;
            row_counter++;
            if (row_counter == LAYER_TCONV_STRIDE){
              row_counter = 0;
              c3_counter++;
              if (c3_counter == U1_SA_ROWS){
                c3_counter = 0;
                more_to_collect_from_sys_arr = false;
              }
            }
          }
        }
      }
    }
  }
}

void U1_DataCollect2Engine0(
  tapa::istream<U1_Data2TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data2TransferChannelType> &fifo_transfer_out,
  tapa::istream<U1_Data2PEChannelType> &fifo_collect_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in0, // from other engines
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo_transfer_in
#pragma HLS DATA_PACK variable=fifo_transfer_out
#pragma HLS DATA_PACK variable=fifo_collect_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in0.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in0.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  uint LAYER_OUT_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint LAYER_IN_IMG_W_T_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_TCONV_STRIDE_prev;
  uint task_iter = 0;
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in0.read();
  uint LAYER_OUT_NUM_T = fifo_config_in0.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in0.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in0.read();
  uint LAYER_FILTER_S_H = fifo_config_in0.read();
  uint LAYER_FILTER_S_W = fifo_config_in0.read();
  uint LAYER_TASK_NUM1 = fifo_config_in0.read();
  uint LAYER_TASK_NUM2 = fifo_config_in0.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in0.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in0.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in0.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in0.read();
  uint LAYER_STRIDE = fifo_config_in0.read();
  uint LAYER_BATCH = fifo_config_in0.read();

  uint LAYER_CONV_TYPE = fifo_config_in0.read();
  uint FILTER_D0_H = fifo_config_in0.read();
  uint FILTER_D0_W = fifo_config_in0.read();
  uint FILTER_D1_H = fifo_config_in0.read();
  uint FILTER_D1_W = fifo_config_in0.read();
  uint LAYER_DILATION_RATE = fifo_config_in0.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in0.read();
  uint K_NUM = fifo_config_in0.read();
  ap_uint<32> KH = fifo_config_in0.read();
  ap_uint<32> KW = fifo_config_in0.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  U1_data_t2 ping_buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR];
  U1_data_t2 pong_buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR];
  #if U1_DataCollect2Engine0_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataCollect2Engine0_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
#pragma HLS ARRAY_PARTITION variable=ping_buffer dim=3 complete
#pragma HLS ARRAY_PARTITION variable=pong_buffer dim=3 complete
#pragma HLS DATA_PACK variable=ping_buffer
#pragma HLS DATA_PACK variable=pong_buffer

  unsigned int initial_round = 0;
  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in0.read();
      LAYER_OUT_NUM_T = fifo_config_in0.read();
      LAYER_IN_IMG_H_T = fifo_config_in0.read();
      LAYER_IN_IMG_W_T = fifo_config_in0.read();
      LAYER_FILTER_S_H = fifo_config_in0.read();
      LAYER_FILTER_S_W = fifo_config_in0.read();
      LAYER_TASK_NUM1 = fifo_config_in0.read();
      LAYER_TASK_NUM2 = fifo_config_in0.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in0.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in0.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in0.read();
      LAYER_COL_IL_FACTOR = fifo_config_in0.read();
      LAYER_STRIDE = fifo_config_in0.read();
      LAYER_BATCH = fifo_config_in0.read();

      LAYER_CONV_TYPE = fifo_config_in0.read();
      FILTER_D0_H = fifo_config_in0.read();
      FILTER_D0_W = fifo_config_in0.read();
      FILTER_D1_H = fifo_config_in0.read();
      FILTER_D1_W = fifo_config_in0.read();
      LAYER_DILATION_RATE = fifo_config_in0.read();
      LAYER_TCONV_STRIDE = fifo_config_in0.read();
      K_NUM = fifo_config_in0.read();
      KH = fifo_config_in0.read();
      KW = fifo_config_in0.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);

      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data2ReadData0(
        ping_buffer,
        fifo_collect_0,
        LAYER_IN_IMG_H_T,
        LAYER_ROW_IL_FACTOR,
        LAYER_COL_IL_FACTOR,
        LAYER_STRIDE,
        LAYER_TCONV_STRIDE
      );
    } else {
      if (initial_round % 2 == 1){
        U1_Data2ReadData0(
          pong_buffer,
          fifo_collect_0,
          LAYER_IN_IMG_H_T,
          LAYER_ROW_IL_FACTOR,
          LAYER_COL_IL_FACTOR,
          LAYER_STRIDE,
          LAYER_TCONV_STRIDE
        );
        U1_Data2WriteData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
      } else {
        U1_Data2ReadData0(
          ping_buffer,
          fifo_collect_0,
          LAYER_IN_IMG_H_T,
          LAYER_ROW_IL_FACTOR,
          LAYER_COL_IL_FACTOR,
          LAYER_STRIDE,
          LAYER_TCONV_STRIDE
        );
        U1_Data2WriteData0(pong_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
      }
    }
    initial_round++;
    LAYER_OUT_NUM_T_prev = LAYER_OUT_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    LAYER_IN_IMG_W_T_prev = LAYER_IN_IMG_W_T;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_TCONV_STRIDE_prev = LAYER_TCONV_STRIDE;

    task_iter += 1;
    if (task_iter == LAYER_TASK_NUM2){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data2WriteData0(ping_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
  } else {
    U1_Data2WriteData0(pong_buffer, fifo_transfer_in, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_DataCollect2Engine0_wrapper(
  tapa::istream<U1_Data2TransferChannelType> &fifo_transfer_in,
  tapa::ostream<U1_Data2TransferChannelType> &fifo_transfer_out,
  tapa::istream<U1_Data2PEChannelType> &fifo_collect_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in0,
  tapa::ostream<uint> &fifo_config_out
){
  U1_DataCollect2Engine0(
    fifo_transfer_in,
    fifo_transfer_out,
    fifo_collect_0,
    engine_id,
    fifo_config_in0,
    fifo_config_out
  );
}

void U1_DataCollect2EngineLast(
  tapa::ostream<U1_Data2TransferChannelType> &fifo_transfer_out,
  tapa::istream<U1_Data2PEChannelType> &fifo_collect_0,
  unsigned int engine_id,
  tapa::istream<uint> &fifo_config_in0,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo_transfer_out
#pragma HLS DATA_PACK variable=fifo_collect_0
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in0.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in0.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  uint LAYER_OUT_NUM_T_prev;
  uint LAYER_IN_IMG_H_T_prev;
  uint LAYER_IN_IMG_W_T_prev;
  uint LAYER_COL_IL_FACTOR_prev;
  uint LAYER_STRIDE_prev;
  uint LAYER_TCONV_STRIDE_prev;
  uint task_iter = 0;
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in0.read();
  uint LAYER_OUT_NUM_T = fifo_config_in0.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in0.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in0.read();
  uint LAYER_FILTER_S_H = fifo_config_in0.read();
  uint LAYER_FILTER_S_W = fifo_config_in0.read();
  uint LAYER_TASK_NUM1 = fifo_config_in0.read();
  uint LAYER_TASK_NUM2 = fifo_config_in0.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in0.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in0.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in0.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in0.read();
  uint LAYER_STRIDE = fifo_config_in0.read();
  uint LAYER_BATCH = fifo_config_in0.read();

  uint LAYER_CONV_TYPE = fifo_config_in0.read();
  uint FILTER_D0_H = fifo_config_in0.read();
  uint FILTER_D0_W = fifo_config_in0.read();
  uint FILTER_D1_H = fifo_config_in0.read();
  uint FILTER_D1_W = fifo_config_in0.read();
  uint LAYER_DILATION_RATE = fifo_config_in0.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in0.read();
  uint K_NUM = fifo_config_in0.read();
  ap_uint<32> KH = fifo_config_in0.read();
  ap_uint<32> KW = fifo_config_in0.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  U1_data_t2 ping_buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR];
  U1_data_t2 pong_buffer[U1_DATA2_FC_GROUP_FACTOR][U1_DATA2_BUF_SIZE / U1_DATA2_FC_SIMD_FACTOR][U1_DATA2_FC_SIMD_FACTOR];
  #if U1_DataCollect2EngineLast_MEM == 0
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=BRAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=BRAM
  #elif U1_DataCollect2EngineLast_MEM == 1
    #pragma HLS bind_storage variable=ping_buffer type=RAM_T2P impl=URAM
    #pragma HLS bind_storage variable=pong_buffer type=RAM_T2P impl=URAM
  #endif
#pragma HLS ARRAY_PARTITION variable=ping_buffer dim=3 complete
#pragma HLS ARRAY_PARTITION variable=pong_buffer dim=3 complete
#pragma HLS DATA_PACK variable=ping_buffer
#pragma HLS DATA_PACK variable=pong_buffer

  unsigned int initial_round = 0;
  bool done = 0;
  ap_uint<3> layer_iter = 0;
  bool layer_start = 0;
  while(!done){
    if (layer_start){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in0.read();
      LAYER_OUT_NUM_T = fifo_config_in0.read();
      LAYER_IN_IMG_H_T = fifo_config_in0.read();
      LAYER_IN_IMG_W_T = fifo_config_in0.read();
      LAYER_FILTER_S_H = fifo_config_in0.read();
      LAYER_FILTER_S_W = fifo_config_in0.read();
      LAYER_TASK_NUM1 = fifo_config_in0.read();
      LAYER_TASK_NUM2 = fifo_config_in0.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in0.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in0.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in0.read();
      LAYER_COL_IL_FACTOR = fifo_config_in0.read();
      LAYER_STRIDE = fifo_config_in0.read();
      LAYER_BATCH = fifo_config_in0.read();

      LAYER_CONV_TYPE = fifo_config_in0.read();
      FILTER_D0_H = fifo_config_in0.read();
      FILTER_D0_W = fifo_config_in0.read();
      FILTER_D1_H = fifo_config_in0.read();
      FILTER_D1_W = fifo_config_in0.read();
      LAYER_DILATION_RATE = fifo_config_in0.read();
      LAYER_TCONV_STRIDE = fifo_config_in0.read();
      K_NUM = fifo_config_in0.read();
      KH = fifo_config_in0.read();
      KW = fifo_config_in0.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);

      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
      layer_start = 0;
    }

    if (initial_round == 0){
      U1_Data2ReadData0(
        ping_buffer,
        fifo_collect_0,
        LAYER_IN_IMG_H_T,
        LAYER_ROW_IL_FACTOR,
        LAYER_COL_IL_FACTOR,
        LAYER_STRIDE,
        LAYER_TCONV_STRIDE
      );
    } else {
      if (initial_round % 2 == 1){
        U1_Data2ReadData0(
          pong_buffer,
          fifo_collect_0,
          LAYER_IN_IMG_H_T,
          LAYER_ROW_IL_FACTOR,
          LAYER_COL_IL_FACTOR,
          LAYER_STRIDE,
          LAYER_TCONV_STRIDE
        );
        U1_Data2WriteDataLast(ping_buffer, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
      } else {
        U1_Data2ReadData0(
          ping_buffer,
          fifo_collect_0,
          LAYER_IN_IMG_H_T,
          LAYER_ROW_IL_FACTOR,
          LAYER_COL_IL_FACTOR,
          LAYER_STRIDE,
          LAYER_TCONV_STRIDE
        );
        U1_Data2WriteDataLast(pong_buffer, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
      }
    }
    initial_round++;
    LAYER_OUT_NUM_T_prev = LAYER_OUT_NUM_T;
    LAYER_IN_IMG_H_T_prev = LAYER_IN_IMG_H_T;
    LAYER_IN_IMG_W_T_prev = LAYER_IN_IMG_W_T;
    LAYER_COL_IL_FACTOR_prev = LAYER_COL_IL_FACTOR;
    LAYER_STRIDE_prev = LAYER_STRIDE;
    LAYER_TCONV_STRIDE_prev = LAYER_TCONV_STRIDE;
    task_iter += 1;
    if (task_iter == LAYER_TASK_NUM2){
      task_iter = 0;
      layer_iter += 1;
      layer_start = 1;
      if (layer_iter == LAYER_BATCH){
        layer_iter = 0;
        done = 1;
      }
    }
  }

  if (initial_round % 2 == 1){
    U1_Data2WriteDataLast(ping_buffer, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
  } else {
    U1_Data2WriteDataLast(pong_buffer, fifo_transfer_out, engine_id, LAYER_OUT_NUM_T_prev, LAYER_IN_IMG_H_T_prev, LAYER_IN_IMG_W_T_prev, LAYER_COL_IL_FACTOR_prev, LAYER_STRIDE_prev, LAYER_TCONV_STRIDE_prev);
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

/**
 *  This file is automatically generated by PolySA CodeGen.
 *  Version: 1.0
 *  Authos: Jie Wang
 */

//#include "common_header_U1.h"

void U1_PE_MAC(
  U1_Data0SIMDType op0,
  U1_Data1SIMDType op1,
  U1_data_t2* op2,
  bool init
){
#pragma HLS INLINE
#pragma HLS DATA_PACK variable=op0
#pragma HLS DATA_PACK variable=op1
  ap_uint<256> op0_data = op0;
  ap_uint<256> op1_data = op1;

  float op0_u[U1_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=op0_u complete
  float op1_u[U1_SIMD_FACTOR];
#pragma HLS ARRAY_PARTITION variable=op1_u complete

  for (int i = 0; i < U1_SIMD_FACTOR; i++){
#pragma HLS UNROLL
    ap_uint<U1_DATA0_WIDTH> sel0 = op0_data(U1_DATA0_WIDTH-1, 0);
    op0_u[i] = Reinterpret<U1_data_t0>(sel0);
    op0_data = op0_data >> U1_DATA0_WIDTH;
    ap_uint<U1_DATA1_WIDTH> sel1 = op1_data(U1_DATA1_WIDTH-1, 0);
    op1_u[i] = Reinterpret<U1_data_t1>(sel1);
    op1_data = op1_data >> U1_DATA1_WIDTH;
  }

  U1_data_t2 sum = (init == 1)? (U1_data_t2) 0: *op2;

  U1_data_t2 mult0 = op0_u[0] * op1_u[0];
  U1_data_t2 mult1 = op0_u[1] * op1_u[1];
  U1_data_t2 mult2 = op0_u[2] * op1_u[2];
  U1_data_t2 mult3 = op0_u[3] * op1_u[3];
  U1_data_t2 mult4 = op0_u[4] * op1_u[4];
  U1_data_t2 mult5 = op0_u[5] * op1_u[5];
  U1_data_t2 mult6 = op0_u[6] * op1_u[6];
  U1_data_t2 mult7 = op0_u[7] * op1_u[7];

  U1_data_t2 sum2_0 = mult0 + mult1;
  U1_data_t2 sum2_1 = mult2 + mult3;
  U1_data_t2 sum2_2 = mult4 + mult5;
  U1_data_t2 sum2_3 = mult6 + mult7;

  U1_data_t2 sum1_0 = sum2_0 + sum2_1;
  U1_data_t2 sum1_1 = sum2_2 + sum2_3;

  U1_data_t2 sum0_0 = sum1_0 + sum1_1;

  sum += sum0_0;

  *op2 = sum;
}

void U1_op0_transfer(
  tapa::istream<U1_Data0PEChannelType> &fifo0_in,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_out,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo0_in
#pragma HLS DATA_PACK variable=fifo0_out
#pragma HLS DATA_PACK variable=fifo0_local
#pragma HLS INLINE off
  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  while(!done1){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
      }

    ap_uint<36> task_num = 0;
    ap_uint<12> la_counter = 0;
    ap_uint<18> local_reg_id = 0;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
      U1_Data0PEChannelType fifo0_in_data;
      fifo0_in_data = fifo0_in.read();
      fifo0_out.write(fifo0_in_data);
      fifo0_local.write(fifo0_in_data);
      local_reg_id++;
      if (local_reg_id == LAYER_LOCAL_REG_NUM){
        local_reg_id = 0;
        la_counter++;
        if (la_counter == LAYER_LOCAL_ACCUM_NUM){
          la_counter = 0;
          task_num++;
          if (task_num == LAYER_TASK_NUM1){
            task_num = 0;
            done2 = 1;
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_op0_transfer_wrapper(
  tapa::istream<U1_Data0PEChannelType> &fifo0_in,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_out,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_op0_transfer(
    fifo0_in,
    fifo0_out,
    fifo0_local,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_op0_transfer_last(
  tapa::istream<U1_Data0PEChannelType> &fifo0_in,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo0_in
#pragma HLS DATA_PACK variable=fifo0_local
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  while(!done1){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
    }

    ap_uint<36> task_num = 0;
    ap_uint<12> la_counter = 0;
    ap_uint<18> local_reg_id = 0;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
      U1_Data0PEChannelType fifo0_in_data;
      fifo0_in_data = fifo0_in.read();
      fifo0_local.write(fifo0_in_data);
      local_reg_id++;
      if (local_reg_id == LAYER_LOCAL_REG_NUM){
        local_reg_id = 0;
        la_counter++;
        if (la_counter == LAYER_LOCAL_ACCUM_NUM){
          la_counter = 0;
          task_num++;
          if (task_num == LAYER_TASK_NUM1){
            task_num = 0;
            done2 = 1;
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_op0_transfer_last_wrapper(
  tapa::istream<U1_Data0PEChannelType> &fifo0_in,
  tapa::ostream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_op0_transfer_last(
    fifo0_in,
    fifo0_local,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_op1_transfer(
  tapa::istream<U1_Data1PEChannelType> &fifo1_in,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_out,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo1_in
#pragma HLS DATA_PACK variable=fifo1_out
#pragma HLS DATA_PACK variable=fifo1_local
#pragma HLS INLINE off
  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  while(!done1){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
      }

    ap_uint<36> task_num = 0;
    ap_uint<12> la_counter = 0;
    ap_uint<18> local_reg_id = 0;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
      U1_Data1PEChannelType fifo1_in_data;
      fifo1_in_data = fifo1_in.read();
      fifo1_out.write(fifo1_in_data);
      fifo1_local.write(fifo1_in_data);
      local_reg_id++;
      if (local_reg_id == LAYER_LOCAL_REG_NUM){
        local_reg_id = 0;
        la_counter++;
        if (la_counter == LAYER_LOCAL_ACCUM_NUM){
          la_counter = 0;
          task_num++;
          if (task_num == LAYER_TASK_NUM1){
            task_num = 0;
            done2 = 1;
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_op1_transfer_wrapper(
  tapa::istream<U1_Data1PEChannelType> &fifo1_in,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_out,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_op1_transfer(
    fifo1_in,
    fifo1_out,
    fifo1_local,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_op1_transfer_last(
  tapa::istream<U1_Data1PEChannelType> &fifo1_in,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo1_in
#pragma HLS DATA_PACK variable=fifo1_local
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  while(!done1){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
    }

    ap_uint<36> task_num = 0;
    ap_uint<12> la_counter = 0;
    ap_uint<18> local_reg_id = 0;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
      U1_Data1PEChannelType fifo1_in_data;
      fifo1_in_data = fifo1_in.read();
      fifo1_local.write(fifo1_in_data);
      local_reg_id++;
      if (local_reg_id == LAYER_LOCAL_REG_NUM){
        local_reg_id = 0;
        la_counter++;
        if (la_counter == LAYER_LOCAL_ACCUM_NUM){
          la_counter = 0;
          task_num++;
          if (task_num == LAYER_TASK_NUM1){
            task_num = 0;
            done2 = 1;
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_op1_transfer_last_wrapper(
  tapa::istream<U1_Data1PEChannelType> &fifo1_in,
  tapa::ostream<U1_Data1PEChannelType> &fifo1_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_op1_transfer_last(
    fifo1_in,
    fifo1_local,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_compute(
  tapa::istream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<U1_Data1PEChannelType> &fifo1_local,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo0_local
#pragma HLS DATA_PACK variable=fifo1_local
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  U1_data_t2 local_buffer[U1_LOCAL_REG_NUM];

  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  ap_uint<8> in_ch_factor = LAYER_IN_NUM_T/U1_SIMD_FACTOR;

  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  ap_uint<3> layer_iter = 0;
  bool done1 = 0;
  int i = 0;
  ap_uint<10> LAYER_LOCAL_ACCUM_NUM_ARR[4] = {
    in_ch_factor*unpack(KH,0)*unpack(KW,0),
    in_ch_factor*unpack(KH,1)*unpack(KW,1),
    in_ch_factor*unpack(KH,2)*unpack(KW,2),
    in_ch_factor*unpack(KH,3)*unpack(KW,3)
  };
  ap_uint<16> LAYER_LOCAL_REG_NUM_ARR_START[4] = {
  	0*LAYER_LOCAL_REG_NUM,
  	1*LAYER_LOCAL_REG_NUM,
  	2*LAYER_LOCAL_REG_NUM,
  	3*LAYER_LOCAL_REG_NUM
  };
  ap_uint<16> LAYER_LOCAL_REG_NUM_ARR_END[4] = {
  	1*LAYER_LOCAL_REG_NUM,
  	2*LAYER_LOCAL_REG_NUM,
  	3*LAYER_LOCAL_REG_NUM,
  	4*LAYER_LOCAL_REG_NUM
  };
  #pragma HLS ARRAY_PARTITION variable=LAYER_LOCAL_ACCUM_NUM_ARR complete
  #pragma HLS ARRAY_PARTITION variable=LAYER_LOCAL_REG_NUM_ARR_START complete
  #pragma HLS ARRAY_PARTITION variable=LAYER_LOCAL_REG_NUM_ARR_END complete  
  while(!done1){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
    }

    ap_uint<36> task_num = 0;
    ap_uint<12> la_counter = 0;
    ap_uint<18> local_reg_id = 0;
    bool done2 = 0;
    while(!done2){
#pragma HLS PIPELINE II=1
#pragma HLS DEPENDENCE inter false variable=local_buffer
      U1_Data0PEChannelType fifo0_in_data;
      fifo0_in_data = fifo0_local.read();
      U1_Data1PEChannelType fifo1_in_data;
      fifo1_in_data = fifo1_local.read();
      bool init = fifo0_in_data.new_pair;
      bool last = fifo0_in_data.last_pair;
      U1_PE_MAC(fifo0_in_data.data, fifo1_in_data.data, &local_buffer[local_reg_id], (init == 1 && la_counter == 0 && i<K_NUM)? 1:0);
      if (la_counter == LAYER_LOCAL_ACCUM_NUM_ARR[i] - 1 && last){
        fifo2_local.write(U1_Data2PEChannelType(local_buffer[local_reg_id]));
      }
      local_reg_id++;
      if (local_reg_id == LAYER_LOCAL_REG_NUM_ARR_END[i]){
        local_reg_id = LAYER_LOCAL_REG_NUM_ARR_START[i];
        la_counter++;
        if (la_counter == LAYER_LOCAL_ACCUM_NUM_ARR[i]){
          la_counter = 0;
          i++;
          local_reg_id = LAYER_LOCAL_REG_NUM_ARR_START[i];
          if (i == K_NUM){
            i = 0;
            local_reg_id = 0;
            task_num++;
            if (task_num == LAYER_TASK_NUM1){
              task_num = 0;
              done2 = 1;
            }
          }
        }
      }
    }
    layer_iter++;
    if (layer_iter == LAYER_BATCH){
      layer_iter = 0;
      done1 = 1;
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_compute_wrapper(
  tapa::istream<U1_Data0PEChannelType> &fifo0_local,
  tapa::istream<U1_Data1PEChannelType> &fifo1_local,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_local,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_compute(
    fifo0_local,
    fifo1_local,
    fifo2_local,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_res_transfer(
  tapa::istream<U1_Data2PEChannelType> &fifo2_local,
  tapa::istream<U1_Data2PEChannelType> &fifo2_in,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_out,
  ap_uint<6> pe_row_id,
  ap_uint<7> pe_col_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo2_in
#pragma HLS DATA_PACK variable=fifo2_out
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  U1_data_t2 local_buffer[U1_TRANSFER_REG_NUM];

  for (ap_uint<3> layer_iter = 0; layer_iter < LAYER_BATCH; layer_iter++){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
    }

    #pragma HLS BIND_OP variable=LAYER_LOCAL_REG_NUM op=mul impl=fabric latency=1
    LAYER_LOCAL_REG_NUM = K_NUM*LAYER_LOCAL_REG_NUM;
    for (ap_uint<29> task_num = 0; task_num < LAYER_TASK_NUM2; task_num++)
    {
      for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
        if (local_reg_id < LAYER_LOCAL_REG_NUM){
          U1_Data2PEChannelType fifo2_local_data = fifo2_local.read();
          local_buffer[local_reg_id] = fifo2_local_data.data;
        } else {
          break;
        }
      }

      for (int transfer_iter = pe_row_id + 1 - 1; transfer_iter >= 0; transfer_iter--){
        for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
          if (local_reg_id < LAYER_LOCAL_REG_NUM){
            fifo2_out.write(U1_Data2PEChannelType(local_buffer[local_reg_id]));
            if (transfer_iter > 0){
              U1_Data2PEChannelType fifo2_in_data = fifo2_in.read();
              local_buffer[local_reg_id] = fifo2_in_data.data;
            }
          } else {
            break;
          }
        }
      }
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_res_transfer_wrapper(
  tapa::istream<U1_Data2PEChannelType> &fifo2_local,
  tapa::istream<U1_Data2PEChannelType> &fifo2_in,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_out,
  ap_uint<6> pe_row_id,
  ap_uint<7> pe_col_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_res_transfer(
    fifo2_local,
    fifo2_in,
    fifo2_out,
    pe_row_id,
    pe_col_id,
    fifo_config_in,
    fifo_config_out
  );
}

void U1_res_transfer_last(
  tapa::istream<U1_Data2PEChannelType> &fifo2_local,
  tapa::istream<U1_Data2PEChannelType> &fifo2_in,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_out,
  ap_uint<6> pe_row_id,
  ap_uint<7> pe_col_id,
  tapa::istream<uint> &fifo_config_in
){
#pragma HLS DATA_PACK variable=fifo2_in
#pragma HLS DATA_PACK variable=fifo2_out
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  U1_data_t2 local_buffer[U1_TRANSFER_REG_NUM];

  for (ap_uint<3> layer_iter = 0; layer_iter < LAYER_BATCH; layer_iter++){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
    }

    #pragma HLS BIND_OP variable=LAYER_LOCAL_REG_NUM op=mul impl=fabric latency=1
    LAYER_LOCAL_REG_NUM = K_NUM*LAYER_LOCAL_REG_NUM;
    for (ap_uint<29> task_num = 0; task_num < LAYER_TASK_NUM2; task_num++)
    {
      for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
        if (local_reg_id < LAYER_LOCAL_REG_NUM){
          U1_Data2PEChannelType fifo2_local_data = fifo2_local.read();
          local_buffer[local_reg_id] = fifo2_local_data.data;
        } else {
          break;
        }
      }

      for (int transfer_iter = pe_row_id + 1 - 1; transfer_iter >= 0; transfer_iter--){
        for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
          if (local_reg_id < LAYER_LOCAL_REG_NUM){
            fifo2_out.write(U1_Data2PEChannelType(local_buffer[local_reg_id]));
            if (transfer_iter > 0){
              U1_Data2PEChannelType fifo2_in_data = fifo2_in.read();
              local_buffer[local_reg_id] = fifo2_in_data.data;
            }
          } else {
            break;
          }
        }
      }
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_res_transfer_first(
  tapa::istream<U1_Data2PEChannelType> &fifo2_local,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_out,
  ap_uint<6> pe_row_id,
  ap_uint<7> pe_col_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
#pragma HLS DATA_PACK variable=fifo2_out
#pragma HLS INLINE off

  bool inst_done = 0;
  uint inst = 0;
  int inst_count = fifo_config_in.read();
  fifo_config_out.write(inst_count);
  while(!inst_done){
  uint CONV_EN = fifo_config_in.read();
  fifo_config_out.write(CONV_EN);
  if(CONV_EN){
  // read in configurations
  uint LAYER_IN_NUM_T = fifo_config_in.read();
  uint LAYER_OUT_NUM_T = fifo_config_in.read();
  uint LAYER_IN_IMG_H_T = fifo_config_in.read();
  uint LAYER_IN_IMG_W_T = fifo_config_in.read();
  uint LAYER_FILTER_S_H = fifo_config_in.read();
  uint LAYER_FILTER_S_W = fifo_config_in.read();
  uint LAYER_TASK_NUM1 = fifo_config_in.read();
  uint LAYER_TASK_NUM2 = fifo_config_in.read();
  uint LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
  uint LAYER_LOCAL_REG_NUM = fifo_config_in.read();
  uint LAYER_ROW_IL_FACTOR = fifo_config_in.read();
  uint LAYER_COL_IL_FACTOR = fifo_config_in.read();
  uint LAYER_STRIDE = fifo_config_in.read();
  uint LAYER_BATCH = fifo_config_in.read();

  uint LAYER_CONV_TYPE = fifo_config_in.read();
  uint FILTER_D0_H = fifo_config_in.read();
  uint FILTER_D0_W = fifo_config_in.read();
  uint FILTER_D1_H = fifo_config_in.read();
  uint FILTER_D1_W = fifo_config_in.read();
  uint LAYER_DILATION_RATE = fifo_config_in.read();
  uint LAYER_TCONV_STRIDE = fifo_config_in.read();
  uint K_NUM = fifo_config_in.read();
  ap_uint<32> KH = fifo_config_in.read();
  ap_uint<32> KW = fifo_config_in.read();
  // write out configurations
  fifo_config_out.write(LAYER_IN_NUM_T);
  fifo_config_out.write(LAYER_OUT_NUM_T);
  fifo_config_out.write(LAYER_IN_IMG_H_T);
  fifo_config_out.write(LAYER_IN_IMG_W_T);
  fifo_config_out.write(LAYER_FILTER_S_H);
  fifo_config_out.write(LAYER_FILTER_S_W);
  fifo_config_out.write(LAYER_TASK_NUM1);
  fifo_config_out.write(LAYER_TASK_NUM2);
  fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
  fifo_config_out.write(LAYER_LOCAL_REG_NUM);
  fifo_config_out.write(LAYER_ROW_IL_FACTOR);
  fifo_config_out.write(LAYER_COL_IL_FACTOR);
  fifo_config_out.write(LAYER_STRIDE);
  fifo_config_out.write(LAYER_BATCH);

  fifo_config_out.write(LAYER_CONV_TYPE);
  fifo_config_out.write(FILTER_D0_H);
  fifo_config_out.write(FILTER_D0_W);
  fifo_config_out.write(FILTER_D1_H);	
  fifo_config_out.write(FILTER_D1_W);	
  fifo_config_out.write(LAYER_DILATION_RATE);
  fifo_config_out.write(LAYER_TCONV_STRIDE);
  fifo_config_out.write(K_NUM);
  fifo_config_out.write(KH);
  fifo_config_out.write(KW);
  U1_data_t2 local_buffer[U1_TRANSFER_REG_NUM];

  for (ap_uint<3> layer_iter = 0; layer_iter < LAYER_BATCH; layer_iter++){
    if (layer_iter > 0){
      // read in configurations
      LAYER_IN_NUM_T = fifo_config_in.read();
      LAYER_OUT_NUM_T = fifo_config_in.read();
      LAYER_IN_IMG_H_T = fifo_config_in.read();
      LAYER_IN_IMG_W_T = fifo_config_in.read();
      LAYER_FILTER_S_H = fifo_config_in.read();
      LAYER_FILTER_S_W = fifo_config_in.read();
      LAYER_TASK_NUM1 = fifo_config_in.read();
      LAYER_TASK_NUM2 = fifo_config_in.read();
      LAYER_LOCAL_ACCUM_NUM = fifo_config_in.read();
      LAYER_LOCAL_REG_NUM = fifo_config_in.read();
      LAYER_ROW_IL_FACTOR = fifo_config_in.read();
      LAYER_COL_IL_FACTOR = fifo_config_in.read();
      LAYER_STRIDE = fifo_config_in.read();
      LAYER_BATCH = fifo_config_in.read();

      LAYER_CONV_TYPE = fifo_config_in.read();
      FILTER_D0_H = fifo_config_in.read();
      FILTER_D0_W = fifo_config_in.read();
      FILTER_D1_H = fifo_config_in.read();
      FILTER_D1_W = fifo_config_in.read();
      LAYER_DILATION_RATE = fifo_config_in.read();
      LAYER_TCONV_STRIDE = fifo_config_in.read();
      K_NUM = fifo_config_in.read();
      KH = fifo_config_in.read();
      KW = fifo_config_in.read();
      // write out configurations
      fifo_config_out.write(LAYER_IN_NUM_T);
      fifo_config_out.write(LAYER_OUT_NUM_T);
      fifo_config_out.write(LAYER_IN_IMG_H_T);
      fifo_config_out.write(LAYER_IN_IMG_W_T);
      fifo_config_out.write(LAYER_FILTER_S_H);
      fifo_config_out.write(LAYER_FILTER_S_W);
      fifo_config_out.write(LAYER_TASK_NUM1);
      fifo_config_out.write(LAYER_TASK_NUM2);
      fifo_config_out.write(LAYER_LOCAL_ACCUM_NUM);
      fifo_config_out.write(LAYER_LOCAL_REG_NUM);
      fifo_config_out.write(LAYER_ROW_IL_FACTOR);
      fifo_config_out.write(LAYER_COL_IL_FACTOR);
      fifo_config_out.write(LAYER_STRIDE);
      fifo_config_out.write(LAYER_BATCH);
      fifo_config_out.write(LAYER_CONV_TYPE);
      fifo_config_out.write(FILTER_D0_H);
      fifo_config_out.write(FILTER_D0_W);
      fifo_config_out.write(FILTER_D1_H);	
      fifo_config_out.write(FILTER_D1_W);	
      fifo_config_out.write(LAYER_DILATION_RATE);
      fifo_config_out.write(LAYER_TCONV_STRIDE);
      fifo_config_out.write(K_NUM);
      fifo_config_out.write(KH);
      fifo_config_out.write(KW);
    }

    #pragma HLS BIND_OP variable=LAYER_LOCAL_REG_NUM op=mul impl=fabric latency=1
    LAYER_LOCAL_REG_NUM = K_NUM*LAYER_LOCAL_REG_NUM;
    for (ap_uint<29> task_num = 0; task_num < LAYER_TASK_NUM2; task_num++)
    {
      for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
        if (local_reg_id < LAYER_LOCAL_REG_NUM){
          U1_Data2PEChannelType fifo2_local_data = fifo2_local.read();
          local_buffer[local_reg_id] = fifo2_local_data.data;
        } else {
          break;
        }
      }

      for (int transfer_iter = pe_row_id + 1 - 1; transfer_iter >= 0; transfer_iter--){
        for (ap_uint<18> local_reg_id = 0; local_reg_id < U1_TRANSFER_REG_NUM; local_reg_id++){
#pragma HLS PIPELINE II=1
          if (local_reg_id < LAYER_LOCAL_REG_NUM){
            fifo2_out.write(U1_Data2PEChannelType(local_buffer[local_reg_id]));
          } else {
            break;
          }
        }
      }
    }
  }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}

void U1_res_transfer_first_wrapper(
  tapa::istream<U1_Data2PEChannelType> &fifo2_local,
  tapa::ostream<U1_Data2PEChannelType> &fifo2_out,
  ap_uint<6> pe_row_id,
  ap_uint<7> pe_col_id,
  tapa::istream<uint> &fifo_config_in,
  tapa::ostream<uint> &fifo_config_out
){
  U1_res_transfer_first(
    fifo2_local,
    fifo2_out,
    pe_row_id,
    pe_col_id,
    fifo_config_in,
    fifo_config_out
  );
}

/*
 * Function name: cin_load_ddr_read
 * Function description: This function loads cin results from off-chip DRAM.
 *                       Two modes are enabled. If the whole feature maps of the layer could fit
 *                       in the on-chip buffer, they will be loaded as a whole. Otherwise, each time,
 *                       LAYER_IN_NUM_T * (LAYER_IN_W_T + FILTER_S - 1) of data are loaded.
 */
void cin_load_ddr_read(
		bus_mem_0     global_cin,
		bus_t0        *cin_burst_buf,
		uint          LAYER_IN_H_HW,
		uint          LAYER_IN_W_HW,
		uint          LAYER_IN_NUM_T,
		uint          LAYER_IN_H_T,
		uint          LAYER_IN_W_T,
		ap_uint<8>    FILTER_S_H,
    ap_uint<8>    FILTER_S_W,
    ap_uint<8>    FILTER_D_H,
    ap_uint<8>    FILTER_D_W,
    uint          STRIDE,
		uint          cin_offset,
		uint          in_num_iter,
		uint          in_h_iter,
		uint          in_w_iter,
		uint          num_tile,
		bool          change,
		bool          max_pool,
		bool          write
){
  // cout<<"cin_load_ddr_read"<<endl;
  // Read the data based on the data layout used.
  // If filter size is 1, the data layout is ceil(N / Tn) * ceil(H / Th) * ceil(W / Tw) * Th * Tw * Tn
  // o.w. ceil(N / Tn) * H * ceil(W / Tw) * Tw * Tn
  // The data in on-chip buffer will have the data layout of Th * Tw * Tn
  if (change){
    for (int hh = 0; hh < 1; hh++){
      uint local_cin_offset = 0;
      uint global_cin_offset = cin_offset + num_tile * (LAYER_IN_W_T) * (LAYER_IN_H_T) * LAYER_IN_NUM_T;
      #ifdef DEBUG_cin
              if(write)
                cout << global_cin_offset << endl;
      #endif
      memcpy((void*)&cin_burst_buf[local_cin_offset / BUS_PACK_FACTOR0], (void*)&global_cin[global_cin_offset / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_NUM_T * (LAYER_IN_W_T) * (LAYER_IN_H_T));
    }
  } else {
    for (int hh = 0; hh < LAYER_IN_H_T + FILTER_S_H - STRIDE; hh++){
      uint h = in_h_iter + hh;
      uint burst_len = 0;
      // case if the burst len is not divisible by BUS_PACK_FACTOR0
      if (((LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T) % BUS_PACK_FACTOR0 == 0){
        burst_len = (LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T;
      } else {
        burst_len = (LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T + BUS_PACK_FACTOR0 - ((LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T) % BUS_PACK_FACTOR0;
      }
      uint local_cin_offset = hh * burst_len;
      uint global_cin_offset = in_num_iter * LAYER_IN_H_HW * LAYER_IN_W_HW + h * LAYER_IN_W_HW * LAYER_IN_NUM_T + in_w_iter * LAYER_IN_NUM_T + cin_offset;
      #ifdef DEBUG_cin
            if(write)
              cout << global_cin_offset << endl;
      #endif
      memcpy((void*)&cin_burst_buf[local_cin_offset / BUS_PACK_FACTOR0], (void*)&global_cin[global_cin_offset / BUS_PACK_FACTOR0], sizeof(data_t0) * burst_len);
    }
  }
}

/*
 * Function name: cin_load_fifo_write
 * Function description: This function writes cin data to the downstream modules.
 */
void cin_load_fifo_write(
		bus_t0                            *cin_burst_buf,
		tapa::ostream<CinLoadData0Type>   &fifo_cin,
		uint                              LAYER_IN_NUM_T,
		uint                              LAYER_IN_H_T,
		uint                              LAYER_IN_W_T,
		ap_uint<8>                        FILTER_S_H,
    ap_uint<8>                        FILTER_S_W,
    ap_uint<8>                        FILTER_D_H,
    ap_uint<8>                        FILTER_D_W,
    uint                              STRIDE
){
  // cout<<"cin_load_fifo_write"<<endl;
	int ii = 0;
	int hh = 0;
	int ww = 0;
	bool done = 0;
	while(!done){
	#pragma HLS PIPELINE II=1
	// Data layout of the buffer: Th * Tw * Tn
    uint burst_len = 0;
    // case if the burst len is not divisible by BUS_PACK_FACTOR0
    if (((LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T) % BUS_PACK_FACTOR0 == 0){
      burst_len = (LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T;
    } else {
      burst_len = (LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T + BUS_PACK_FACTOR0 - ((LAYER_IN_W_T + FILTER_D_W - STRIDE) * LAYER_IN_NUM_T) % BUS_PACK_FACTOR0;
    }
		uint local_cin_idx = hh * burst_len + ww * LAYER_IN_NUM_T + ii * DEPTH_CONV_LANE;
		uint bus_cin_idx = local_cin_idx / BUS_PACK_FACTOR0;
		uint bus_cin_offset = local_cin_idx % BUS_PACK_FACTOR0;
		bus_t0 bus_cin_data = cin_burst_buf[bus_cin_idx];
		CinLoadData0Type fifo_cin_data;
	// DATA_SEL_FACTOR = BUS_PACK_FACTOR / SIMD_LANE
	// BUS_PACK_FACTOR is the number of elements packed in one to enable memory coalescing
	// Since each entry in FIFOs will be SIMD_LANE elements of the data, we should unpack based on SIMD_LANE
	#if DATA_SEL_FACTOR0 == 1
		fifo_cin_data = bus_cin_data;
	#elif DATA_SEL_FACTOR0 == 2 
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 4
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 8
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		case 4:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 5 - 1, DATA_W0 * DEPTH_CONV_LANE * 4);
			break;
		case 5:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 6 - 1, DATA_W0 * DEPTH_CONV_LANE * 5);
			break;
		case 6:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 7 - 1, DATA_W0 * DEPTH_CONV_LANE * 6);
			break;
		case 7:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 8 - 1, DATA_W0 * DEPTH_CONV_LANE * 7);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 16
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		case 4:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 5 - 1, DATA_W0 * DEPTH_CONV_LANE * 4);
			break;
		case 5:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 6 - 1, DATA_W0 * DEPTH_CONV_LANE * 5);
			break;
		case 6:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 7 - 1, DATA_W0 * DEPTH_CONV_LANE * 6);
			break;
		case 7:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 8 - 1, DATA_W0 * DEPTH_CONV_LANE * 7);
			break;
		case 8:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 9 - 1, DATA_W0 * DEPTH_CONV_LANE * 8);
			break;
		case 9:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 10 - 1, DATA_W0 * DEPTH_CONV_LANE * 9);
			break;
		case 10:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 11 - 1, DATA_W0 * DEPTH_CONV_LANE * 10);
			break;
		case 11:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 12 - 1, DATA_W0 * DEPTH_CONV_LANE * 11);
			break;
		case 12:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 13 - 1, DATA_W0 * DEPTH_CONV_LANE * 12);
			break;
		case 13:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 14 - 1, DATA_W0 * DEPTH_CONV_LANE * 13);
			break;
		case 14:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 15 - 1, DATA_W0 * DEPTH_CONV_LANE * 14);
			break;
		case 15:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 16 - 1, DATA_W0 * DEPTH_CONV_LANE * 15);
			break;
		}
	#endif     

		fifo_cin.write(fifo_cin_data);
	#ifdef DEBUG_load_change
		if(FILTER_S == 1){
			cout << " cin ";
			for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL
				ap_uint<DATA_W0> u32_beta = fifo_cin_data(DATA_W0 - 1, 0);
				data_t2 a = Reinterpret<data_t2>(u32_beta);
				fifo_cin_data = fifo_cin_data >> DATA_W0;
				cout << a << " ";
			}
			cout << endl;
		}
	#endif

			// Repeat until the whole tile is read
		ww++;
		if (ww == LAYER_IN_W_T + FILTER_S_W - STRIDE){	//change here
			ww = 0;
			hh++;
			if (hh == LAYER_IN_H_T + FILTER_S_H - STRIDE){	//change here
				hh = 0;
				ii++;
				if (ii == LAYER_IN_NUM_T / DEPTH_CONV_LANE){
					ii = 0;
					done = 1;
				}
			}
		}
	}
}

/*
 * Function name: cin_load
 * Function description: This function loads and distributes cin and instructions.
 */
void cin_load(
    uint start_inst, uint end_inst,
		bus_mem_0                        global_cin,
		bus_mem_3                        layer_config,
		tapa::ostream<CinLoadData0Type>  &fifo_cin,
		tapa::ostream<ConfigInst>        &fifo_config_out,
    tapa::istream<int>               &in_sync,
    tapa::ostream<int>               &out_sync
){
	#pragma HLS INLINE off 
  cout<<"cin_load"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
  int sync = inst==0? 0 : in_sync.read();
  out_sync.write(inst);
  if (sync == inst) {
  int layer_id = start_inst + inst;
	cout<<"layer_id: "<<layer_id<<endl;
  unsigned int config[CONFIG_PARAMS * MAX_LAYER_BATCH];
  // memcpy((void*)config, (void*)(&layer_config[CONFIG_PARAMS * layer_id]), sizeof(unsigned int) * CONFIG_PARAMS * 1);
  for(int i=0; i<CONFIG_PARAMS; i++){
    #pragma HLS PIPELINE II=1
    config[i] = layer_config[CONFIG_PARAMS * layer_id + i];
  }

		// on-chip buffer for cin data
	bus_t0 cin_burst_buf_ping[CIN_BUFF / BUS_PACK_FACTOR0];
	bus_t0 cin_burst_buf_pong[CIN_BUFF / BUS_PACK_FACTOR0];

	#if cin_load_MEM == 0
		#pragma HLS bind_storage variable=cin_burst_buf_ping type=RAM_T2P impl=BRAM
		#pragma HLS bind_storage variable=cin_burst_buf_pong type=RAM_T2P impl=BRAM  
	#elif cin_load_MEM == 1
		#pragma HLS bind_storage variable=cin_burst_buf_ping type=RAM_T2P impl=URAM
		#pragma HLS bind_storage variable=cin_burst_buf_pong type=RAM_T2P impl=URAM 
	#endif



		// layer batch
	ap_uint<32> LAYER_BATCH = config[28];

		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

	uint in_num_iter_prev = 0;
	uint out_num_iter_prev = 0;
	uint in_h_iter_prev = 0;
	uint in_w_iter_prev = 0;
	uint layer_iter_prev = 0;

		// parameters
		// inst0
	ap_uint<32> LAYER_IN_NUM_HW;
	ap_uint<32> LAYER_OUT_NUM_HW;
	ap_uint<32> LAYER_IN_H_HW;
	ap_uint<32> LAYER_IN_W_HW;
	ap_uint<32> LAYER_OUT_H_HW;
	ap_uint<32> LAYER_OUT_W_HW;
  // NPD: north padding
  // SPD: south padding
  // WPD: west padding
  // EPD: east padding
  ap_uint<16> LAYER_OUT_H_NPD;
  ap_uint<16> LAYER_OUT_H_SPD;
  ap_uint<16> LAYER_OUT_W_WPD;
  ap_uint<16> LAYER_OUT_W_EPD;
		// inst1
	ap_uint<32> LAYER_IN_NUM;
	ap_uint<32> LAYER_OUT_NUM;
	ap_uint<32> LAYER_IN_H;
	ap_uint<32> LAYER_IN_W;
	ap_uint<32> LAYER_OUT_H;
	ap_uint<32> LAYER_OUT_W;
		// inst2
	ap_uint<32> CIN_OFFSET;
	ap_uint<32> WEIGHT_OFFSET;
	ap_uint<32> BIAS_OFFSET;
	ap_uint<32> COUT_OFFSET;
	ap_uint<16> FILTER_S1;
	ap_uint<8> FILTER_S2_H;
  ap_uint<8> FILTER_S2_W;
	ap_uint<32> STRIDE;
		// inst3
	ap_uint<32> LAYER_EN;
	ap_uint<16> LAYER_IN_NUM_T;
	ap_uint<16> LAYER_OUT_NUM_T;
	ap_uint<32> LAYER_IN_H_T;
	ap_uint<32> LAYER_IN_W_T;
	ap_uint<32> PREV_CIN_OFFSET;
		// inst4
	ap_uint<32> LAYER_TASK_NUM1;
	ap_uint<32> LAYER_TASK_NUM2;
	ap_uint<32> LAYER_LOCAL_ACCUM_NUM;
	ap_uint<32> LAYER_LOCAL_REG_NUM;
	ap_uint<32> LAYER_ROW_IL_FACTOR;
	ap_uint<32> LAYER_COL_IL_FACTOR;
		//inst5
	ap_uint<16> LAYER_CONV_TYPE;
	ap_uint<8> FILTER_D0_H;
  ap_uint<8> FILTER_D0_W;
	ap_uint<8> FILTER_D1_H;
  ap_uint<8> FILTER_D1_W;
	ap_uint<16> LAYER_DILATION_RATE;
	ap_uint<16> LAYER_TCONV_STRIDE;
	ap_uint<16> K_NUM;
  ap_uint<32> KH;
  ap_uint<32> KW;
  ap_uint<16> POOL_NUM;
  ap_uint<16> POOL_NUM_HW;


	ap_uint<1>  CONV_1ST_EN;
	ap_uint<1>  LOAD_PREV_CIN;

	uint LAYER_IN_NUM_T_prev;
	uint LAYER_OUT_NUM_T_prev;
	uint LAYER_IN_H_T_prev;
	uint LAYER_IN_W_T_prev;
	ap_uint<8> FILTER_S_H_prev;
  ap_uint<8> FILTER_S_W_prev;
  ap_uint<8> FILTER_D_H_prev;
  ap_uint<8> FILTER_D_W_prev;
  uint STRIDE_prev;
	

	uint task_cnt = 0;
	bool layer_start = 1;
	bool layer_start_prev = 0;
	bool done = 0;
		// We assum that cin has been pre-padded with zeros
	uint prev = 0;
	uint init = 1;
	uint num_tile = 0;
	bool write_last_cin = 0;
	bool write_last_prev_cin = 0;
	bool start_prev = 0;
	bool done_prev = 0;
	bool change_layout = 0;
	uint inter_tile = 0;
	uint channel_iter = 0;
  int count_fifo = 0;
  int count_dram = 0;
  int count = 0;
	while(!done){
			// Read and extract the parameters/config from the instructions
			// Refer to util.h or the README of the repo to find how the instructions are made
			// inst0 : The hardware sizes of each dimension (the sizes after tiling is applied)
		LAYER_IN_NUM_HW  = config[0 + layer_iter * CONFIG_PARAMS];
		LAYER_OUT_NUM_HW = config[1 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_H_HW    = config[2 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_W_HW    = config[3 + layer_iter * CONFIG_PARAMS];
		// LAYER_OUT_H_HW   = config[4 + layer_iter * CONFIG_PARAMS];
		// LAYER_OUT_W_HW   = config[5 + layer_iter * CONFIG_PARAMS];
    LAYER_OUT_H_NPD = config[4 + layer_iter * CONFIG_PARAMS];
    LAYER_OUT_H_SPD = config[5 + layer_iter * CONFIG_PARAMS];
    LAYER_OUT_W_WPD = config[6 + layer_iter * CONFIG_PARAMS];
    LAYER_OUT_W_EPD = config[7 + layer_iter * CONFIG_PARAMS];

			// inst1 : The actual sizes of each dimension
		LAYER_IN_NUM  = config[8 + layer_iter * CONFIG_PARAMS];
		LAYER_OUT_NUM = config[9 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_H    = config[10 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_W    = config[11 + layer_iter * CONFIG_PARAMS];
		LAYER_OUT_H   = config[12 + layer_iter * CONFIG_PARAMS];
		LAYER_OUT_W   = config[13 + layer_iter * CONFIG_PARAMS];

			// inst2 : The DRAM locations for reading/writing the data of this layer + Filter and Stride sizes
		CIN_OFFSET    = config[14 + layer_iter * CONFIG_PARAMS];
		WEIGHT_OFFSET = config[15 + layer_iter * CONFIG_PARAMS];
		BIAS_OFFSET   = config[16 + layer_iter * CONFIG_PARAMS];
		COUT_OFFSET   = config[17 + layer_iter * CONFIG_PARAMS];
		FILTER_S1     = config[18 + layer_iter * CONFIG_PARAMS];
		FILTER_S2_H   = config[19 + layer_iter * CONFIG_PARAMS];
    FILTER_S2_W   = config[20 + layer_iter * CONFIG_PARAMS];

		STRIDE        = config[21 + layer_iter * CONFIG_PARAMS];

			// inst3 : The enable signlas of the modules + DRAM location of the input to the previous layer + Tile sizes
		LAYER_EN        = config[22 + layer_iter * CONFIG_PARAMS]; 	// contains the enable signals for the modules
		PREV_CIN_OFFSET = config[23 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_NUM_T  = config[24 + layer_iter * CONFIG_PARAMS];
		LAYER_OUT_NUM_T = config[25 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_H_T    = config[26 + layer_iter * CONFIG_PARAMS];
		LAYER_IN_W_T    = config[27 + layer_iter * CONFIG_PARAMS];

		CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  INTER_LOAD_EN  = LAYER_EN[8];
		ap_uint<1>  INTER_WRITE_EN = LAYER_EN[9];
		ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
		ap_uint<1>  BATCH_NORM_EN_DEPTH  = LAYER_EN[12];


		LOAD_PREV_CIN  = LAYER_EN[11];

			// inst4 : The info needed to run the systolic array
		LAYER_TASK_NUM1       = config[29 + layer_iter * CONFIG_PARAMS];
		LAYER_TASK_NUM2       = config[30 + layer_iter * CONFIG_PARAMS];
		LAYER_LOCAL_ACCUM_NUM = config[31 + layer_iter * CONFIG_PARAMS];
		LAYER_LOCAL_REG_NUM   = config[32 + layer_iter * CONFIG_PARAMS];
		LAYER_ROW_IL_FACTOR   = config[33 + layer_iter * CONFIG_PARAMS];
		LAYER_COL_IL_FACTOR   = config[34 + layer_iter * CONFIG_PARAMS];
			// inst5 : DT CONV INSTS
		LAYER_CONV_TYPE         = config[35 + layer_iter * CONFIG_PARAMS];
		FILTER_D0_H							= config[36 + layer_iter * CONFIG_PARAMS];
    FILTER_D0_W							= config[37 + layer_iter * CONFIG_PARAMS];
    FILTER_D1_H							= config[38 + layer_iter * CONFIG_PARAMS];
    FILTER_D1_W							= config[39 + layer_iter * CONFIG_PARAMS];
		LAYER_DILATION_RATE			= config[40 + layer_iter * CONFIG_PARAMS];
		LAYER_TCONV_STRIDE  		= config[41 + layer_iter * CONFIG_PARAMS];
		K_NUM               		= config[42 + layer_iter * CONFIG_PARAMS];
    KH(31,24)        		= config[43 + layer_iter * CONFIG_PARAMS];
    KH(23,16)        		= config[44 + layer_iter * CONFIG_PARAMS];
    KH(15,8)         		= config[45 + layer_iter * CONFIG_PARAMS];
    KH(7,0)          		= config[46 + layer_iter * CONFIG_PARAMS];
    KW(31,24)        		= config[47 + layer_iter * CONFIG_PARAMS];
    KW(23,16)        		= config[48 + layer_iter * CONFIG_PARAMS];
    KW(15,8)         		= config[49 + layer_iter * CONFIG_PARAMS];
    KW(7,0)          		= config[50 + layer_iter * CONFIG_PARAMS];
    POOL_NUM          	= config[51 + layer_iter * CONFIG_PARAMS];
    POOL_NUM_HW         = config[52 + layer_iter * CONFIG_PARAMS];

  // #define DEBUG_config_cin
	#ifdef DEBUG_config_cin
  
		cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " 
    << LAYER_OUT_H_NPD << " " << LAYER_OUT_H_SPD << " " << LAYER_OUT_W_WPD << " " << LAYER_OUT_W_EPD << endl;
		cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
		cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2_H << " " << FILTER_S2_W << " " << STRIDE << endl;
		cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;
    cout << LAYER_TASK_NUM1 << " " << LAYER_TASK_NUM2 << " " << LAYER_LOCAL_ACCUM_NUM << " " << LAYER_LOCAL_REG_NUM << " " << LAYER_ROW_IL_FACTOR << " " << LAYER_COL_IL_FACTOR << endl;
    cout << LAYER_CONV_TYPE << " " << FILTER_D0_H << " " << FILTER_D0_W << " " << FILTER_D1_H << " " << FILTER_D1_W << " " << LAYER_DILATION_RATE << " " << LAYER_TCONV_STRIDE;
    cout << " " << K_NUM << " " << KH << " " << KW << " " << POOL_NUM << " " << POOL_NUM_HW << endl;
	#endif
  
			// Pack the parameters to pass them throught the config FIFOs
		ConfigInst inst0 = (LAYER_OUT_W_EPD, LAYER_OUT_W_WPD, LAYER_OUT_H_SPD, LAYER_OUT_H_NPD, LAYER_IN_W_HW, LAYER_IN_H_HW, LAYER_OUT_NUM_HW, LAYER_IN_NUM_HW);
		ConfigInst inst1 = (LAYER_OUT_W, LAYER_OUT_H, LAYER_IN_W, LAYER_IN_H, LAYER_OUT_NUM, LAYER_IN_NUM);
		ConfigInst inst2 = (STRIDE, FILTER_S2_W, FILTER_S2_H, FILTER_S1, COUT_OFFSET, BIAS_OFFSET, WEIGHT_OFFSET, CIN_OFFSET);
		ConfigInst inst3 = (LAYER_BATCH, LAYER_IN_W_T, LAYER_IN_H_T, LAYER_OUT_NUM_T, LAYER_IN_NUM_T, PREV_CIN_OFFSET, LAYER_EN);
		ConfigInst inst4 = (LAYER_COL_IL_FACTOR, LAYER_ROW_IL_FACTOR, LAYER_LOCAL_REG_NUM, LAYER_LOCAL_ACCUM_NUM, LAYER_TASK_NUM2, LAYER_TASK_NUM1);
		ConfigInst inst5 = (POOL_NUM_HW, POOL_NUM, KW, KH, K_NUM, LAYER_TCONV_STRIDE, LAYER_DILATION_RATE, FILTER_D1_W, FILTER_D1_H, FILTER_D0_W, FILTER_D0_H, LAYER_CONV_TYPE);

			// Pass the config/instructions
		if (layer_start){
			fifo_config_out.write(inst0);
			fifo_config_out.write(inst1);
			fifo_config_out.write(inst2);
			fifo_config_out.write(inst3);
			fifo_config_out.write(inst4);
			fifo_config_out.write(inst5);
			layer_start = 0;
		}

			// offsets
		uint cin_offset = CIN_OFFSET;
		uint prev_cin_offset = PREV_CIN_OFFSET;

		if (prev == 1) start_prev = 1;
    
		// set up some configuration signals
		ap_uint<8> FILTER_S_H = ((CONV_EN == 1)? (ap_uint<8>) ((LAYER_CONV_TYPE == 1)? (ap_uint<8>) unpack(KH, 0) : (ap_uint<8>) FILTER_S2_H) : (ap_uint<8>) 1);
    ap_uint<8> FILTER_S_W = ((CONV_EN == 1)? (ap_uint<8>) ((LAYER_CONV_TYPE == 1)? (ap_uint<8>) unpack(KW, 0) : (ap_uint<8>) FILTER_S2_W) : (ap_uint<8>) 1);
    ap_uint<8> FILTER_D_H = FILTER_D0_H;
    ap_uint<8> FILTER_D_W = FILTER_D0_W;

		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		change_layout = (((LAYER_IN_W_HW == LAYER_IN_W) || (LAYER_IN_W_HW == LAYER_IN_W_T)) && ((LAYER_IN_H_HW == LAYER_IN_H) || (LAYER_IN_H_HW == LAYER_IN_H_T))); 	// if next filter = 1 : change the layout to num_tile, Th, Tw, Tn

			// If it has to read from DRAM and not the stored data in on-chip storage
		if (INTER_LOAD_EN == 0){
			if ((max_pool && out_num_iter == 0) || separable_conv || conv2d || (UP_SAMPLE_EN && out_num_iter == 0)){
				if (task_cnt == 0){
						// first load cin
					cin_load_ddr_read(global_cin, cin_burst_buf_ping, LAYER_IN_H_HW, LAYER_IN_W_HW, LAYER_IN_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER_S_H, FILTER_S_W, FILTER_D_H, FILTER_D_W, STRIDE, cin_offset, in_num_iter, in_h_iter, in_w_iter, num_tile, change_layout, max_pool, 0);
        } else {
						// Apply double buffering for reading the data and filling the FIFO
					if (task_cnt % 2 == 1){
						cin_load_ddr_read(global_cin, cin_burst_buf_pong, LAYER_IN_H_HW, LAYER_IN_W_HW, LAYER_IN_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER_S_H, FILTER_S_W, FILTER_D_H, FILTER_D_W, STRIDE, cin_offset, in_num_iter, in_h_iter, in_w_iter, num_tile, change_layout, max_pool, 0);
            cin_load_fifo_write(cin_burst_buf_ping, fifo_cin, LAYER_IN_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, FILTER_S_H_prev, FILTER_S_W_prev, FILTER_D_H_prev, FILTER_D_W_prev, STRIDE_prev);
          } else {
						cin_load_ddr_read(global_cin, cin_burst_buf_ping, LAYER_IN_H_HW, LAYER_IN_W_HW, LAYER_IN_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER_S_H, FILTER_S_W, FILTER_D_H, FILTER_D_W, STRIDE, cin_offset, in_num_iter, in_h_iter, in_w_iter, num_tile, change_layout, max_pool, 0);
            cin_load_fifo_write(cin_burst_buf_pong, fifo_cin, LAYER_IN_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, FILTER_S_H_prev, FILTER_S_W_prev, FILTER_D_H_prev, FILTER_D_W_prev, STRIDE_prev);
          }
				}

				task_cnt++;
				LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
				LAYER_OUT_NUM_T_prev = LAYER_OUT_NUM_T;
				LAYER_IN_H_T_prev = LAYER_IN_H_T;
				LAYER_IN_W_T_prev = LAYER_IN_W_T;
				FILTER_S_H_prev = FILTER_S_H;
        FILTER_S_W_prev = FILTER_S_W;
        FILTER_D_H_prev = FILTER_D_H;
        FILTER_D_W_prev = FILTER_D_W;
        STRIDE_prev = STRIDE;
			}
		}

			// Continue until all the tiles are read
			// Since each layer produces LAYER_OUT_NUM feature maps, 
			// repeat reading the tiles LAYER_OUT_NUM times
		in_num_iter += LAYER_IN_NUM_T;
		if (in_num_iter < LAYER_IN_NUM){
			channel_iter += ((LAYER_IN_W / LAYER_IN_W_T) * (LAYER_IN_H / LAYER_IN_H_T));
		} else {
			channel_iter = 0;
			inter_tile++;
		}

		num_tile = conv2d==1? channel_iter + inter_tile : num_tile + 1;
		if (in_num_iter >= LAYER_IN_NUM){
			in_num_iter = 0;
			channel_iter = 0;
			in_h_iter += LAYER_IN_H_T;
			if (in_h_iter >= LAYER_IN_H){
				in_h_iter = 0;
				in_w_iter += LAYER_IN_W_T; 	
				if (in_w_iter >= LAYER_IN_W){
					in_w_iter = 0;
					out_num_iter += LAYER_OUT_NUM_T;
					num_tile = 0;
					inter_tile = 0;
					channel_iter = 0;
					if (out_num_iter >= LAYER_OUT_NUM){
						out_num_iter = 0;
						layer_iter += 1;
						prev = 0;
						layer_start = 1;
						if (layer_iter == LAYER_BATCH){
							layer_iter = 0;
							out_num_iter = 0;
							in_h_iter = 0;
							in_w_iter = 0;
							done = 1;
						}
					}
				}
			}
		}
	}


		// Fill the FIFOs with the data for the last tile
	if (task_cnt % 2 == 1){
		cin_load_fifo_write(cin_burst_buf_ping, fifo_cin, LAYER_IN_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, FILTER_S_H_prev, FILTER_S_W_prev, FILTER_D_H_prev, FILTER_D_W_prev, STRIDE_prev);
    count_fifo++;
	} else {
		cin_load_fifo_write(cin_burst_buf_pong, fifo_cin, LAYER_IN_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, FILTER_S_H_prev, FILTER_S_W_prev, FILTER_D_H_prev, FILTER_D_W_prev, STRIDE_prev);
    count_fifo++;
	}
  inst++;
  }
  if(inst == inst_count){
    inst_done = 1;
  }
  }
}
/*
 * Function name: weight_load_conv_weight_write
 * Function description: this function writes conv weights to conv module.
 * It has the same functionality as weight_load_depth_conv_weight_write
 */
void weight_load_conv_weight_write(
		bus_t1 weight_burst_buf2[],
		tapa::ostream<WeightLoadData1Type> &fifo_conv_weight,
		ConfigInst inst0,
		ConfigInst inst1,
		ConfigInst inst3,
		ap_uint<8> FILTER_H,
    ap_uint<8> FILTER_W,
		uint in_num_iter,
		uint out_num_iter
){
		// inst0
	ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
		// inst1
	ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
		// 	// inst2
		// ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		// ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		// ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		// ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		// ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		// ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		// ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
		// inst3
	ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
	ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
	ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
	ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
	ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
	ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

	ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
	ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
	ap_uint<1>  CONV_EN        = LAYER_EN[2];
	ap_uint<1>  RELU_EN        = LAYER_EN[3];
	ap_uint<1>  RELU6_EN       = LAYER_EN[4];
	ap_uint<1>  POOL_EN        = LAYER_EN[5];
	ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
	

	if (CONV_EN == 1){
		int oo = 0;
		int p = 0;
		int q = 0;
		int ii = 0;
		bool done = 0;
		while(!done){
	#pragma HLS PIPELINE II=1

	#ifdef DEBUG_weight2
			cout << "in loading weights " << DATA_SEL_FACTOR1 << " " << ii << " " << q << " " << p << " " << oo <<" " << LAYER_OUT_NUM_T << endl;
	#endif          
			uint local_w_idx = oo * FILTER_H * FILTER_W * LAYER_IN_NUM_T + p * FILTER_W * LAYER_IN_NUM_T + q * LAYER_IN_NUM_T + ii * SIMD_LANE;
			uint bus_w_idx = local_w_idx / BUS_PACK_FACTOR1;
			uint bus_w_offset = local_w_idx % BUS_PACK_FACTOR1;
				// cout<<bus_w_idx<<endl;
			bus_t1 bus_w_data = weight_burst_buf2[bus_w_idx];
				// cout<<weight_burst_buf2[bus_w_idx]<<endl;
			WeightLoadData1Type fifo_w_data;
	#if DATA_SEL_FACTOR1 == 1
			fifo_w_data = bus_w_data;
	#elif DATA_SEL_FACTOR1 == 2
			switch(bus_w_offset / SIMD_LANE){
			case 0:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 1 - 1, DATA_W1 * SIMD_LANE * 0);
				break;
			case 1:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 2 - 1, DATA_W1 * SIMD_LANE * 1);
				break;
			}
	#elif DATA_SEL_FACTOR1 == 4
			switch(bus_w_offset / SIMD_LANE){
			case 0:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 1 - 1, DATA_W1 * SIMD_LANE * 0);
				break;
			case 1:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 2 - 1, DATA_W1 * SIMD_LANE * 1);
				break;
			case 2:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 3 - 1, DATA_W1 * SIMD_LANE * 2);
				break;
			case 3:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 4 - 1, DATA_W1 * SIMD_LANE * 3);
				break;
			}
	#elif DATA_SEL_FACTOR1 == 8
			switch(bus_w_offset / SIMD_LANE){
			case 0:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 1 - 1, DATA_W1 * SIMD_LANE * 0);
				break;
			case 1:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 2 - 1, DATA_W1 * SIMD_LANE * 1);
				break;
			case 2:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 3 - 1, DATA_W1 * SIMD_LANE * 2);
				break;
			case 3:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 4 - 1, DATA_W1 * SIMD_LANE * 3);
				break;
			case 4:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 5 - 1, DATA_W1 * SIMD_LANE * 4);
				break;
			case 5:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 6 - 1, DATA_W1 * SIMD_LANE * 5);
				break;
			case 6:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 7 - 1, DATA_W1 * SIMD_LANE * 6);
				break;
			case 7:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 8 - 1, DATA_W1 * SIMD_LANE * 7);
				break;
			}
	#elif DATA_SEL_FACTOR1 == 16
			switch(bus_w_offset / SIMD_LANE){
			case 0:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 1 - 1, DATA_W1 * SIMD_LANE * 0);
				break;
			case 1:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 2 - 1, DATA_W1 * SIMD_LANE * 1);
				break;
			case 2:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 3 - 1, DATA_W1 * SIMD_LANE * 2);
				break;
			case 3:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 4 - 1, DATA_W1 * SIMD_LANE * 3);
				break;
			case 4:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 5 - 1, DATA_W1 * SIMD_LANE * 4);
				break;
			case 5:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 6 - 1, DATA_W1 * SIMD_LANE * 5);
				break;
			case 6:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 7 - 1, DATA_W1 * SIMD_LANE * 6);
				break;
			case 7:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 8 - 1, DATA_W1 * SIMD_LANE * 7);
				break;
			case 8:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 9 - 1, DATA_W1 * SIMD_LANE * 8);
				break;
			case 9:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 10 - 1, DATA_W1 * SIMD_LANE * 9);
				break;
			case 10:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 11 - 1, DATA_W1 * SIMD_LANE * 10);
				break;
			case 11:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 12 - 1, DATA_W1 * SIMD_LANE * 11);
				break;
			case 12:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 13 - 1, DATA_W1 * SIMD_LANE * 12);
				break;
			case 13:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 14 - 1, DATA_W1 * SIMD_LANE * 13);
				break;
			case 14:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 15 - 1, DATA_W1 * SIMD_LANE * 14);
				break;
			case 15:
				fifo_w_data = bus_w_data(DATA_W1 * SIMD_LANE * 16 - 1, DATA_W1 * SIMD_LANE * 15);
				break;
			}
	#endif          

			fifo_conv_weight.write(fifo_w_data);

			ii++;
			if (ii == LAYER_IN_NUM_T / SIMD_LANE){
				ii = 0;
				q++;
				if (q == FILTER_W){
					q = 0;
					p++;
					if (p == FILTER_H){
						p = 0;
						oo++;
						if (oo == LAYER_OUT_NUM_T){
							oo = 0;
							done = 1;
						}
					}
				}
			}
		}
	}
}

/**
 * Function name: weight_load
 * Function description: This function loads weights and distributes them to downstream modules.
 */
void weight_load(
    uint start_inst, uint end_inst,
		bus_mem_1                          global_weight,
		tapa::istream<ConfigInst>          &fifo_config_in,
		tapa::ostream<WeightLoadData1Type> &fifo_conv_weight,
		tapa::ostream<ConfigInst>          &fifo_config_out
){
	#pragma HLS INLINE off 
  cout<<"weight_load"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
		// on-chip buffers
	bus_t1 weight_burst_buf2[WEIGHT_BUFF / BUS_PACK_FACTOR1];
	#if weight_load_MEM == 0
		#pragma HLS bind_storage variable=weight_burst_buf2 type=RAM_T2P impl=BRAM  
	#elif weight_load_MEM == 1
		#pragma HLS bind_storage variable=weight_burst_buf2 type=RAM_T2P impl=URAM  
	#endif

		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

  // fifo_config_out.write(inst0);
	// fifo_config_out.write(inst1);
	// fifo_config_out.write(inst2);
	// fifo_config_out.write(inst3);
	// fifo_config_out.write(inst4);
  // fifo_config_out.write(inst5);

	bool layer_start = 0;
	bool done = 0;
  int counter = 0;
		// We assum that cin has been pre-padded with zeros
	while(!done){
    
		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);
			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
    // cout<<"LAYER_IN_NUM_HW: "<<LAYER_IN_NUM_HW<<endl;
    // cout<<"LAYER_OUT_NUM_HW: "<<LAYER_OUT_NUM_HW<<endl;
    // cout<<"LAYER_IN_H_HW: "<<LAYER_IN_H_HW<<endl;
    // cout<<"LAYER_IN_W_HW: "<<LAYER_IN_W_HW<<endl;
    // cout<<"LAYER_OUT_H_HW: "<<LAYER_OUT_H_HW<<endl;
    // cout<<"LAYER_OUT_W_HW: "<<LAYER_OUT_W_HW<<endl;
    // exit(0);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<8>  FILTER_S2_H      = inst2(32*4+23, 32*4+16);
    ap_uint<8>  FILTER_S2_W      = inst2(32*4+31, 32*4+24);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);

			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
    ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
    ap_uint<1>  BATCH_NORM_EN_DEPTH  = LAYER_EN[12];
    ap_uint<1>  BIAS_1_EN             = LAYER_EN[14];
    ap_uint<1>  BATCH_NORM_1_EN       = LAYER_EN[15];

    	//	//	///inst5	//	//	//	//	//	//	///
    ap_uint<16> LAYER_CONV_TYPE   = inst5(32*0+15, 32*0);
    ap_uint<8>  FILTER_D1_H       = inst5(32*1+7, 32*1);
    ap_uint<8>  FILTER_D1_W       = inst5(32*1+15, 32*1+8);
    // cout<<"FILTER_S2_H: "<<FILTER_S2_H<<" FILTER_S2_W: "<<FILTER_S2_W<<endl;
    // cout<<"FILTER_D1_H: "<<FILTER_D1_H<<" FILTER_D1_W: "<<FILTER_D1_W<<endl;
    // exit( 0 );
			// ap_uint<32> KH_KW 			    = inst5(32*3+31, 32*3);
    // ap_uint<32> KH              = inst5(32*5+31, 32*4+16);


	#ifdef DEBUG_config
		cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " << LAYER_OUT_H_HW << " " << LAYER_OUT_W_HW << endl;
		cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
		cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2 << " " << STRIDE << endl;
		cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;
	#endif
	// 	#define DEBUG_weight
			// Set up some configuration signals
		bool norm_conv_en = (CONV_EN == 1 && BATCH_NORM_EN == 1);
    ap_uint<8> FILTER_H = (LAYER_CONV_TYPE == 2)? FILTER_D1_H : FILTER_S2_H;
    ap_uint<8> FILTER_W = (LAYER_CONV_TYPE == 2)? FILTER_D1_W : FILTER_S2_W;
    // cout<<FILTER_D1<<" "<<FILTER_S2<<" "<<FILTER<<endl;
			// Set the offsets if batch normalization is used (final_result = gamma * computed_result + beta)
			// Depthwise separable convolution has two sublayers of computation,
			// one is the DW sublayer and the other is the normal 1x1 conv sublayer
			// Both of these layers may need normalization
			// In DRAM, for each layer, first the BETAs are stored and then the GAMMAs are stored


			// offsets
		uint weight_offset2 = 0;
      
		weight_offset2 = WEIGHT_OFFSET;

			// Load weights of the conv module
		if (CONV_EN == 1){
			uint global_weight_offset = weight_offset2 + out_num_iter * LAYER_IN_NUM_HW *  FILTER_H * FILTER_W + in_num_iter * LAYER_OUT_NUM_T * FILTER_H * FILTER_W; 	//	//this may need a fix for TCONV
      memcpy((void*)&weight_burst_buf2[0], (void*)&global_weight[global_weight_offset / BUS_PACK_FACTOR1], sizeof(data_t1) * LAYER_OUT_NUM_T * LAYER_IN_NUM_T *  FILTER_H * FILTER_W);
		}

			// Fill the FIFOs with the loaded data
			// weight_load_depth_conv_weight_write(weight_burst_buf1, fifo_depth_conv_weight, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter);

	#ifdef DEBUG_weight
		cout << "loaded weights" << endl;
	#endif

    weight_load_conv_weight_write(weight_burst_buf2, fifo_conv_weight, inst0, inst1, inst3,  FILTER_H, FILTER_W, in_num_iter, out_num_iter);

    counter++;
    
    
	#ifdef DEBUG_weight
		cout << "loaded weights" << endl;
	#endif

			// weight_load_depth_norm_write(beta_depth_burst_buf, fifo_beta_depth, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter);
			// weight_load_depth_norm_write(gamma_depth_burst_buf, fifo_gamma_depth, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter);
	#ifdef DEBUG_weight
		cout << in_num_iter << " in num iter " << endl;
	#endif
			// Repeat until all the tiles are read
			// Then, have to repeat reading to calculate all LAYER_OUT_NUM output feature maps
		in_num_iter += LAYER_IN_NUM_T;
		if (in_num_iter >= LAYER_IN_NUM){
			in_num_iter = 0;
			in_h_iter += LAYER_IN_H_T;
			if (in_h_iter >= LAYER_IN_H){
				in_h_iter = 0;
				in_w_iter += LAYER_IN_W_T;
				if (in_w_iter >= LAYER_IN_W){
					in_w_iter = 0;
					out_num_iter += LAYER_OUT_NUM_T;
					if (out_num_iter >= LAYER_OUT_NUM){
						out_num_iter = 0;
						layer_iter += 1;
						layer_start = 1;
						if (layer_iter == LAYER_BATCH){
							layer_iter = 0;
							done = 1;
						}
					}
				}
			}
		}
	}
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}
/*
 * Function name: weight_load_bias_write
 * Function description: This function writes bias to relu module.
 */
void weight_load_bias_write(
		bus_t2 bias_burst_buf[],
		tapa::ostream<WeightLoadData2Type> &fifo_bias,
		ConfigInst inst0,
		ConfigInst inst1,
		ConfigInst inst2,
		ConfigInst inst3,
		uint in_num_iter,
		uint out_num_iter,
    bool relu_before_conv_flag
){
		// inst0
	ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
		// inst1
	ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
	ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
	ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
	ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
	ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
	ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
		// inst2
	ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
	ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
	ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
	ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
	ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
	ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
	ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
		// inst3
	ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
	ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
	ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
	ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
	ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
	ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

	ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
	ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
	ap_uint<1>  CONV_EN        = LAYER_EN[2];
	ap_uint<1>  RELU_EN        = LAYER_EN[3];
	ap_uint<1>  RELU6_EN       = LAYER_EN[4];
	ap_uint<1>  POOL_EN        = LAYER_EN[5];
	ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved

  ap_uint<32> out_iter = relu_before_conv_flag? LAYER_IN_NUM_T : LAYER_OUT_NUM_T;
	if (CONV_EN == 1){
		// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM || relu_before_conv_flag){
    	// if (in_num_iter + LAYER_IN_NUM_T <= LAYER_IN_NUM){
			bias_write_loop: for (int oo = 0; oo < out_iter / SIMD_LANE; oo++){
	#pragma HLS PIPELINE II=1
				uint local_b_idx = oo * SIMD_LANE;
				uint bus_b_idx = local_b_idx / BUS_PACK_FACTOR2;
				uint bus_b_offset = local_b_idx % BUS_PACK_FACTOR2;
				bus_t2 bus_b_data = bias_burst_buf[bus_b_idx];
				WeightLoadData2Type fifo_b_data;
				
	// DATA_SEL_FACTOR = BUS_PACK_FACTOR / SIMD_LANE
	// BUS_PACK_FACTOR is the number of elements packed in one to enable memory coalescing
	// Since each entry in FIFOs will be SIMD_LANE elements of the data, we should unpack based on SIMD_LANE
	#if DATA_SEL_FACTOR2 == 1
				fifo_b_data = bus_b_data;
	#elif DATA_SEL_FACTOR2 == 2
				switch(bus_b_offset / SIMD_LANE){
				case 0:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 1 - 1, DATA_W2 * SIMD_LANE * 0);
					break;
				case 1:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 2 - 1, DATA_W2 * SIMD_LANE * 1);
					break;
				}
	#elif DATA_SEL_FACTOR2 == 4
				switch(bus_b_offset / SIMD_LANE){
				case 0:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 1 - 1, DATA_W2 * SIMD_LANE * 0);
					break;
				case 1:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 2 - 1, DATA_W2 * SIMD_LANE * 1);
					break;
				case 2:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 3 - 1, DATA_W2 * SIMD_LANE * 2);
					break;
				case 3:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 4 - 1, DATA_W2 * SIMD_LANE * 3);
					break;
				}
	#elif DATA_SEL_FACTOR2 == 8
				switch(bus_b_offset / SIMD_LANE){
				case 0:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 1 - 1, DATA_W2 * SIMD_LANE * 0);
					break;
				case 1:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 2 - 1, DATA_W2 * SIMD_LANE * 1);
					break;
				case 2:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 3 - 1, DATA_W2 * SIMD_LANE * 2);
					break;
				case 3:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 4 - 1, DATA_W2 * SIMD_LANE * 3);
					break;
				case 4:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 5 - 1, DATA_W2 * SIMD_LANE * 4);
					break;
				case 5:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 6 - 1, DATA_W2 * SIMD_LANE * 5);
					break;
				case 6:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 7 - 1, DATA_W2 * SIMD_LANE * 6);
					break;
				case 7:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 8 - 1, DATA_W2 * SIMD_LANE * 7);
					break;
				}
	#elif DATA_SEL_FACTOR2 == 16
				switch(bus_b_offset / SIMD_LANE){
				case 0:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 1 - 1, DATA_W2 * SIMD_LANE * 0);
					break;
				case 1:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 2 - 1, DATA_W2 * SIMD_LANE * 1);
					break;
				case 2:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 3 - 1, DATA_W2 * SIMD_LANE * 2);
					break;
				case 3:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 4 - 1, DATA_W2 * SIMD_LANE * 3);
					break;
				case 4:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 5 - 1, DATA_W2 * SIMD_LANE * 4);
					break;
				case 5:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 6 - 1, DATA_W2 * SIMD_LANE * 5);
					break;
				case 6:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 7 - 1, DATA_W2 * SIMD_LANE * 6);
					break;
				case 7:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 8 - 1, DATA_W2 * SIMD_LANE * 7);
					break;
				case 8:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 9 - 1, DATA_W2 * SIMD_LANE * 8);
					break;
				case 9:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 10 - 1, DATA_W2 * SIMD_LANE * 9);
					break;
				case 10:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 11 - 1, DATA_W2 * SIMD_LANE * 10);
					break;
				case 11:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 12 - 1, DATA_W2 * SIMD_LANE * 11);
					break;
				case 12:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 13 - 1, DATA_W2 * SIMD_LANE * 12);
					break;
				case 13:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 14 - 1, DATA_W2 * SIMD_LANE * 13);
					break;
				case 14:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 15 - 1, DATA_W2 * SIMD_LANE * 14);
					break;
				case 15:
					fifo_b_data = bus_b_data(DATA_W2 * SIMD_LANE * 16 - 1, DATA_W2 * SIMD_LANE * 15);
					break;
				}
	#endif       
				fifo_bias.write(fifo_b_data);
			}
		// }
	}
}

void bias_load(
    uint start_inst, uint end_inst,
		bus_mem_2                           global_bias,
		tapa::istream<ConfigInst>          &fifo_config_in,
		// hls::stream<ConvData0Type>       &fifo_gamma_conv_in,
		// hls::stream<ConvData0Type>       &fifo_beta_conv_in,
    tapa::ostream<ConvData0Type>       &fifo_gamma_conv_out,
    tapa::ostream<ConvData0Type>       &fifo_beta_conv_out,
		tapa::ostream<ConfigInst>          &fifo_config_out
){
  cout<<"bias_load"<<endl;
	#pragma HLS INLINE off 
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
		// on-chip buffers
	//  bus_t2 beta_conv_burst_buf_in[IN_NUM_T / BUS_PACK_FACTOR2];
	//  bus_t2 gamma_conv_burst_buf_in[IN_NUM_T / BUS_PACK_FACTOR2];
   bus_t2 beta_conv_burst_buf_out[MAX_OUT_NUM_T / BUS_PACK_FACTOR2];
	 bus_t2 gamma_conv_burst_buf_out[MAX_OUT_NUM_T / BUS_PACK_FACTOR2];

	#if bias_load_MEM == 0
		#pragma HLS bind_storage variable=beta_conv_burst_buf_out type=RAM_T2P impl=BRAM
		#pragma HLS bind_storage variable=gamma_conv_burst_buf_out type=RAM_T2P impl=BRAM
	#elif bias_load_MEM == 1
		#pragma HLS bind_storage variable=beta_conv_burst_buf_out type=RAM_T2P impl=URAM
		#pragma HLS bind_storage variable=gamma_conv_burst_buf_out type=RAM_T2P impl=URAM
	#endif

		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

  	// fifo_config_out.write(inst0);
		// fifo_config_out.write(inst1);
		// fifo_config_out.write(inst2);
		// fifo_config_out.write(inst3);
		// fifo_config_out.write(inst4);
  	// fifo_config_out.write(inst5);

	bool layer_start = 0;
	bool done = 0;
  int count = 0;
		// We assum that cin has been pre-padded with zeros
	while(!done){
		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);
			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

		ap_uint<1>  CONV_1ST_EN           = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN         = LAYER_EN[1];
		ap_uint<1>  CONV_EN               = LAYER_EN[2];
		ap_uint<1>  RELU_EN               = LAYER_EN[3];
		ap_uint<1>  RELU6_EN              = LAYER_EN[4];
		ap_uint<1>  POOL_EN               = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN          = LAYER_EN[6];  	// reserved
    ap_uint<1>  BIAS_EN               = LAYER_EN[7];
		ap_uint<1>  BATCH_NORM_EN         = LAYER_EN[10];
    ap_uint<1>  BATCH_NORM_EN_DEPTH   = LAYER_EN[12];
    ap_uint<1>  RELU_1_EN             = LAYER_EN[13];
    ap_uint<1>  BIAS_1_EN             = LAYER_EN[14];
    ap_uint<1>  BATCH_NORM_1_EN       = LAYER_EN[15];

    	//	//	///inst5	//	//	//	//	//	//	///
		ap_uint<16> LAYER_CONV_TYPE = inst5(32*0+15, 32*0);


	#ifdef DEBUG_config
		cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " << LAYER_OUT_H_HW << " " << LAYER_OUT_W_HW << endl;
		cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
		cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2 << " " << STRIDE << endl;
		cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;
	#endif
	// 	#define DEBUG_weight
			// Set up some configuration signals
    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#in bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
		// bool bias_en_1 = (CONV_EN == 1 && BIAS_1_EN == 1);
		// bool norm_conv_en_1 = (CONV_EN == 1 && BATCH_NORM_1_EN == 1);
		// uint beta_conv_offset_1 = 0;
		// uint gamma_conv_offset_1 = 0;
		// uint bias_offset_1 = BIAS_OFFSET;
    // if (norm_conv_en_1) {
		// 	beta_conv_offset_1 = bias_offset_1;
    //   if(LAYER_IN_NUM_HW<BUS_PACK_FACTOR2)
		// 	  gamma_conv_offset_1 = beta_conv_offset_1 + BUS_PACK_FACTOR2;
    //   else
    //     gamma_conv_offset_1 = beta_conv_offset_1 + LAYER_IN_NUM_HW;	//tweak
		// }
    
    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#out bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
    bool bias_en = (CONV_EN == 1 && BIAS_EN == 1);
    // cout<<"bias_en: "<<bias_en<<endl;
		bool norm_conv_en = (CONV_EN == 1 && BATCH_NORM_EN == 1);  
    uint beta_conv_offset = 0;
		uint gamma_conv_offset = 0;
    uint bias_offset = BIAS_OFFSET;
    // if(LAYER_IN_NUM_HW<BUS_PACK_FACTOR2){
    //   if(BATCH_NORM_1_EN)
    //     bias_offset = BIAS_OFFSET + 2*BUS_PACK_FACTOR2;
    //   else if(BIAS_1_EN)
    //     bias_offset = BUS_PACK_FACTOR2;
    //   else
    //     bias_offset =  BIAS_OFFSET;
    // }else{
    //   if(BATCH_NORM_1_EN)
    //     bias_offset = BIAS_OFFSET + 2*LAYER_IN_NUM_HW;
    //   else if(BIAS_1_EN)
    //     bias_offset = LAYER_IN_NUM_HW;
    //   else
    //     bias_offset =  BIAS_OFFSET;
    // }

    	// cout<<beta_conv_offset<<" "<<gamma_conv_offset<<endl;

    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#in bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
			// Load bias (when batch normalization is not used: final_result = computed_result + bias)
			// Set GAMMAs to zero
		// if (bias_en_1){
		// 		// Only write out in the last iteration
		// 		// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
		// 		uint global_bias_offset_1 = bias_offset_1 + out_num_iter;
    //     for (int i = 0; i < OUT_NUM_T / BUS_PACK_FACTOR2; i++){
    //     	#pragma HLS pipeline
		// 		  gamma_conv_burst_buf_in[i] = 0;
    //     }
		// 		memcpy((void*)beta_conv_burst_buf_in, (void*)&global_bias[global_bias_offset_1 / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_IN_NUM_T);
		// 		// }
		// } else{

    //   		// Load batch normalization info for conv
    //   	if (norm_conv_en_1){
    //   			// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){	//those may need to change
    //   			uint global_beta_offset_1 = beta_conv_offset_1 + in_num_iter;
    //   	#ifdef DEBUG_weight
    //   			cout << global_beta_offset_1 << " beta " << beta_conv_offset_1 << " " <<BUS_PACK_FACTOR2<<endl;
    //   	#endif
    //   			memcpy((void*)beta_conv_burst_buf_in, (void*)&global_bias[global_beta_offset_1 / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_IN_NUM_T);
    //   			// }

    //   			// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){	//those may need to change
    //   			uint global_gamma_offset_1 = gamma_conv_offset_1 + in_num_iter;
    //   	#ifdef DEBUG_weight
    //   			cout << global_gamma_offset_1 << " gamma " << gamma_conv_offset_1 << " " <<BUS_PACK_FACTOR2<<endl;

    //   	#endif
    //   			memcpy((void*)gamma_conv_burst_buf_in, (void*)&global_bias[global_gamma_offset_1 / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_IN_NUM_T);
    //   			// }
    //   	}
    // }
    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#out bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
    if (bias_en){
				// Only write out in the last iteration
			// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
				uint global_bias_offset = bias_offset + out_num_iter;
        for (int i = 0; i < MAX_OUT_NUM_T / BUS_PACK_FACTOR2; i++){
        	#pragma HLS pipeline
				  gamma_conv_burst_buf_out[i] = 0;
        }
				memcpy((void*)beta_conv_burst_buf_out, (void*)&global_bias[global_bias_offset / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_OUT_NUM_T);
			// }
		} //else{

    //   		// Load batch normalization info for conv
    //   	if (norm_conv_en){
    //   		if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
    //   			uint global_bias_offset = beta_conv_offset + out_num_iter;
    //   	#ifdef DEBUG_weight
    //   			cout << global_bias_offset << " beta " << beta_conv_offset << endl;
    //   	#endif
    //   			memcpy((void*)beta_conv_burst_buf_out, (void*)&global_bias[global_bias_offset / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_OUT_NUM_T);
    //   		}
      
    //   		if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
    //   			uint global_bias_offset = gamma_conv_offset + out_num_iter;
    //   	#ifdef DEBUG_weight
    //   			cout << global_bias_offset << " gamma " << gamma_conv_offset << endl;
    //   	#endif
    //   			memcpy((void*)gamma_conv_burst_buf_out, (void*)&global_bias[global_bias_offset / BUS_PACK_FACTOR2], sizeof(data_t2) * LAYER_OUT_NUM_T);
    //   		}
    //   	}
    // }
    	// exit(0);
	#ifdef DEBUG_weight
		cout << "loaded beta and gamma" << endl;
	#endif

		// Load BETAs and GAMMAs to their FIFOs
		// If there doesn't exist a batch normalization and it's a normal bias,
		// beta = bias, gamma = 0
    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#in bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
    // if (bias_en_1) {
		//   weight_load_bias_write(beta_conv_burst_buf_in, fifo_beta_conv_in, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter,1);
    //   weight_load_bias_write(gamma_conv_burst_buf_in, fifo_gamma_conv_in, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter,1);
    // }
		// else if(norm_conv_en_1){
		// 	weight_load_bias_write(beta_conv_burst_buf_in, fifo_beta_conv_in, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter,1);
		// 	weight_load_bias_write(gamma_conv_burst_buf_in, fifo_gamma_conv_in, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter,1);
		// }

    	//	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#out bias load	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#	#
    if (bias_en) {
		  weight_load_bias_write(beta_conv_burst_buf_out, fifo_beta_conv_out, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter, 0);
      weight_load_bias_write(gamma_conv_burst_buf_out, fifo_gamma_conv_out, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter, 0);
    }
		// else if(norm_conv_en){
		// 	weight_load_bias_write(beta_conv_burst_buf_out, fifo_beta_conv_out, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter, 0);
		// 	weight_load_bias_write(gamma_conv_burst_buf_out, fifo_gamma_conv_out, inst0, inst1, inst2, inst3, in_num_iter, out_num_iter, 0);
		// }

	#ifdef DEBUG_weight
		cout << in_num_iter << " in num iter " << endl;
	#endif
			// Repeat until all the tiles are read
			// Then, have to repeat reading to calculate all LAYER_OUT_NUM output feature maps
		// in_num_iter += LAYER_IN_NUM_T;
		// if (in_num_iter >= LAYER_IN_NUM){
		// 	in_num_iter = 0;
			in_h_iter += LAYER_IN_H_T;
			if (in_h_iter >= LAYER_IN_H){
				in_h_iter = 0;
				in_w_iter += LAYER_IN_W_T;
				if (in_w_iter >= LAYER_IN_W){
					in_w_iter = 0;
					out_num_iter += LAYER_OUT_NUM_T;
					if (out_num_iter >= LAYER_OUT_NUM){
						out_num_iter = 0;
						layer_iter += 1;
						layer_start = 1;
						if (layer_iter == LAYER_BATCH){
							layer_iter = 0;
							done = 1;
						}
					}
				}
			}
		// }
	}
  inst++;
  if(inst == inst_count){
    inst_done = 1;
  }
  }
}/*
 * Function name: cin_load_fifo_write_prev
 * Function description: This function writes cin data to the downstream modules.
 * It has the same functionality as cin_load_fifo_write
 */
void cin_load_fifo_write_prev(
		bus_t0                         cin_burst_buf[],
		tapa::ostream<CinLoadData0Type>  &fifo_cin,
		uint                           LAYER_IN_NUM_T,
		uint                           LAYER_IN_H_T,
		uint                           LAYER_IN_W_T,
		uint                           FILTER_S,
    bool                           pad_en
){
	int ii = 0;
	int hh = 0;
	int ww = 0;
	bool done = 0;
	while(!done){
	#pragma HLS PIPELINE II=1
	// Data layout of the buffer: Th * Tw * Tn
		uint local_cin_idx = hh * (LAYER_IN_W_T + FILTER_S - 1) * LAYER_IN_NUM_T + ww * LAYER_IN_NUM_T + ii * DEPTH_CONV_LANE;
		uint bus_cin_idx = local_cin_idx / BUS_PACK_FACTOR0;
		uint bus_cin_offset = local_cin_idx % BUS_PACK_FACTOR0;
		bus_t0 bus_cin_data = pad_en? (bus_t0) 0 : cin_burst_buf[bus_cin_idx];
		CinLoadData0Type fifo_cin_data;

	// DATA_SEL_FACTOR = BUS_PACK_FACTOR / SIMD_LANE
	// BUS_PACK_FACTOR is the number of elements packed in one to enable memory coalescing
	// Since each entry is FIFOs will be SIMD_LANE elements of the data, we should unpack based on SIMD_LANE
	#if DATA_SEL_FACTOR0 == 1
		fifo_cin_data = bus_cin_data;
	#elif DATA_SEL_FACTOR0 == 2 
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 4
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 8
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		case 4:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 5 - 1, DATA_W0 * DEPTH_CONV_LANE * 4);
			break;
		case 5:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 6 - 1, DATA_W0 * DEPTH_CONV_LANE * 5);
			break;
		case 6:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 7 - 1, DATA_W0 * DEPTH_CONV_LANE * 6);
			break;
		case 7:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 8 - 1, DATA_W0 * DEPTH_CONV_LANE * 7);
			break;
		}
	#elif DATA_SEL_FACTOR0 == 16
		switch(bus_cin_offset / DEPTH_CONV_LANE){
		case 0:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 1 - 1, DATA_W0 * DEPTH_CONV_LANE * 0);
			break;
		case 1:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 2 - 1, DATA_W0 * DEPTH_CONV_LANE * 1);
			break;
		case 2:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 3 - 1, DATA_W0 * DEPTH_CONV_LANE * 2);
			break;
		case 3:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 4 - 1, DATA_W0 * DEPTH_CONV_LANE * 3);
			break;
		case 4:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 5 - 1, DATA_W0 * DEPTH_CONV_LANE * 4);
			break;
		case 5:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 6 - 1, DATA_W0 * DEPTH_CONV_LANE * 5);
			break;
		case 6:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 7 - 1, DATA_W0 * DEPTH_CONV_LANE * 6);
			break;
		case 7:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 8 - 1, DATA_W0 * DEPTH_CONV_LANE * 7);
			break;
		case 8:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 9 - 1, DATA_W0 * DEPTH_CONV_LANE * 8);
			break;
		case 9:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 10 - 1, DATA_W0 * DEPTH_CONV_LANE * 9);
			break;
		case 10:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 11 - 1, DATA_W0 * DEPTH_CONV_LANE * 10);
			break;
		case 11:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 12 - 1, DATA_W0 * DEPTH_CONV_LANE * 11);
			break;
		case 12:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 13 - 1, DATA_W0 * DEPTH_CONV_LANE * 12);
			break;
		case 13:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 14 - 1, DATA_W0 * DEPTH_CONV_LANE * 13);
			break;
		case 14:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 15 - 1, DATA_W0 * DEPTH_CONV_LANE * 14);
			break;
		case 15:
			fifo_cin_data = bus_cin_data(DATA_W0 * DEPTH_CONV_LANE * 16 - 1, DATA_W0 * DEPTH_CONV_LANE * 15);
			break;
		}
	#endif            
		fifo_cin.write(fifo_cin_data);
	#ifdef DEBUG_load_prev
		for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL
			ap_uint<DATA_W0> u32_beta = fifo_cin_data(DATA_W0 - 1, 0);
			data_t2 a = Reinterpret<data_t2>(u32_beta);
			fifo_cin_data = fifo_cin_data >> DATA_W0;
			cout << a << " ";
		}
		cout << endl;
	#endif
		
			// Repeat until the whole tile is read
		ww++;
		if (ww == LAYER_IN_W_T + FILTER_S - 1){
			ww = 0;
			hh++;
			if (hh == LAYER_IN_H_T + FILTER_S - 1){
				hh = 0;
				ii++;
				if (ii == LAYER_IN_NUM_T / DEPTH_CONV_LANE){
					ii = 0;
					done = 1;
				}
			}
		}
	}
}

void cin_load_prev(
    uint start_inst, uint end_inst,
		bus_mem_0                      global_cin,
		tapa::istream<ConfigInst>        &fifo_config_in,
		tapa::ostream<CinLoadData0Type>  &fifo_cin_prev,
		tapa::ostream<ConfigInst>        &fifo_config_out
){
  cout<<"cin_load_prev"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
	#pragma HLS INLINE off 
		// on-chip buffer for cin data
	bus_t0 prev_cin_burst_buf_ping[CIN_PREV_BUFF / BUS_PACK_FACTOR0];
	bus_t0 prev_cin_burst_buf_pong[CIN_PREV_BUFF / BUS_PACK_FACTOR0];
	#if cin_load_prev_MEM == 0
		#pragma HLS bind_storage variable=prev_cin_burst_buf_ping type=RAM_T2P impl=BRAM
		#pragma HLS bind_storage variable=prev_cin_burst_buf_pong type=RAM_T2P impl=BRAM  
	#elif cin_load_prev_MEM == 1
		#pragma HLS bind_storage variable=prev_cin_burst_buf_ping type=RAM_T2P impl=URAM
		#pragma HLS bind_storage variable=prev_cin_burst_buf_pong type=RAM_T2P impl=URAM  
	#endif


		// tiling iterators
	// uint in_num_iter = 0;
	// uint out_num_iter = 0;
  uint num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;
  bool pad_en = 0;

	// uint in_num_iter_prev = 0;
	// uint out_num_iter_prev = 0;
  uint num_iter_prev = 0;
	uint in_h_iter_prev = 0;
	uint in_w_iter_prev = 0;
	uint layer_iter_prev = 0;
  bool pad_en_prev = 0;


	uint LAYER_NUM_T_prev;
	// uint LAYER_OUT_NUM_T_prev;
	uint LAYER_IN_H_T_prev;
	uint LAYER_IN_W_T_prev;
	uint FILTER_prev;

	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);
	ap_uint<1>  LOAD_PREV_CIN = 0;


	uint task_cnt = 0;
	bool layer_start = 0;
	bool layer_start_prev = 0;
	bool done = 0;
		// We assum that cin has been pre-padded with zeros
	uint prev = 0;
	uint init = 1;
	uint num_tile = 0;
  uint channel_iter = 0;
  uint inter_tile = 0;
	bool write_last_cin = 0;
	bool write_last_prev_cin = 0;
	bool start_prev = 0;
	bool done_prev = 0;
	bool change_layout = 0;
		//uint prev_iter = 0;
	while(!done_prev){

		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
			inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);
			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		// ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		// ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		// ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);


    	// ap_uint<16> LAYER_CONV_TYPE 		= inst5(32*0+15, 32*0);
    	// ap_uint<32> KH              		= inst5(32*5+31, 32*4+16);
    ap_uint<16> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);
    ap_uint<32> LAYER_IN_H_T    		= inst3(32*3+31, 32*3)*LAYER_TCONV_STRIDE;
		ap_uint<32> LAYER_IN_W_T    		= inst3(32*4+31, 32*4)*LAYER_TCONV_STRIDE;

    ap_uint<16> POOL_NUM 					  = inst5(32*5+16, 32*5);
    ap_uint<16> POOL_NUM_HW 				= inst5(32*5+31, 32*5+16);


		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  INTER_LOAD_EN  = LAYER_EN[8];
		ap_uint<1>  INTER_WRITE_EN = LAYER_EN[9];
		ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
    ap_uint<1>  ADD_EN         = LAYER_EN[17];
		LOAD_PREV_CIN  = LAYER_EN[11];

    LAYER_IN_W = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_W<<1) :  (ap_uint<32>) LAYER_IN_W;
    LAYER_IN_H = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_H<<1) :  (ap_uint<32>) LAYER_IN_H;
    LAYER_IN_W_T = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_W_T<<1) :  (ap_uint<32>) LAYER_IN_W_T;
    LAYER_IN_H_T = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_H_T<<1) :  (ap_uint<32>) LAYER_IN_H_T;
    ap_uint<32> LAYER_NUM_T = ADD_EN? LAYER_OUT_NUM_T : LAYER_IN_NUM_T;

	// #ifdef DEBUG_config_cin
	// 	cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " << LAYER_OUT_H_HW << " " << LAYER_OUT_W_HW << endl;
	// 	cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
	// 	cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2 << " " << STRIDE << endl;
	// 	cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;

	// #endif


			// offsets
		uint cin_offset = CIN_OFFSET;
		uint prev_cin_offset = PREV_CIN_OFFSET;
    	// ap_uint<4>  FILTER = (LAYER_CONV_TYPE == 1)? (ap_uint<4>)(KH_KW>>28) : (ap_uint<4>) FILTER_S2;

		if (prev == 1) start_prev = 1;

			// set up some configuration signals
		ap_uint<8> FILTER = 1;//(DEPTH_CONV_EN == 1)? (uint)FILTER_S1: ((CONV_EN == 1)? (uint)FILTER_S2: 1);
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		change_layout = 1;//(((LAYER_OUT_W_HW == LAYER_OUT_W) || (LAYER_OUT_W_HW == LAYER_IN_W_T)) && ((LAYER_OUT_H_HW == LAYER_OUT_H) || (LAYER_OUT_H_HW == LAYER_IN_H_T))); 	// if next filter = 1 : change the layout to num_tile, h_t, w_t, in_t
		uint layer_out_h = LAYER_IN_H;//(LAYER_IN_H_T > LAYER_OUT_H) ? LAYER_IN_H_T : LAYER_OUT_H;
		uint layer_out_w = LAYER_IN_W;//(LAYER_IN_W_T > LAYER_OUT_W) ? LAYER_IN_W_T : LAYER_OUT_W;

    pad_en = (num_iter_prev >= POOL_NUM); 
		if (INTER_LOAD_EN == 0){
			// if (((max_pool || UP_SAMPLE_EN) && out_num_iter_prev == 0) || separable_conv || conv2d){
				if (task_cnt == 0){
						// First load previous cin
						// Load only if the enable signal for this module is on
					if(LOAD_PREV_CIN == 1 && !pad_en){
						cin_load_ddr_read(global_cin, prev_cin_burst_buf_ping, layer_out_h, layer_out_w, LAYER_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER, FILTER, FILTER, FILTER, 1, prev_cin_offset, num_iter_prev, in_h_iter_prev, in_w_iter_prev, num_tile, change_layout, max_pool, 1);
            // cout<<"prev_cin_burst_buf_ping: "<<pad_en<<endl;
            // print<256>(prev_cin_burst_buf_ping[0]);
          } 
				} else {
						// Apply double buffering for reading the data and filling the FIFO
						// Load only if the enable signal for this module is on
					if(LOAD_PREV_CIN == 1){
						if (task_cnt % 2 == 1){
              if(!pad_en){
							  cin_load_ddr_read(global_cin, prev_cin_burst_buf_pong, layer_out_h, layer_out_w, LAYER_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER, FILTER, FILTER, FILTER, 1, prev_cin_offset, num_iter_prev, in_h_iter_prev, in_w_iter_prev, num_tile, change_layout, max_pool, 1);
              }
              cin_load_fifo_write_prev(prev_cin_burst_buf_ping, fifo_cin_prev, LAYER_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, 1, pad_en_prev);
              // cout<<"cin_load_fifo_write_prev: "<<pad_en_prev<<endl;
              // print<256>(fifo_cin_prev.read());
						} else {
							if(!pad_en){
                cin_load_ddr_read(global_cin, prev_cin_burst_buf_ping, layer_out_h, layer_out_w, LAYER_NUM_T, LAYER_IN_H_T, LAYER_IN_W_T, FILTER, FILTER, FILTER, FILTER, 1, prev_cin_offset, num_iter_prev, in_h_iter_prev, in_w_iter_prev, num_tile, change_layout, max_pool, 1);
              }
              cin_load_fifo_write_prev(prev_cin_burst_buf_pong, fifo_cin_prev, LAYER_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, 1, pad_en_prev);
						}
					} 
				}

				task_cnt++;
        	// cout<<task_cnt<<endl;
				// LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
				// LAYER_OUT_NUM_T_prev = LAYER_OUT_NUM_T;
        LAYER_NUM_T_prev = LAYER_NUM_T;
				LAYER_IN_H_T_prev = LAYER_IN_H_T;
				LAYER_IN_W_T_prev = LAYER_IN_W_T;
        pad_en_prev = pad_en;
					// FILTER_prev = FILTER;
			// }
		}

			// Continue until all tiles are read
			// No need to read tiles multiple times 
			// since it's only read to add them to the result of this layer
		// num_tile++;
    // cout<<"in_num_iter_prev: "<<in_num_iter_prev<<" pad_en: "<<pad_en<<" num_tile: "<<num_tile<<endl;
    // in_num_iter_prev += LAYER_IN_NUM_T;
		// if (in_num_iter_prev < POOL_NUM_HW){ //not sure if this should be POOL_NUM or POOL_NUM_HW
		// 	channel_iter += ((LAYER_IN_W / LAYER_IN_W_T) * (LAYER_IN_H / LAYER_IN_H_T));
		// } else {
		// 	channel_iter = 0;
		// 	inter_tile++;
		// }
		num_tile++;// = channel_iter + inter_tile;

			// channel_iter = 0;
    in_h_iter_prev += LAYER_IN_H_T;
    if (in_h_iter_prev >= LAYER_IN_H){
      in_h_iter_prev = 0;
      in_w_iter_prev += LAYER_IN_W_T;
      if (in_w_iter_prev >= LAYER_IN_W){
        in_w_iter_prev = 0;
        // inter_tile = 0;
        // channel_iter = 0;
        num_iter_prev += LAYER_NUM_T;
        if (num_iter_prev >= POOL_NUM_HW){
          num_iter_prev = 0;
          layer_iter_prev += 1;
          layer_start_prev = 1;
          if (layer_iter_prev == LAYER_BATCH){
            layer_iter_prev = 0;
            num_iter_prev = 0;
            in_h_iter_prev = 0;
            in_w_iter_prev = 0;
            done_prev = 1;
					}
				}
			}
		}
	}
	
	if (LOAD_PREV_CIN){
			// Load the last tile to its FIFO
		if (task_cnt % 2 == 1){
			cin_load_fifo_write_prev(prev_cin_burst_buf_ping, fifo_cin_prev, LAYER_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, 1, pad_en_prev);
		} else {
			cin_load_fifo_write_prev(prev_cin_burst_buf_pong, fifo_cin_prev, LAYER_NUM_T_prev, LAYER_IN_H_T_prev, LAYER_IN_W_T_prev, 1, pad_en_prev);
		}
	}
  inst++; 
  if(inst == inst_count){
    inst_done = 1;
  }
  }

}/**
 * Function name: pool
 * Function description: This functions performs max-pooling operation.
 */
void pool(
    uint start_inst, uint end_inst,
		tapa::istream<ReluData0Type>  &fifo_cin,
		tapa::istream<ConfigInst>     &fifo_config_in,
		tapa::ostream<PoolData0Type>  &fifo_cout,
		tapa::ostream<ConfigInst>     &fifo_config_out
){
  cout<<"pool"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
  uint num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

	bool layer_start = 0;
	bool done = 0;
	while(!done){

		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
	    fifo_config_out.write(inst5);

			layer_start = 0;
		}
		
			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

    ap_uint<32> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);
    ap_uint<16> POOL_NUM 					  = inst5(32*5+16, 32*5);
    ap_uint<16> POOL_NUM_HW 				= inst5(32*5+31, 32*5+16);

		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  LOAD_PREV_CIN  = LAYER_EN[11];
		ap_uint<1>  ADD_EN          = LAYER_EN[17];
    LAYER_IN_W = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_W<<1) :  (ap_uint<32>) LAYER_IN_W;
    LAYER_IN_H = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_H<<1) :  (ap_uint<32>) LAYER_IN_H;
    LAYER_IN_W_T = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_W_T<<1) :  (ap_uint<32>) LAYER_IN_W_T;
    LAYER_IN_H_T = ADD_EN && POOL_EN? (ap_uint<32>) (LAYER_IN_H_T<<1) :  (ap_uint<32>) LAYER_IN_H_T;
    ap_uint<32> LAYER_NUM_T = ADD_EN? LAYER_OUT_NUM_T : LAYER_IN_NUM_T;
    STRIDE = ADD_EN && POOL_EN? (ap_uint<32>) 2 :  (ap_uint<32>) STRIDE;
			// Set up some configuration signals
		bool en = POOL_EN;
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
    if(LOAD_PREV_CIN == 1){
		switch(en){
			// bypass this module
		case 0:{
			// if ((UP_SAMPLE_EN && out_num_iter == 0) || (!UP_SAMPLE_EN && in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM)){
				int o = 0;
				int h = 0;
				int w = 0;
				bool done1 = 0;

				int w_bound = (LAYER_IN_W_T / STRIDE)*LAYER_TCONV_STRIDE;
				int h_bound = (LAYER_IN_H_T / STRIDE)*LAYER_TCONV_STRIDE;

				while(!done1){
	#pragma HLS PIPELINE II=1
					PoolData0Type tmp = fifo_cin.read();
					fifo_cout.write(tmp);
					
						// Repeat until the whole tile is read
					w++;
					if (w == w_bound){
						w = 0;
						h++;
						if (h == h_bound){
							h = 0;
							o++;
							if (o == LAYER_NUM_T / POOL_LANE){
								o = 0;
								done1 = 1;
							}
						}
					}
				}
			}
			break;
			// compute
		case 1:
			{
				int o = 0;
				int h = 0;
				int w = 0;
				bool done1 = 0;

				int w_bound = LAYER_IN_W_T;
				int h_bound = LAYER_IN_H_T;
        PoolData0Type line_buf_w_curr[MAX_IN_W_T];
        PoolData0Type line_buf_w_next[MAX_IN_W_T];

        data_t0 pixel_1 = 0;
        data_t0 pixel_2 = 0;
        data_t0 pixel_3 = 0;
        data_t0 pixel_4 = 0;
        PoolData0Type max_buff;

        PoolData0Type line_buf_h;
				pool2 : while(!done1){
          #pragma HLS PIPELINE II=1
          if(h==0){
            line_buf_w_curr[w] = fifo_cin.read();
          }else{
            PoolData0Type tmp = fifo_cin.read();
            line_buf_w_next[w] = tmp;
            if(w%STRIDE == 0){
              line_buf_h = tmp;
            }
            if(h%STRIDE == 0){
              line_buf_w_curr[w] = line_buf_w_next[w];
            }
            if(w%STRIDE == 1 && h%STRIDE == 1){
              pool3 : for(int i=0; i<POOL_LANE; i++){
                #pragma HLS UNROLL
                // pixel 1
                pixel_1 = Reinterpret<data_t0>((ap_uint<DATA_W0>) line_buf_w_curr[w-1]((i+1)*DATA_W0-1, i*DATA_W0));
                // pixel 2
                pixel_2 = Reinterpret<data_t0>((ap_uint<DATA_W0>) line_buf_w_curr[w]((i+1)*DATA_W0-1, i*DATA_W0));
                // pixel 3
                pixel_3 = Reinterpret<data_t0>((ap_uint<DATA_W0>) line_buf_h((i+1)*DATA_W0-1, i*DATA_W0));
                // pixel 4
                pixel_4 = Reinterpret<data_t0>((ap_uint<DATA_W0>) tmp((i+1)*DATA_W0-1, i*DATA_W0));
                // max
                data_t0 val_1 = max(pixel_1, pixel_2);
                data_t0 val_2 = max(pixel_3, pixel_4);
                data_t0 val_3 = max(val_1, val_2);
                max_buff((i+1)*DATA_W0-1, i*DATA_W0) = Reinterpret<ap_uint<DATA_W0> >(val_3);
              }
              fifo_cout.write(max_buff);
            }
          }
          // Repeat until the whole tile is read
					w++;
					if (w == w_bound){
						w = 0;
						h++;
						if (h == h_bound){
							h = 0;
							o++;
							if (o == LAYER_NUM_T / POOL_LANE){
								o = 0;
								done1 = 1;
							}
						}
					}
				}
			}
			break;
		}
		}
		
			// Repeat until all the tiles are read
			// Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
		// in_num_iter += LAYER_IN_NUM_T;
		// if (in_num_iter >= POOL_NUM_HW){
		// 	in_num_iter = 0;
      // not sure if out or in iters to be used
    in_h_iter += LAYER_IN_H_T;
    if (in_h_iter >= LAYER_IN_H){
      in_h_iter = 0;
      in_w_iter += LAYER_IN_W_T;
      if (in_w_iter >= LAYER_IN_W){
        in_w_iter = 0;
        num_iter += LAYER_NUM_T;
        if (num_iter >= POOL_NUM_HW){
          num_iter = 0;
          layer_iter += 1;
          layer_start = 1;
          if (layer_iter == LAYER_BATCH){
            layer_iter = 0;
            done = 1;
          }
        }
      }
    }
		// }
	}
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}void upsample(
    uint start_inst, uint end_inst,
  	tapa::istream<ReluData0Type>  &fifo_cin,
		tapa::istream<ConfigInst>     &fifo_config_in,
		tapa::ostream<PoolData0Type>  &fifo_cout,
		tapa::ostream<ConfigInst>     &fifo_config_out
){
 #pragma HLS INLINE off
  cout<<"upsample"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);


	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

	bool layer_start = 0;
	bool done = 0;
  ConvData0Type line_buf[MAX_IN_W_T];

	while(!done){
		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);

			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

    ap_uint<16> LAYER_CONV_TYPE 		= inst5(32*0+15, 32*0);
    ap_uint<16> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);

		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
		ap_uint<1>  LOAD_PREV_CIN  = LAYER_EN[11];
    ap_uint<1>  BATCH_NORM_EN_DEPTH  = LAYER_EN[12];


			// Set up some configuration signals
		uint upsample_factor = 2;
    uint en = UP_SAMPLE_EN;
	#ifdef DEBUG
		uint relu_cout_cnt = 0;
		ofstream relu_data;
		relu_data.open("relu_patch.dat", ios::app);
	#endif
		switch(en){
      case 0:
      {
        // bypass this module
        // if (((max_pool || UP_SAMPLE_EN) && out_num_iter == 0) || (!max_pool && (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM))){
        int o = 0;
        int h = 0;
        int w = 0;
        bool done1 = 0;

        int w_bound = (LAYER_IN_W_T / STRIDE)*LAYER_TCONV_STRIDE;
        int h_bound = (LAYER_IN_H_T / STRIDE)*LAYER_TCONV_STRIDE;
        while(!done1){
          #pragma HLS PIPELINE II=1
          ConvData0Type tmp = fifo_cin.read();
          fifo_cout.write(tmp);

            // Repeat until the whole tile is read
          w++;
          if (w == w_bound){
            w = 0;
            h++;
            if (h == h_bound){
              h = 0;
              o++;
              if (o == LAYER_OUT_NUM_T / RELU_LANE){
                o = 0;
                done1 = 1;
              }
            }
          }
        }
      }
      break;
        // compute
      case 1:
      {
        int o = 0;
        int h = 0;
        int w = 0;
        int up = 0;
        bool done2 = 0;
        
        int w_bound = (LAYER_IN_W_T / STRIDE)*LAYER_TCONV_STRIDE;
        int h_bound = (LAYER_IN_H_T / STRIDE)*LAYER_TCONV_STRIDE;
        int up_bound = upsample_factor;
        while(!done2){
          
          if (up==0){
            line_buf[w] = fifo_cin.read();
          }
          for(int i=0; i<up_bound; i++){
            #pragma HLS PIPELINE II=1
            fifo_cout.write(line_buf[w]);
          }
          // fifo_cout.write(line_buf[w]);
          // Repeat until the whole tile is read
          w++;
          if (w == w_bound){
            w = 0;
            up++;
            if (up == up_bound){
              up = 0;
              h++;
              if (h == h_bound){
                h = 0;
                o++;
                if (o == LAYER_OUT_NUM_T / RELU_LANE){
                  o = 0;
                  done2 = 1;
                }
              }
            }
          }
        }
      }
      break;
		}

    // Repeat until all the tiles are read
    // Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
    in_h_iter += LAYER_IN_H_T;
    if (in_h_iter >= LAYER_IN_H){
      in_h_iter = 0;
      in_w_iter += LAYER_IN_W_T;
      if (in_w_iter >= LAYER_IN_W){
        in_w_iter = 0;
        out_num_iter += LAYER_OUT_NUM_T;
        if (out_num_iter >= LAYER_OUT_NUM){
          out_num_iter = 0;
          layer_iter += 1;
          layer_start = 1;
          if (layer_iter == LAYER_BATCH){
            layer_iter = 0;
            done = 1;
          }
        }
      }
    }
  }
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
	
}/**
 * Function name: add
 * Function description: This functions add the input of previous layer to result of this layer.
 *                       It helps supporting building blocks such as residual bottleneck layer in MobileNetV2
 */
void concat(
    uint start_inst, uint end_inst,
		tapa::istream<ConvData0Type>        &fifo_cin,
		tapa::istream<ConvData0Type>        &fifo_conv,
		tapa::istream<ConfigInst>           &fifo_config_in,
		tapa::ostream<ConvData0Type>        &fifo_cout_0,
    tapa::ostream<ConvData0Type>        &fifo_cout_1,
		tapa::ostream<ConfigInst>           &fifo_config_out
){
  cout<<"concat"<<endl;
	#pragma HLS INLINE off
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
  	// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

  int count = 0;
	bool layer_start = 0;
	bool done = 0;
	while(!done){
    
		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);

			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

    ap_uint<16> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);
		
		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  LOAD_PREV_CIN  = LAYER_EN[11];
    ap_uint<1>  CONCAT_EN      = LAYER_EN[16];

	#ifdef DEBUG_config_add
		cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " << LAYER_OUT_H_HW << " " << LAYER_OUT_W_HW << endl;
		cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
		cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2 << " " << STRIDE << endl;
		cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;
	#endif

		data_t0 cin_buf[CONV_LANE];
		data_t0 conv_buf_0[CONV_LANE];
    data_t0 conv_buf_1[CONV_LANE];
		ap_uint<DATA_W0> cout_buf[CONV_LANE];
	#pragma HLS ARRAY_PARTITION variable=cin_buf complete
	#pragma HLS ARRAY_PARTITION variable=conv_buf_0 complete
	#pragma HLS ARRAY_PARTITION variable=conv_buf_1 complete
	#pragma HLS ARRAY_PARTITION variable=cout_buf complete

			// Set up some configuration signals
		uint FILTER_S = 1;
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		uint stride = (max_pool == 1)? 1 : (uint)STRIDE;
    uint upsample_factor = (UP_SAMPLE_EN == 1)? 2 : 1;
		bool en = CONCAT_EN;

	#ifdef DEBUG
		uint relu_cout_cnt = 0;
		ofstream relu_data;
		relu_data.open("relu_patch.dat", ios::app);
	#endif
		switch(en){
		case 0:{
				// bypass this module
      // cout<<(((max_pool || UP_SAMPLE_EN) && out_num_iter == 0) || (!max_pool && (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM)))<<endl;
			// if (((max_pool || UP_SAMPLE_EN) && out_num_iter == 0) || (!max_pool && (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM))){
				int o = 0;
				int h = 0;
				int w = 0;
				bool done1 = 0;
        
					// int w_bound = LAYER_IN_W_T / stride + FILTER_S - 1;
					// int h_bound = LAYER_IN_H_T / stride + FILTER_S - 1;
        int w_bound = (LAYER_IN_W_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
				int h_bound = (LAYER_IN_H_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
        // cout<<"w_bound: "<<w_bound<<" h_bound: "<<h_bound<<endl;
        	
				while(!done1){
	#pragma HLS PIPELINE II=1
					// if(!fifo_conv.empty()){
            fifo_cout_1.write(fifo_conv.read());
            ConvData0Type tmp_cin = 0;
            if (LOAD_PREV_CIN){
              fifo_cout_0.write(fifo_cin.read());
            }
            // Repeat until the whole tile is read
						w++;
						if (w == w_bound){
							w = 0;
							h++;
							if (h == h_bound){
								h = 0;
								o++;
								if (o == LAYER_OUT_NUM_T / CONV_LANE){
									o = 0;
									done1 = 1;
								}
							}
						}
					// }
				}
			}
			break;
			// compute
		case 1:
		{
				int o = 0;
				int h = 0;
				int w = 0;
				bool done2 = 0;

        int w_bound = (LAYER_IN_W_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE;
				int h_bound = (LAYER_IN_H_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE;

				while(!done2){
	#pragma HLS PIPELINE II=1
          // cout<<(!fifo_cin.empty() && !fifo_conv.empty())<<" "<<(!fifo_cin.empty())<<" "<<(!fifo_conv.empty())<<endl;
					// if(!fifo_cin.empty() && !fifo_conv.empty()){
							// Read the result of this layer and the previous cin
            ConvData0Type cin_tmp = 0;
            ConvData0Type conv_tmp_0 = 0;
            ConvData0Type conv_tmp_1 = 0;
            #if SIMD_LANE == 8
              if (o == 1){
                cin_tmp = fifo_cin.read();
                conv_tmp_1 = fifo_conv.read();
                for (int lane = 0; lane < CONV_LANE; lane++){
                  #pragma HLS UNROLL
                  ap_uint<DATA_W0> u32_tmp = cin_tmp(DATA_W0 - 1, 0);
                  cin_buf[lane] = Reinterpret<data_t0>(u32_tmp);
                  cin_tmp = cin_tmp >> DATA_W0;
                }
                for (int lane = 0; lane < CONV_LANE; lane++){
                  #pragma HLS UNROLL
                  ap_uint<DATA_W0> u32_tmp = conv_tmp_1(DATA_W0 - 1, 0);
                  conv_buf_1[lane] = Reinterpret<data_t0>(u32_tmp);
                  conv_tmp_1 = conv_tmp_1 >> DATA_W0;
                }
                cout_buf[0] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[0]);
                cout_buf[1] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[1]);
                cout_buf[2] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[2]);
                cout_buf[3] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[3]);
                cout_buf[4] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[4]);
                cout_buf[5] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[0]);
                cout_buf[6] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[1]);
                cout_buf[7] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[2]);
              }else{
                conv_tmp_0 = fifo_conv.read();
                for (int lane = 0; lane < CONV_LANE; lane++){
                  #pragma HLS UNROLL
                  ap_uint<DATA_W0> u32_tmp = conv_tmp_0(DATA_W0 - 1, 0);
                  conv_buf_0[lane] = Reinterpret<data_t0>(u32_tmp);
                  cout_buf[lane] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_0[lane]);
                  conv_tmp_0 = conv_tmp_0 >> DATA_W0;
                }
              }
						#endif
            #if SIMD_LANE == 16
              cin_tmp = fifo_cin.read();
              conv_tmp_1 = fifo_conv.read();
              for (int lane = 0; lane < CONV_LANE; lane++){
                #pragma HLS UNROLL
                ap_uint<DATA_W0> u32_tmp = cin_tmp(DATA_W0 - 1, 0);
                cin_buf[lane] = Reinterpret<data_t0>(u32_tmp);
                cin_tmp = cin_tmp >> DATA_W0;
              }
              for (int lane = 0; lane < CONV_LANE; lane++){
                #pragma HLS UNROLL
                ap_uint<DATA_W0> u32_tmp = conv_tmp_1(DATA_W0 - 1, 0);
                conv_buf_1[lane] = Reinterpret<data_t0>(u32_tmp);
                conv_tmp_1 = conv_tmp_1 >> DATA_W0;
              }
              cout_buf[0] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[0]);
              cout_buf[1] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[1]);
              cout_buf[2] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[2]);
              cout_buf[3] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[3]);
              cout_buf[4] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[4]);
              cout_buf[5] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[5]);
              cout_buf[6] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[6]);
              cout_buf[7] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[7]);
              cout_buf[8] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[8]);
              cout_buf[9] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[9]);
              cout_buf[10] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[10]);
              cout_buf[11] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[11]);
              cout_buf[12] = Reinterpret<ap_uint<DATA_W0> >(conv_buf_1[12]);
              cout_buf[13] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[0]);
              cout_buf[14] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[1]);
              cout_buf[15] = Reinterpret<ap_uint<DATA_W0> >(cin_buf[2]);
            #endif


							// write out
							// Pack the data according to SIMD_LANE
						ReluData0Type wide_tmp = (
	#if RELU_LANE == 16
								cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
								cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
								cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
								cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 8
																				cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
																				cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 4
																																cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 2              
																																												cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 1
																																																	  cout_buf[0]
	#endif                
						);
						fifo_cout_1.write(wide_tmp);

							// Repeat until the whole tile is read
						w++;
						if (w == w_bound){
							w = 0;
							h++;
							if (h == h_bound){
								h = 0;
								o++;
								if (o == LAYER_OUT_NUM_T / RELU_LANE){
									o = 0;
									done2 = 1;
								}
							}
						}
					// }
				}
			
			break;
		}
		}
    // cout<<count++<<endl;
			// Repeat until all the tiles are read
			// Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
    in_h_iter += LAYER_IN_H_T;
    if (in_h_iter >= LAYER_IN_H){
      in_h_iter = 0;
      in_w_iter += LAYER_IN_W_T;
      if (in_w_iter >= LAYER_IN_W){
        in_w_iter = 0;
        out_num_iter += LAYER_OUT_NUM_T;
        if (out_num_iter >= LAYER_OUT_NUM){
          out_num_iter = 0;
          layer_iter += 1;
          layer_start = 1;
          if (layer_iter == LAYER_BATCH){
            layer_iter = 0;
            done = 1;
          }
        }
      }
    }
	}
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
  // int fifo_conv_count = 0;
  // int fifo_cin_count = 0;
  // while(!fifo_conv.empty()){
  //   fifo_conv.read();
  //   fifo_conv_count++;
  // }
  // while(!fifo_cin.empty()){
  //   fifo_cin.read();
  //   fifo_cin_count++;
  // }
  // cout<<"fifo_conv_count: "<<fifo_conv_count<<endl;
  // cout<<"fifo_cin_count: "<<fifo_cin_count<<endl;
}
/**
 * Function name: add
 * Function description: This functions add the input of previous layer to result of this layer.
 *                       It helps supporting building blocks such as residual bottleneck layer in MobileNetV2
 */
void add(
    uint start_inst, uint end_inst,
		tapa::istream<ConvData0Type>        &fifo_cin,
		tapa::istream<ConvData0Type>        &fifo_conv,
		tapa::istream<ConfigInst>           &fifo_config_in,
		tapa::ostream<ConvData0Type>        &fifo_cout,
		tapa::ostream<ConfigInst>           &fifo_config_out
){
  float cin_prev_sum = 0;
  float conv_sum = 0;
  cout<<"add"<<endl;
	#pragma HLS INLINE off
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);
  int count = 0;

	bool layer_start = 0;
	bool done = 0;
	while(!done){
    
		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);

			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

    ap_uint<16> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);
		
		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  LOAD_PREV_CIN  = LAYER_EN[11];
    ap_uint<1>  ADD_EN         = LAYER_EN[17];

	#ifdef DEBUG_config_add
		cout << LAYER_IN_NUM_HW << " " << LAYER_OUT_NUM_HW << " " << LAYER_IN_H_HW << " " << LAYER_IN_W_HW << " " << LAYER_OUT_H_HW << " " << LAYER_OUT_W_HW << endl;
		cout << LAYER_IN_NUM << " " << LAYER_OUT_NUM << " " << LAYER_IN_H << " " << LAYER_IN_W << " " << LAYER_OUT_H << " " << LAYER_OUT_W << endl;
		cout << CIN_OFFSET << " " << WEIGHT_OFFSET << " " << BIAS_OFFSET << " " << COUT_OFFSET << " " << FILTER_S1 << " " << FILTER_S2 << " " << STRIDE << endl;
		cout << LAYER_EN << " " << PREV_CIN_OFFSET << " " << LAYER_IN_NUM_T << " " << LAYER_OUT_NUM_T << " " << LAYER_IN_H_T << " " << LAYER_IN_W_T << endl;
	#endif

		data_t0 cin_buf[CONV_LANE];
		data_t0 conv_buf[CONV_LANE];
		ap_uint<DATA_W0> cout_buf[CONV_LANE];
	#pragma HLS ARRAY_PARTITION variable=cin_buf complete
	#pragma HLS ARRAY_PARTITION variable=conv_buf complete
	#pragma HLS ARRAY_PARTITION variable=cout_buf complete

			// Set up some configuration signals
		uint FILTER_S = 1;
    uint upsample_factor = (UP_SAMPLE_EN==1)? 2 : 1;
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		uint stride = (max_pool == 1)? 1 : (uint)STRIDE;
		bool en = ADD_EN;
    #ifdef DEBUG
      uint relu_cout_cnt = 0;
      ofstream relu_data;
      relu_data.open("relu_patch.dat", ios::app);
    #endif
    switch(en){
      case 0:
      {
        // bypass this module
        // if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
        int o = 0;
        int h = 0;
        int w = 0;
        bool done1 = 0;

          // int w_bound = LAYER_IN_W_T / stride + FILTER_S - 1;
          // int h_bound = LAYER_IN_H_T / stride + FILTER_S - 1;
        int w_bound = (LAYER_IN_W_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
        int h_bound = (LAYER_IN_H_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
          // cout<<w_bound<<" "<<h_bound<<" "<<LAYER_OUT_NUM_T<<" "<<LAYER_TCONV_STRIDE<<" "<<stride<<endl;
        while(!done1){
          #pragma HLS PIPELINE II=1
          // if(!fifo_conv.empty()/* && !fifo_cin.empty()*/){
            ConvData0Type tmp = 0;
            fifo_cout.write(fifo_conv.read());
            
            // Repeat until the whole tile is read
            w++;
            if (w == w_bound){
              w = 0;
              h++;
              if (h == h_bound){
                h = 0;
                o++;
                if (o == LAYER_OUT_NUM_T / CONV_LANE){
                  o = 0;
                  done1 = 1;
                }
              }
            }
          // }
        }
      }
      break;
      // compute
      case 1:
      {
        // if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
        int o = 0;
        int h = 0;
        int w = 0;
        bool done2 = 0;

        int w_bound = (LAYER_IN_W_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE;
        int h_bound = (LAYER_IN_H_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE;

        while(!done2){
          #pragma HLS PIPELINE II=1
            // cout<<(!fifo_cin.empty() && !fifo_conv.empty())<<" "<<(!fifo_cin.empty())<<" "<<(!fifo_conv.empty())<<endl;
          // if(!fifo_cin.empty() && !fifo_conv.empty()){
            // Read the result of this layer and the previous cin
            ConvData0Type cin_tmp = 0;
            cin_tmp = fifo_cin.read();
            // data_t2 num[SIMD_LANE];
            // for(int i=0; i<SIMD_LANE; i++){
            //   num[i] = Reinterpret<data_t2>((ap_uint<32>)cin_tmp((i+1)*32-1, 32*i));
            //   cin_prev_sum += num[i];
            // }
            ConvData0Type conv_tmp = 0;
            conv_tmp = fifo_conv.read();
            // for(int i=0; i<SIMD_LANE; i++){
            //   num[i] = Reinterpret<data_t2>((ap_uint<32>)conv_tmp((i+1)*32-1, 32*i));
            //   conv_sum += num[i];
            // }
              // Unpack the data according to SIMD_LANE
            for (int lane = 0; lane < CONV_LANE; lane++){
              #pragma HLS UNROLL
              ap_uint<DATA_W0> u32_tmp = cin_tmp(DATA_W0 - 1, 0);
              cin_buf[lane] = Reinterpret<data_t0>(u32_tmp);
              cin_tmp = cin_tmp >> DATA_W0;
            }

            for (int lane = 0; lane < CONV_LANE; lane++){
              #pragma HLS UNROLL
              ap_uint<DATA_W0> u32_tmp = conv_tmp(DATA_W0 - 1, 0);
              conv_buf[lane] = Reinterpret<data_t0>(u32_tmp);
              conv_tmp = conv_tmp >> DATA_W0;
            }

              // Add
            for (int lane = 0; lane < CONV_LANE; lane++){
              #pragma HLS UNROLL    
              data_t0 cin_data = cin_buf[lane];
              data_t0 conv_data = conv_buf[lane];
              data_t0 tmp = cin_data + conv_data;
              cout_buf[lane] = Reinterpret<ap_uint<DATA_W0> >(tmp);
                // 	#define DEBUG_add
              #ifdef DEBUG_add
                        if(lane==0 && o==0)
                          cout << "cin: " << cin_data << " conv: " << conv_data << " tmp: " << tmp << endl;
              #endif
            }

              // write out
              // Pack the data according to SIMD_LANE
            ReluData0Type wide_tmp = (
            #if RELU_LANE == 16
                          cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
                          cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
                          cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
                          cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
            #elif RELU_LANE == 8
                                                  cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
                                                  cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
            #elif RELU_LANE == 4
                                                                          cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
            #elif RELU_LANE == 2              
                                                                                                  cout_buf[1], cout_buf[0]
            #elif RELU_LANE == 1
                                                                                                              cout_buf[0]
            #endif                
            );
            fifo_cout.write(wide_tmp);

              // Repeat until the whole tile is read
            w++;
            if (w == w_bound){
              w = 0;
              h++;
              if (h == h_bound){
                h = 0;
                o++;
                if (o == LAYER_OUT_NUM_T / RELU_LANE){
                  o = 0;
                  done2 = 1;
                }
              }
            }
          // }
        }
      }
      break;
		}
    	// cout<<count++<<endl;
			// Repeat until all the tiles are read
			// Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
		// in_num_iter += LAYER_IN_NUM_T;
		// if (in_num_iter >= LAYER_IN_NUM){
		// 	in_num_iter = 0;
			in_h_iter += LAYER_IN_H_T;
			if (in_h_iter >= LAYER_IN_H){
				in_h_iter = 0;
				in_w_iter += LAYER_IN_W_T;
				if (in_w_iter >= LAYER_IN_W){
					in_w_iter = 0;
					out_num_iter += LAYER_OUT_NUM_T;
					if (out_num_iter >= LAYER_OUT_NUM){
						out_num_iter = 0;
						layer_iter += 1;
						layer_start = 1;
						if (layer_iter == LAYER_BATCH){
							layer_iter = 0;
							done = 1;
						}
					}
				}
			}
		// }

	}
    cout<<"prev_cin_sum: "<<cin_prev_sum<<endl;
    cout<<"conv_sum: "<<conv_sum<<endl;
    cin_prev_sum = 0;
    conv_sum = 0;
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }

}void act_and_bn(
    uint start_inst, uint end_inst,
		tapa::istream<ConvData0Type>        &fifo_gamma_conv,
		tapa::istream<ConvData0Type>        &fifo_beta_conv,
		tapa::istream<ConvData0Type>        &fifo_cin,
		tapa::istream<ConfigInst>           &fifo_config_in,
		tapa::ostream<ReluData0Type>        &fifo_cout,
		tapa::ostream<ConfigInst>           &fifo_config_out
){
  cout<<"relu"<<endl;
	#pragma HLS INLINE off
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
		// tiling iterators
	uint in_num_iter = 0;
	uint out_num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	fifo_config_out.write(inst0);
	ConfigInst inst1 = fifo_config_in.read();
	fifo_config_out.write(inst1);
	ConfigInst inst2 = fifo_config_in.read();
	fifo_config_out.write(inst2);
	ConfigInst inst3 = fifo_config_in.read();
	fifo_config_out.write(inst3);
	ConfigInst inst4 = fifo_config_in.read();
	fifo_config_out.write(inst4);
  ConfigInst inst5 = fifo_config_in.read();
	fifo_config_out.write(inst5);

  	// fifo_config_out.write(inst0);
		// fifo_config_out.write(inst1);
		// fifo_config_out.write(inst2);
		// fifo_config_out.write(inst3);
		// fifo_config_out.write(inst4);
  	// fifo_config_out.write(inst5);

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);
	bool layer_start = 0;
	bool done = 0;
	while(!done){

		if (layer_start){
			inst0 = fifo_config_in.read();
			fifo_config_out.write(inst0);
			inst1 = fifo_config_in.read();
			fifo_config_out.write(inst1);
			inst2 = fifo_config_in.read();
			fifo_config_out.write(inst2);
			inst3 = fifo_config_in.read();
			fifo_config_out.write(inst3);
			inst4 = fifo_config_in.read();
			fifo_config_out.write(inst4);
      inst5 = fifo_config_in.read();
			fifo_config_out.write(inst5);

			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		ap_uint<32> LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		ap_uint<32> LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		ap_uint<32> LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		ap_uint<32> LAYER_IN_H       = inst1(32*2+31, 32*2);
		ap_uint<32> LAYER_IN_W       = inst1(32*3+31, 32*3);
		ap_uint<32> LAYER_OUT_H      = inst1(32*4+31, 32*4);
		ap_uint<32> LAYER_OUT_W      = inst1(32*5+31, 32*5);
			// inst2
		ap_uint<32> CIN_OFFSET       = inst2(32*0+31, 32*0);
		ap_uint<32> WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		ap_uint<32> BIAS_OFFSET      = inst2(32*2+31, 32*2);
		ap_uint<32> COUT_OFFSET      = inst2(32*3+31, 32*3);
		ap_uint<16> FILTER_S1        = inst2(32*4+15, 32*4);
		ap_uint<16> FILTER_S2        = inst2(32*4+31, 32*4+16);
		ap_uint<32> STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		ap_uint<32> LAYER_EN         = inst3(32*0+31, 32*0);
		ap_uint<32> PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		ap_uint<16> LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		ap_uint<16> LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		ap_uint<32> LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		ap_uint<32> LAYER_IN_W_T     = inst3(32*4+31, 32*4);

    ap_uint<16> LAYER_CONV_TYPE 		= inst5(32*0+15, 32*0);
    ap_uint<16> LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);

		ap_uint<1>  CONV_1ST_EN    = LAYER_EN[0];
		ap_uint<1>  DEPTH_CONV_EN  = LAYER_EN[1];
		ap_uint<1>  CONV_EN        = LAYER_EN[2];
		ap_uint<1>  RELU_EN        = LAYER_EN[3];
		ap_uint<1>  RELU6_EN       = LAYER_EN[4];
		ap_uint<1>  POOL_EN        = LAYER_EN[5];
		ap_uint<1>  UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		ap_uint<1>  BIAS_EN        = LAYER_EN[7];
		ap_uint<1>  BATCH_NORM_EN  = LAYER_EN[10];
		ap_uint<1>  LOAD_PREV_CIN  = LAYER_EN[11];
    ap_uint<1>  BATCH_NORM_EN_DEPTH  = LAYER_EN[12];

		data_t2 beta_buf[MAX_OUT_NUM_T / RELU_LANE][RELU_LANE];
		data_t2 gamma_buf[MAX_OUT_NUM_T / RELU_LANE][RELU_LANE]; 
	#pragma HLS ARRAY_PARTITION variable=beta_buf dim=2 complete 
	#pragma HLS ARRAY_PARTITION variable=gamma_buf dim=2 complete 
		data_t0 cin_buf[RELU_LANE];
		ap_uint<DATA_W0> cout_buf[RELU_LANE];
	#pragma HLS ARRAY_PARTITION variable=cin_buf complete
	#pragma HLS ARRAY_PARTITION variable=cout_buf complete

			// Set up some configuration signals
		uint FILTER_S = 1;
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		uint stride = (max_pool == 1)? 1 : (uint)STRIDE;
		bool en = RELU_EN || BIAS_EN || RELU6_EN || BATCH_NORM_EN;
    bool norm_conv_en = (CONV_EN == 1 && BATCH_NORM_EN == 1);
    bool bias_en = (CONV_EN == 1 && BIAS_EN == 1);
    uint upsample_factor = (UP_SAMPLE_EN == 1)? 2 : 1;

    #ifdef DEBUG
      uint relu_cout_cnt = 0;
      ofstream relu_data;
      relu_data.open("relu_patch.dat", ios::app);
    #endif
		switch(en){
		case 0:{
				// bypass this module
			// if (((max_pool || UP_SAMPLE_EN) && out_num_iter == 0) || (!max_pool && (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM))){
				int o = 0;
				int h = 0;
				int w = 0;
				bool done1 = 0;

				int w_bound = (LAYER_IN_W_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
				int h_bound = (LAYER_IN_H_T / stride + FILTER_S - 1)*LAYER_TCONV_STRIDE*upsample_factor;
				while(!done1){
	#pragma HLS PIPELINE II=1
					ConvData0Type tmp = fifo_cin.read();
					fifo_cout.write(tmp);

						// If after conv module neither exists bias nor batch normalization layer, there is no data to read from these FIFOs
					if (norm_conv_en == 1){
					  ConvData0Type beta_conv = fifo_beta_conv.read();
					  ConvData0Type gamma_conv = fifo_gamma_conv.read();
          }
						// Repeat until the whole tile is read
					w++;
					if (w == w_bound){
						w = 0;
						h++;
						if (h == h_bound){
							h = 0;
							o++;
							if (o == LAYER_OUT_NUM_T / RELU_LANE){
								o = 0;
								done1 = 1;
							}
						}
					}
				}
			}
			break;
			// compute
		case 1:
		{
			// if (in_num_iter + LAYER_IN_NUM_T >= LAYER_IN_NUM){
        // cout<<"RELU_EN: "<<RELU_EN<<endl;
					// Read beta and gamma for the batch normalization
					// If there doesn't exist a batch normalization and it's a normal bias,
					// beta = bias, gamma = 0
				for (int o = 0; o < LAYER_OUT_NUM_T / RELU_LANE; o++){
	#pragma HLS PIPELINE II=1
					ConvData0Type beta = 0;//fifo_beta_conv.read();
					ConvData0Type gamma = 0;//fifo_gamma_conv.read();
          if (bias_en){
            beta = fifo_beta_conv.read();
            gamma = fifo_gamma_conv.read();
          }
					for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL
						ap_uint<DATA_W0> u32_beta = beta(DATA_W0 - 1, 0);
						beta_buf[o][lane] = Reinterpret<data_t2>(u32_beta);
						beta = beta >> DATA_W0;
					}

					for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL
						ap_uint<DATA_W0> u32_gamma = gamma(DATA_W0 - 1, 0);
						gamma_buf[o][lane] = Reinterpret<data_t2>(u32_gamma);
						gamma = gamma >> DATA_W0;
					}
				}

				int o = 0;
				int h = 0;
				int w = 0;
				bool done2 = 0;

				int w_bound = (LAYER_IN_W_T / STRIDE)*LAYER_TCONV_STRIDE*upsample_factor;
				int h_bound = (LAYER_IN_H_T / STRIDE)*LAYER_TCONV_STRIDE*upsample_factor;

				while(!done2){
	#pragma HLS PIPELINE II=1
					ConvData0Type cin_tmp = fifo_cin.read();
						// Unpack data according to SIMD_LANE
					for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL
						ap_uint<DATA_W0> u32_tmp = cin_tmp(DATA_W0 - 1, 0);
						cin_buf[lane] = Reinterpret<data_t0>(u32_tmp);
						cin_tmp = cin_tmp >> DATA_W0;
					}
						// Apply beta and gamma + ReLU(6)
					for (int lane = 0; lane < RELU_LANE; lane++){
	#pragma HLS UNROLL    
						data_t0 cin_data = cin_buf[lane];
						data_t0 tmp = cin_data;
            if (BATCH_NORM_EN){
              tmp = tmp * (data_t0) 0.9995003746640602;
            }
            if (RELU_EN)
              tmp = max(tmp, (data_t0) 0);
						// if (bias_en || BATCH_NORM_EN)
						// 	tmp = cin_data + beta_buf[o][lane];
						// 	//else if(BATCH_NORM_EN)
						// 	//	tmp = gamma_buf[o][lane]*tmp + beta_buf[o][lane];
						// if (RELU6_EN && !BATCH_NORM_EN_DEPTH)
						// 	tmp = min(max(0, tmp), 6);
						// else if (RELU_EN && LAYER_CONV_TYPE!=1)
						// 	tmp = max(tmp*0.001, tmp);
						cout_buf[lane] = Reinterpret<ap_uint<DATA_W0> >(tmp);
	#ifdef DEBUG_relu
						if(out_num_iter == 0 && in_h_iter == 0){
							cout << cin_data << " " << tmp << endl;
						}
	#endif
	#ifdef DEBUG_conv_relu
						if(DEPTH_CONV_EN && lane == 0)
							cout << "in: " << cin_buf[lane] << " gamma: " << gamma_buf[o][lane] << " beta: " << beta_buf[o][lane] << " norm: " << gamma_buf[o][lane]*cin_buf[lane] + beta_buf[o][lane] << " tmp: " << tmp << endl;

	#endif
					}
						// write out
						// Pack according to SIMD_LANE
					ReluData0Type wide_tmp = (
	#if RELU_LANE == 16
							cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
							cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
							cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
							cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 8
																			cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
																			cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 4
																															cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 2              
																																											cout_buf[1], cout_buf[0]
	#elif RELU_LANE == 1
																																																  cout_buf[0]
	#endif                
					);
					fifo_cout.write(wide_tmp);

						// Repeat until the whole tile is read
					w++;
					if (w == w_bound){
						w = 0;
						h++;
						if (h == h_bound){
							h = 0;
							o++;
							if (o == LAYER_OUT_NUM_T / RELU_LANE){
								o = 0;
								done2 = 1;
							}
						}
					}
				}
			}
			break;
		// }
		}
			// Repeat until all the tiles are read
			// Must repeat the computation until LAYER_OUT_NUM output feature maps are generated
		// in_num_iter += LAYER_IN_NUM_T;
		// if (in_num_iter >= LAYER_IN_NUM){
		// 	in_num_iter = 0;
			in_h_iter += LAYER_IN_H_T;
			if (in_h_iter >= LAYER_IN_H){
				in_h_iter = 0;
				in_w_iter += LAYER_IN_W_T;
				if (in_w_iter >= LAYER_IN_W){
					in_w_iter = 0;
					out_num_iter += LAYER_OUT_NUM_T;
					if (out_num_iter >= LAYER_OUT_NUM){
						out_num_iter = 0;
						layer_iter += 1;
						layer_start = 1;
						if (layer_iter == LAYER_BATCH){
							layer_iter = 0;
							done = 1;
						}
					}
				}
			}
		// }
	}
    inst++;
    if(inst == inst_count){
      inst_done = 1;
    }
  }
}
/**
 * Function name: cout_write_fifo_read
 * Function description: This function reads cout data.
 */
void cout_write_fifo_read(
		bus_t0 *cout_burst_buf,
		tapa::istream<PoolData0Type>  &fifo_cout,
		bool en,
		bool up_sample,
		uint LAYER_IN_NUM,
		uint LAYER_OUT_H,
		uint LAYER_OUT_W,
		uint LAYER_IN_NUM_T,
		uint LAYER_OUT_NUM_T,
		uint LAYER_IN_H_T,
		uint LAYER_IN_W_T,
		uint in_h_iter,
		uint in_w_iter,
    ap_uint<16> TCONV_STRIDE
){
  // cout<<"cout_write_fifo_read"<<endl;
	PoolData0Type cout_buf[DATA_SEL_FACTOR0];
	#pragma HLS ARRAY_PARTITION variable=cout_buf complete

	#ifdef DEBUG
	ofstream cout_debug;
	cout_debug.open("hw_cout_write_patch.dat", ios::app);
	#endif        

	uint write = 0;
		// Set up the writing mode
	if (en == 0 && up_sample == 0) write = 0; 	// normal writing
	else if (en == 1 && up_sample == 0) write = 1; 	// writing after pooling
	else if (up_sample == 1) write = 2; 	// writing after upsampling
		// Should store the data as Th * Tw * Tn
		// write = 2;
  int count = 0;
	switch(write){
	case 0:
	{
		int o = 0;
		int h = 0;
		int w = 0;
		bool done = 0;
		while(!done){
	#pragma HLS PIPELINE II=1       
	#pragma HLS dependence variable=cout_burst_buf type=inter false
			uint local_cout_idx = h * LAYER_IN_W_T * LAYER_OUT_NUM_T + w * LAYER_OUT_NUM_T + o * POOL_LANE;
			bus_t0 wide_tmp = cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0];
			for (int lane = 0; lane < DATA_SEL_FACTOR0; lane++){
	#pragma HLS UNROLL
				cout_buf[lane] = wide_tmp(DATA_W0 * POOL_LANE - 1, 0);
				wide_tmp = wide_tmp >> DATA_W0 * POOL_LANE;
			}
			PoolData0Type tmp = fifo_cout.read();
			if (in_h_iter + h < LAYER_OUT_H && in_w_iter + w < LAYER_OUT_W)
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = tmp;
			else
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = tmp;

			bus_t0 wide_pack = (
	#if DATA_SEL_FACTOR0 == 1
					cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 2
					cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 4
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 8
					cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 16
				    cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
				    cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
				    cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
				    cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#endif                  
			);
			cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0] = wide_pack;
      	//  print<512>(cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0]);

				// Repeat until the whole tile is read
			w++;
			if (w == LAYER_IN_W_T){
				w = 0;
				h++;
				if (h == LAYER_IN_H_T){
					h = 0;
					o++;
					if (o == LAYER_OUT_NUM_T / POOL_LANE){
						o = 0;
						done = 1;
					}
				}
			}
		}
			//        }
		break;
	}
	case 1:
	{
		int o = 0;
		int h = 0;
		int w = 0;
		bool done = 0;
		while(!done){
	#pragma HLS PIPELINE II=1
				#pragma HLS dependence variable=cout_burst_buf type=inter false
			uint local_cout_idx = h * (LAYER_IN_W_T / 2) * LAYER_OUT_NUM_T + w * LAYER_OUT_NUM_T + o * POOL_LANE;
			bus_t0 wide_tmp = cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0];
			for (int lane = 0; lane < DATA_SEL_FACTOR0; lane++){
	#pragma HLS UNROLL
				cout_buf[lane] = wide_tmp(DATA_W0 * POOL_LANE - 1, 0);
				wide_tmp = wide_tmp >> DATA_W0 * POOL_LANE;
        	// cout<<"lane1: "<<lane<<endl;
			}
			PoolData0Type tmp = fifo_cout.read();
      	// cout<<"lane2: "<<(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE<<endl;
      	// cout<<h<<" "<<w<<" "<<o<<" "<<in_h_iter<<" "<<in_w_iter<<" "<<LAYER_OUT_H<<" "<<LAYER_OUT_W<<endl;
			if (in_h_iter / 2 + h < LAYER_OUT_H && in_w_iter / 2 + w < LAYER_OUT_W){
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = tmp;
        	// print<256>(tmp);
      }
			else{
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = 0;
      }
      	// print<256>(cout_buf[0]);
      	// print<256>(cout_buf[1]);
      	// cout<<(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE<<endl;
      	// print<256>(cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] );
			bus_t0 wide_pack = (
	#if DATA_SEL_FACTOR0 == 1
					cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 2
					cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 4
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 8
					cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 16
					cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
					cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
					cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#endif                  
			);
			cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0] = wide_pack;
      	// cout<<cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0]<<endl;
      	// print<512>(cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0]);

				// Repeat until the whole tile is read
			w++;
			if (w == LAYER_IN_W_T / 2){
				w = 0;
				h++;
				if (h == LAYER_IN_H_T / 2){
					h = 0;
					o++;
					if (o == LAYER_OUT_NUM_T / POOL_LANE){
						o = 0;
						done = 1;
					}
				}
			}
		}
    	// exit(0);
	}
	break;
	case 2:
	{
		int o = 0;
		int h = 0;
		int w = 0;
		bool done = 0;
		while(!done){
	#pragma HLS PIPELINE II=1
				#pragma HLS dependence variable=cout_burst_buf type=inter false
			uint local_cout_idx = h * (LAYER_IN_W_T * TCONV_STRIDE) * LAYER_OUT_NUM_T + w * LAYER_OUT_NUM_T + o * POOL_LANE;
			bus_t0 wide_tmp = cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0];
			for (int lane = 0; lane < DATA_SEL_FACTOR0; lane++){
	#pragma HLS UNROLL
				cout_buf[lane] = wide_tmp(DATA_W0 * POOL_LANE - 1, 0);
				wide_tmp = wide_tmp >> DATA_W0 * POOL_LANE;
			}
			PoolData0Type tmp = fifo_cout.read();

			if (in_h_iter * TCONV_STRIDE + h < LAYER_OUT_H && in_w_iter * TCONV_STRIDE + w < LAYER_OUT_W)
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = tmp;
			else
				cout_buf[(local_cout_idx % BUS_PACK_FACTOR0) / POOL_LANE] = 0;
			bus_t0 wide_pack = (
	#if DATA_SEL_FACTOR0 == 1
					cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 2
					cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 4
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 8
					cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#elif DATA_SEL_FACTOR0 == 16
					cout_buf[15], cout_buf[14], cout_buf[13], cout_buf[12],
					cout_buf[11], cout_buf[10], cout_buf[9], cout_buf[8],
					cout_buf[7], cout_buf[6], cout_buf[5], cout_buf[4],
					cout_buf[3], cout_buf[2], cout_buf[1], cout_buf[0]
	#endif                  
			);
			cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0] = wide_pack;
	#ifdef DEBUG_up_fifo
			cout << "after merge: " << local_cout_idx / BUS_PACK_FACTOR0 << " " ;
			for (int lane = 0; lane < CONV_LANE*2; lane++){
				ap_uint<DATA_W0> u32_tmp = wide_pack(DATA_W0 - 1, 0);
				cout << "lane: " << lane<< " " << Reinterpret<data_t0>(u32_tmp) << " ";
				wide_pack = wide_pack >> DATA_W0;
			}
			cout << endl;
	#endif
				// Repeat until the whole tile is read
			w++;
			if (w == LAYER_IN_W_T * TCONV_STRIDE){
				w = 0;
				h++;
				if (h == LAYER_IN_H_T * TCONV_STRIDE){
					h = 0;
					o++;
					if (o == LAYER_OUT_NUM_T / POOL_LANE){
						o = 0;
						done = 1;
					}
				}
			}
		}
	}
	break;
	}
  	// exit(0);
}

/**
 * Function name: cout_write_ddr_write
 * Function description: This function writes out cout results to off-chip DRAM.
 */
void cout_write_ddr_write(
		bus_t0 *cout_burst_buf,
		bus_mem_0 global_cout,
		bool en,
		bool up_sample,
		uint num_iter,
		uint in_h_iter,
		uint in_w_iter,
		uint LAYER_IN_NUM,
		uint LAYER_OUT_NUM,
		uint LAYER_IN_NUM_T,
		uint LAYER_OUT_NUM_T,
		uint LAYER_IN_H_T,
		uint LAYER_IN_W_T,
		uint LAYER_OUT_H_HW,
		uint LAYER_OUT_W_HW,
		uint num_tile,
		uint ind_w_t,
		uint ind_w,
		uint cout_offset,
		bool change_layout,
		bool run,
    ap_uint<16> TCONV_STRIDE
){
  // cout<<"cout_write_ddr_write"<<endl;
		// Set up the writing mode
	uint write = 0;
	if (up_sample == 1) write = 2;// writing after upsampling
	else if (en == 0) write = 0; 	// normal writing
	else if (en == 1) write = 1; 	// writing after pooling
		// The default data layout is ceil(N / Tn) * H * ceil(W / Tw) * Tw * Tn
		// If filter size is 1, the data layout should change to ceil(N / Tn) * ceil(H / Th) * ceil(W / Tw) * Th * Tw * Tn
  if (change_layout) write += 3; 
  // cout<<"write: "<<write<<endl;
  	// write = 2;
	if (run){
		switch(write){
		case 0:
		{
				// write out
			for (int hh  = 0; hh < LAYER_IN_H_T; hh++){
				uint h = in_h_iter + hh;
				uint global_cout_idx = num_iter / LAYER_OUT_NUM_T * LAYER_OUT_H_HW * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + h * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + in_w_iter * LAYER_OUT_NUM_T + cout_offset;
				uint local_cout_idx = hh * LAYER_IN_W_T * LAYER_OUT_NUM_T;
				for(int i=0; i<LAYER_IN_W_T * LAYER_OUT_NUM_T/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
				// memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T * LAYER_OUT_NUM_T);
      }
		}
		break;
		case 1:
		{
			for (int hh = 0; hh < LAYER_IN_H_T / 2; hh++){
				uint h = in_h_iter / 2 + hh;
				uint global_cout_idx = num_iter / LAYER_OUT_NUM_T * LAYER_OUT_H_HW * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + h * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + in_w_iter / 2 * LAYER_OUT_NUM_T + cout_offset;
				uint local_cout_idx = hh * LAYER_IN_W_T / 2 * LAYER_OUT_NUM_T;
				for(int i=0; i<(LAYER_IN_W_T / 2 * LAYER_OUT_NUM_T)/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
        // memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T / 2 * LAYER_OUT_NUM_T);
			}
		}
		break;
		case 2:
		{
			for (int hh = 0; hh < LAYER_IN_H_T * TCONV_STRIDE; hh++){
				uint h = in_h_iter * TCONV_STRIDE + hh;
				uint global_cout_idx;
				global_cout_idx = num_iter / LAYER_OUT_NUM_T * LAYER_OUT_H_HW * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + h * LAYER_OUT_W_HW * LAYER_OUT_NUM_T + in_w_iter * TCONV_STRIDE * LAYER_OUT_NUM_T + cout_offset;
				uint local_cout_idx = hh * LAYER_IN_W_T * TCONV_STRIDE * LAYER_OUT_NUM_T;
        for(int i=0; i<(LAYER_IN_W_T * TCONV_STRIDE * LAYER_OUT_NUM_T)/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
        // memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T * TCONV_STRIDE * LAYER_OUT_NUM_T);
			}
		}
		break;
    case 3:
		{
			// write out
			for (int hh  = 0; hh < 1; hh++){
				uint global_cout_idx = cout_offset + num_tile * LAYER_OUT_NUM_T * LAYER_IN_W_T * LAYER_IN_H_T;
				uint local_cout_idx = hh * LAYER_IN_W_T * LAYER_OUT_NUM_T;
        for(int i=0; i<(LAYER_IN_W_T * LAYER_OUT_NUM_T * LAYER_IN_H_T)/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
        // memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T * LAYER_OUT_NUM_T * LAYER_IN_H_T);
			}
		}
		break;
		case 4:
		{
			for (int hh = 0; hh < 1; hh++){
				uint global_cout_idx = cout_offset + num_tile * LAYER_OUT_NUM_T * LAYER_IN_W_T/2 * LAYER_IN_H_T/2;
				uint local_cout_idx = hh * LAYER_IN_W_T/2 * LAYER_OUT_NUM_T;
				// cout<<"global:"<<global_cout_idx<<" h: "<<hh<<" in_h_iter: "<<in_h_iter<<" local: "<<local_cout_idx<<endl;
        for(int i=0; i<(LAYER_IN_W_T/2 * LAYER_OUT_NUM_T * LAYER_IN_H_T/2)/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
        // memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T/2 * LAYER_OUT_NUM_T * LAYER_IN_H_T/2);
			}
		}
		break;
		case 5:
		{
			for (int hh = 0; hh < 1; hh++){
				uint global_cout_idx = cout_offset + num_tile * LAYER_OUT_NUM_T * LAYER_IN_W_T * LAYER_IN_H_T * 4;
				uint local_cout_idx = hh * LAYER_IN_W_T * 2 * LAYER_OUT_NUM_T;
        for(int i=0; i<(LAYER_IN_W_T * 2 * LAYER_OUT_NUM_T * LAYER_IN_H_T * 2)/BUS_PACK_FACTOR0; i++){
          #pragma HLS PIPELINE II=1
          global_cout[global_cout_idx/BUS_PACK_FACTOR0 + i] = cout_burst_buf[local_cout_idx/BUS_PACK_FACTOR0 + i];
        }
        // memcpy((void*)&global_cout[global_cout_idx / BUS_PACK_FACTOR0], (void*)&cout_burst_buf[local_cout_idx / BUS_PACK_FACTOR0], sizeof(data_t0) * LAYER_IN_W_T * 2 * LAYER_OUT_NUM_T * LAYER_IN_H_T * 2);
			}
		}
		break;
		}
	}
  	// exit(0);
}

/**
 * Function name: cout_write
 * Function description: This function collects and writes out cout results.
 */
void cout_write(
    uint start_inst, uint end_inst,
		tapa::istream<PoolData0Type>  &fifo_cout,
		tapa::istream<ConfigInst>     &fifo_config_in,
		bus_mem_0                     global_cout,
    tapa::istream<int>            &in_sync,
    tapa::ostream<int>            &out_sync
){
  cout<<"cout_write"<<endl;
  bool inst_done = 0;
  int inst = 0;
  int inst_count = end_inst - start_inst;
  while(!inst_done){
  int sync = in_sync.read();    
  if (sync == inst) {
	bus_t0 cout_burst_buf_ping[COUT_BUFF / BUS_PACK_FACTOR0];
	bus_t0 cout_burst_buf_pong[COUT_BUFF / BUS_PACK_FACTOR0];

	#if cout_write_MEM == 0
		#pragma HLS bind_storage variable=cout_burst_buf_ping type=RAM_T2P impl=BRAM
		#pragma HLS bind_storage variable=cout_burst_buf_pong type=RAM_T2P impl=BRAM 
	#elif cout_write_MEM == 1
		#pragma HLS bind_storage variable=cout_burst_buf_ping type=RAM_T2P impl=URAM
		#pragma HLS bind_storage variable=cout_burst_buf_pong type=RAM_T2P impl=URAM  
	#endif

		// iterators
	uint num_iter = 0;
	uint in_h_iter = 0;
	uint in_w_iter = 0;
	uint layer_iter = 0;

	uint cout_offset = 0;

	uint num_iter_prev = 0;
	uint in_h_iter_prev = 0;
	uint in_w_iter_prev = 0;

		// parameters
		// inst0
	ap_uint<32> LAYER_IN_NUM_HW;
	ap_uint<32> LAYER_OUT_NUM_HW;
	ap_uint<32> LAYER_IN_H_HW;
	ap_uint<32> LAYER_IN_W_HW;
	ap_uint<32> LAYER_OUT_H_HW;
	ap_uint<32> LAYER_OUT_W_HW;
  ap_uint<16> LAYER_OUT_H_NP;
  ap_uint<16> LAYER_OUT_H_SP;
  ap_uint<16> LAYER_OUT_W_EP;
  ap_uint<16> LAYER_OUT_W_WP;
		// inst1
	ap_uint<32> LAYER_IN_NUM;
	ap_uint<32> LAYER_OUT_NUM;
	ap_uint<32> LAYER_IN_H;
	ap_uint<32> LAYER_IN_W;
	ap_uint<32> LAYER_OUT_H;
	ap_uint<32> LAYER_OUT_W;
		// inst2
	ap_uint<32> CIN_OFFSET;
	ap_uint<32> WEIGHT_OFFSET;
	ap_uint<32> BIAS_OFFSET;
	ap_uint<32> COUT_OFFSET;
	ap_uint<16> FILTER_S1;
	ap_uint<16> FILTER_S2;
	ap_uint<32> STRIDE;
		// inst3
	ap_uint<32> LAYER_EN;
	ap_uint<32> PREV_CIN_OFFSET;
	ap_uint<16> LAYER_IN_NUM_T;
	ap_uint<16> LAYER_OUT_NUM_T;
	ap_uint<32> LAYER_IN_H_T;
	ap_uint<32> LAYER_IN_W_T;
	ap_uint<1>  CONV_1ST_EN;
	ap_uint<1>  DEPTH_CONV_EN;
	ap_uint<1>  CONV_EN;
	ap_uint<1>  RELU_EN;
	ap_uint<1>  RELU6_EN;
	ap_uint<1>  POOL_EN;
	ap_uint<1>  UP_SAMPLE_EN;
	ap_uint<1>  BIAS_EN;
	ap_uint<1>  INTER_LOAD_EN;
	ap_uint<1>  INTER_WRITE_EN;
  ap_uint<1>  ADD_EN;

	ap_uint<16> LAYER_CONV_TYPE;	
  ap_uint<16> LAYER_TCONV_STRIDE;


		// Read instructions
	ConfigInst inst0 = fifo_config_in.read();
	ConfigInst inst1 = fifo_config_in.read();
	ConfigInst inst2 = fifo_config_in.read();
	ConfigInst inst3 = fifo_config_in.read();
	ConfigInst inst4 = fifo_config_in.read();
	ConfigInst inst5 = fifo_config_in.read();

	ap_uint<32> LAYER_BATCH = inst3(32*5+31, 32*5);

	bool en_prev;
	bool max_pool_prev;
	bool up_sample_prev;
  bool t_conv_prev;
	bool change_layout;
	uint LAYER_IN_NUM_prev;
	uint LAYER_OUT_NUM_prev;
	uint LAYER_IN_NUM_T_prev;
	uint LAYER_OUT_NUM_T_prev;
	uint LAYER_IN_H_T_prev;
	uint LAYER_IN_W_T_prev;
	uint LAYER_OUT_H_HW_prev;
	uint LAYER_OUT_W_HW_prev;
	uint cout_offset_prev;

	bool write_done = 0;
	uint task_cnt = 0;
	uint iter_h = 1;
	uint num_tile = 0;
  uint channel_iter = 0;
	uint inter_tile = 0;
	uint ind_w = 0;
	uint ind_w_t = 0;
	uint num_tile_prev = 0;
	uint ind_w_t_prev = 0;
	uint ind_w_prev = 0;
	bool layer_start = 0;
	bool done = 0;
	bool change_layout_prev = 0;
  int count = 0;
		// We assum that cin has been pre-padded with zeros
	while(!done){
    	// cout<<count++<<endl;
		if (layer_start){
			inst0 = fifo_config_in.read();
			inst1 = fifo_config_in.read();
			inst2 = fifo_config_in.read();
			inst3 = fifo_config_in.read();
			inst4 = fifo_config_in.read();
			inst5 = fifo_config_in.read();
			layer_start = 0;
		}

			// Refer to cin_load module to understand the meaning of the instructions
			// inst0
		LAYER_IN_NUM_HW  = inst0(32*0+31, 32*0);
		LAYER_OUT_NUM_HW = inst0(32*1+31, 32*1);
		LAYER_IN_H_HW    = inst0(32*2+31, 32*2);
		LAYER_IN_W_HW    = inst0(32*3+31, 32*3);
    LAYER_OUT_H_NP   = inst0(32*4+15, 32*4);
    LAYER_OUT_H_SP   = inst0(32*4+31, 32*4+16);
    LAYER_OUT_W_EP   = inst0(32*5+15, 32*5);
    LAYER_OUT_W_WP   = inst0(32*5+31, 32*5+16);
    // cout<<"LAYER_OUT_H_NP: "<<LAYER_OUT_H_NP<<endl;
    // cout<<"LAYER_OUT_H_SP: "<<LAYER_OUT_H_SP<<endl;
    // cout<<"LAYER_OUT_W_EP: "<<LAYER_OUT_W_EP<<endl;
    // cout<<"LAYER_OUT_W_WP: "<<LAYER_OUT_W_WP<<endl;
		// LAYER_OUT_H_HW   = inst0(32*4+31, 32*4);
		// LAYER_OUT_W_HW   = inst0(32*5+31, 32*5);
			// inst1
		LAYER_IN_NUM     = inst1(32*0+31, 32*0);
		LAYER_OUT_NUM    = inst1(32*1+31, 32*1);
		LAYER_IN_H       = inst1(32*2+31, 32*2);
		LAYER_IN_W       = inst1(32*3+31, 32*3);
		LAYER_OUT_H      = inst1(32*4+31, 32*4);
		LAYER_OUT_W      = inst1(32*5+31, 32*5);
    LAYER_OUT_H_HW   = LAYER_OUT_H + LAYER_OUT_H_NP + LAYER_OUT_H_SP;
		LAYER_OUT_W_HW   = LAYER_OUT_W + LAYER_OUT_W_EP + LAYER_OUT_W_WP;
    // cout<<"LAYER_OUT_H_HW: "<<LAYER_OUT_H_HW<<endl;
    // cout<<"LAYER_OUT_W_HW: "<<LAYER_OUT_W_HW<<endl;
    // exit(0);
			// inst2
		CIN_OFFSET       = inst2(32*0+31, 32*0);
		WEIGHT_OFFSET    = inst2(32*1+31, 32*1);
		BIAS_OFFSET      = inst2(32*2+31, 32*2);
		COUT_OFFSET      = inst2(32*3+31, 32*3);
		FILTER_S1        = inst2(32*4+15, 32*4);
		FILTER_S2        = inst2(32*4+31, 32*4+16);
		STRIDE           = inst2(32*5+31, 32*5);
			// inst3
		LAYER_EN         = inst3(32*0+31, 32*0);
		PREV_CIN_OFFSET  = inst3(32*1+31, 32*1);
		LAYER_IN_NUM_T   = inst3(32*2+15, 32*2);
		LAYER_OUT_NUM_T  = inst3(32*2+31, 32*2+16);
		LAYER_IN_H_T     = inst3(32*3+31, 32*3);
		LAYER_IN_W_T     = inst3(32*4+31, 32*4);

			//	//	///inst5	//	//	//	//	//	//	///
		LAYER_CONV_TYPE = inst5(32*0+15, 32*0);
    LAYER_TCONV_STRIDE 	= inst5(32*2+15, 32*2);

		CONV_1ST_EN    = LAYER_EN[0];
		DEPTH_CONV_EN  = LAYER_EN[1];
		CONV_EN        = LAYER_EN[2];
		RELU_EN        = LAYER_EN[3];
		RELU6_EN       = LAYER_EN[4];
		POOL_EN        = LAYER_EN[5];
		UP_SAMPLE_EN   = LAYER_EN[6];  	// reserved
		BIAS_EN        = LAYER_EN[7];
		INTER_LOAD_EN  = LAYER_EN[8];
		INTER_WRITE_EN = LAYER_EN[9];
    ADD_EN         = LAYER_EN[17];



		// Set up some configuration signals
		cout_offset = COUT_OFFSET;
		bool en = (POOL_EN && !ADD_EN) || (POOL_EN == 0 && STRIDE == 2);
		bool separable_conv = (DEPTH_CONV_EN == 1) && (CONV_EN == 1);
		bool conv2d = (DEPTH_CONV_EN == 0) && (CONV_EN == 1);
		bool max_pool = (DEPTH_CONV_EN == 0) && (CONV_EN == 0);
		bool up_sample = UP_SAMPLE_EN;
    LAYER_TCONV_STRIDE = UP_SAMPLE_EN || (LAYER_CONV_TYPE==1)? 2 : 1;
    bool t_conv = (LAYER_CONV_TYPE == 1)? 1 : 0;
    // cout<<LAYER_OUT_H_HW<<" "<<LAYER_OUT_H<<endl;
    // cout<<LAYER_OUT_W_HW<<" "<<LAYER_OUT_W<<endl;
    
		change_layout = (((LAYER_OUT_W_HW == LAYER_OUT_W) || (LAYER_OUT_W_HW == LAYER_IN_W_T)) && ((LAYER_OUT_H_HW == LAYER_OUT_H) || (LAYER_OUT_H_HW == LAYER_IN_H_T))); 	// if next filter = 1 : change the layout to num_tile, h_t, w_t, in_t
    // cout<<"change_layout: "<<change_layout<<" t_conv: "<<t_conv<<" t_conv_prev: "<<t_conv_prev<<" LAYER_CONV_TYPE: "<<LAYER_CONV_TYPE<<endl;
			// If it is supposed to store the result in DRAM
		if (INTER_WRITE_EN == 0){
			if (task_cnt == 0){
					// First, read the data of the first tile from FIFO
				cout_write_fifo_read(
						cout_burst_buf_ping, fifo_cout, en, (up_sample || t_conv),
						LAYER_IN_NUM, LAYER_OUT_H, LAYER_OUT_W,
						LAYER_IN_NUM_T, LAYER_OUT_NUM_T,
						LAYER_IN_H_T, LAYER_IN_W_T,
						in_h_iter, in_w_iter,
            LAYER_TCONV_STRIDE
				);
			} else {
					// Apply double buffering for reading the data from FIFO and writing to DRAM
				if (task_cnt % 2 == 1){
					cout_write_fifo_read(
							cout_burst_buf_pong, fifo_cout, en, (up_sample || t_conv),
							LAYER_IN_NUM, LAYER_OUT_H, LAYER_OUT_W,
							LAYER_IN_NUM_T, LAYER_OUT_NUM_T,
							LAYER_IN_H_T, LAYER_IN_W_T,
							in_h_iter, in_w_iter,
              LAYER_TCONV_STRIDE
					);
					cout_write_ddr_write(
							cout_burst_buf_ping, global_cout,
							en_prev, (up_sample_prev || t_conv_prev),
							num_iter_prev, in_h_iter_prev, in_w_iter_prev,
							LAYER_IN_NUM_prev, LAYER_OUT_NUM_prev,
							LAYER_IN_NUM_T_prev, LAYER_OUT_NUM_T_prev,
							LAYER_IN_H_T_prev, LAYER_IN_W_T_prev,
							LAYER_OUT_H_HW_prev, LAYER_OUT_W_HW_prev,
							num_tile_prev,
							ind_w_t_prev,
							ind_w_prev,
							cout_offset_prev,
							change_layout_prev,
							!write_done,
              LAYER_TCONV_STRIDE
					);
				} else {
					cout_write_fifo_read(
							cout_burst_buf_ping, fifo_cout, en, (up_sample || t_conv),
							LAYER_IN_NUM, LAYER_OUT_H, LAYER_OUT_W,
							LAYER_IN_NUM_T, LAYER_OUT_NUM_T,
							LAYER_IN_H_T, LAYER_IN_W_T,
							in_h_iter, in_w_iter,
              LAYER_TCONV_STRIDE
					);

					cout_write_ddr_write(
							cout_burst_buf_pong, global_cout,
							en_prev, (up_sample_prev || t_conv_prev),
							num_iter_prev, in_h_iter_prev, in_w_iter_prev,
							LAYER_IN_NUM_prev, LAYER_OUT_NUM_prev,
							LAYER_IN_NUM_T_prev, LAYER_OUT_NUM_T_prev,
							LAYER_IN_H_T_prev, LAYER_IN_W_T_prev,
							LAYER_OUT_H_HW_prev, LAYER_OUT_W_HW_prev,
							num_tile_prev,
							ind_w_t_prev,
							ind_w_prev,
							cout_offset_prev,
							change_layout_prev,
							!write_done,
              LAYER_TCONV_STRIDE
					);
				}
			}

			if (task_cnt > 0){
				write_done = 1;
			}
			
				// need to know the config of the current tile in the next iteration since we are using double buffering
			task_cnt++;
			num_iter_prev = num_iter;
			in_h_iter_prev = in_h_iter;
			in_w_iter_prev = in_w_iter;
			en_prev = en;
			up_sample_prev = up_sample;
      t_conv_prev = t_conv;
			max_pool_prev = max_pool;
			LAYER_IN_NUM_prev = LAYER_IN_NUM;
			LAYER_OUT_NUM_prev = LAYER_OUT_NUM;
			LAYER_IN_NUM_T_prev = LAYER_IN_NUM_T;
			LAYER_OUT_NUM_T_prev = LAYER_OUT_NUM_T;
			LAYER_IN_H_T_prev = LAYER_IN_H_T;
			LAYER_IN_W_T_prev = LAYER_IN_W_T;
			LAYER_OUT_H_HW_prev = LAYER_OUT_H_HW;
			LAYER_OUT_W_HW_prev = LAYER_OUT_W_HW;
			cout_offset_prev = cout_offset;
			num_tile_prev = num_tile;
			ind_w_t_prev = ind_w_t;
			ind_w_prev = ind_w;
			change_layout_prev = change_layout;
			write_done = 0;

		}
    	// cout<<num_tile<<endl;
			// Repeat until all the tiles are stored
		// if (max_pool || up_sample){
    // cout<<num_tile<<endl;
    // num_iter += LAYER_OUT_NUM_T;
    // if (num_iter < LAYER_OUT_NUM){
    //   channel_iter += ((LAYER_IN_W / LAYER_IN_W_T) * (LAYER_IN_H / LAYER_IN_H_T));
    // } else {
    //   channel_iter = 0;
    //   inter_tile++;
    // }
    // num_tile = channel_iter + inter_tile;
    // cout<<num_tile<<" "<<channel_iter<<" "<<inter_tile<<endl;
    num_tile++;
    in_h_iter += LAYER_IN_H_T;
    if (in_h_iter >= LAYER_IN_H){
      in_h_iter = 0;
      in_w_iter += LAYER_IN_W_T;
      if (in_w_iter >= LAYER_IN_W){
        in_w_iter = 0;
        num_iter += LAYER_OUT_NUM_T;
        if (num_iter >= LAYER_OUT_NUM){
          num_iter = 0;
          num_tile = 0;
          layer_start = 1;
          layer_iter += 1;
          if (layer_iter == LAYER_BATCH){
            layer_iter = 0;
            done = 1;
          }
        }
      }
    }
    // }
		// } else if (STRIDE == 2){
		// 	num_tile += 1;
		// 	if (num_tile == (LAYER_IN_H / LAYER_IN_H_T)){
		// 		num_tile = 0;
		// 		ind_w_t += 1;
		// 		if (LAYER_IN_W_T / 2 == LAYER_OUT_W_HW) ind_w_t += 1;
		// 		if (ind_w_t == 2){
		// 			ind_w_t = 0;
		// 			ind_w += (LAYER_IN_H / LAYER_IN_H_T);
		// 		}
		// 	}
		// 	in_h_iter += LAYER_IN_H_T;
		// 	if (in_h_iter >= LAYER_IN_H){
		// 		in_h_iter = 0;
		// 		in_w_iter += LAYER_IN_W_T;
		// 		if (in_w_iter >= LAYER_IN_W){
		// 			in_w_iter = 0;
		// 			num_iter += LAYER_OUT_NUM_T;
		// 			if (num_iter >= LAYER_OUT_NUM){
		// 				num_iter = 0;
		// 				layer_iter += 1;
		// 				layer_start = 1;
		// 				if (layer_iter == LAYER_BATCH){
		// 					layer_iter = 0;
		// 					done = 1;
		// 				}
		// 			}
		// 		}
		// 	}
		// } else {
		// 		//num_tile = task_cnt - 1;
		// 	num_tile = task_cnt;
		// 	in_h_iter += LAYER_IN_H_T;
		// 	if (in_h_iter >= LAYER_IN_H){
		// 		in_h_iter = 0;
		// 		in_w_iter += LAYER_IN_W_T;
		// 		if (in_w_iter >= LAYER_IN_W){
		// 			in_w_iter = 0;
		// 			num_iter += LAYER_OUT_NUM_T;
		// 			if (num_iter >= LAYER_OUT_NUM){
		// 				num_iter = 0;
		// 				layer_iter += 1;
		// 				layer_start = 1;
		// 				if (layer_iter == LAYER_BATCH){
		// 					layer_iter = 0;
		// 					done = 1;
		// 				}
		// 			}
		// 		}
		// 	}

		// }

	}

		// Store the last tile
	if (INTER_WRITE_EN == 0){
		if (task_cnt % 2 == 1){
			cout_write_ddr_write(
					cout_burst_buf_ping, global_cout,
					en_prev, (up_sample_prev || t_conv_prev),
					num_iter_prev, in_h_iter_prev, in_w_iter_prev,
					LAYER_IN_NUM_prev, LAYER_OUT_NUM_prev,
					LAYER_IN_NUM_T_prev, LAYER_OUT_NUM_T_prev,
					LAYER_IN_H_T_prev, LAYER_IN_W_T_prev,
					LAYER_OUT_H_HW_prev, LAYER_OUT_W_HW_prev,
					num_tile_prev,
					ind_w_t_prev,
					ind_w_prev,
					cout_offset_prev,
					change_layout_prev,
					!write_done,
          LAYER_TCONV_STRIDE
			);
		} else {
			cout_write_ddr_write(
					cout_burst_buf_pong, global_cout,
					en_prev, (up_sample_prev || t_conv_prev),
					num_iter_prev, in_h_iter_prev, in_w_iter_prev,
					LAYER_IN_NUM_prev, LAYER_OUT_NUM_prev,
					LAYER_IN_NUM_T_prev, LAYER_OUT_NUM_T_prev,
					LAYER_IN_H_T_prev, LAYER_IN_W_T_prev,
					LAYER_OUT_H_HW_prev, LAYER_OUT_W_HW_prev,
					num_tile_prev,
					ind_w_t_prev,
					ind_w_prev,
					cout_offset_prev,
					change_layout_prev,
					!write_done,
          LAYER_TCONV_STRIDE
			);
		}
	}
    inst++;
    if(inst<inst_count)
      out_sync.write(inst);
  }
  if(inst == inst_count){
    inst_done = 1;
  }
  }
}void top_kernel(
    bus_mem_0 dram_b0,
    bus_mem_1 dram_weights,
    bus_mem_2 dram_biases,
    bus_mem_3 layer_config,
    uint start_inst,
    uint end_inst
){
  // FIFOs
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_0("fifo0_feed0_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_1("fifo0_feed0_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_2("fifo0_feed0_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_3("fifo0_feed0_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_4("fifo0_feed0_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_5("fifo0_feed0_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_6("fifo0_feed0_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_7("fifo0_feed0_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_8("fifo0_feed0_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed0_9("fifo0_feed0_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_0("fifo0_feed1_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_1("fifo0_feed1_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_2("fifo0_feed1_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_3("fifo0_feed1_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_4("fifo0_feed1_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_5("fifo0_feed1_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_6("fifo0_feed1_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_7("fifo0_feed1_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_8("fifo0_feed1_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed1_9("fifo0_feed1_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_0("fifo0_feed2_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_1("fifo0_feed2_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_2("fifo0_feed2_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_3("fifo0_feed2_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_4("fifo0_feed2_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_5("fifo0_feed2_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_6("fifo0_feed2_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_7("fifo0_feed2_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_8("fifo0_feed2_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed2_9("fifo0_feed2_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_0("fifo0_feed3_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_1("fifo0_feed3_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_2("fifo0_feed3_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_3("fifo0_feed3_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_4("fifo0_feed3_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_5("fifo0_feed3_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_6("fifo0_feed3_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_7("fifo0_feed3_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_8("fifo0_feed3_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed3_9("fifo0_feed3_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_0("fifo0_feed4_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_1("fifo0_feed4_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_2("fifo0_feed4_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_3("fifo0_feed4_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_4("fifo0_feed4_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_5("fifo0_feed4_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_6("fifo0_feed4_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_7("fifo0_feed4_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_8("fifo0_feed4_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed4_9("fifo0_feed4_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_0("fifo0_feed5_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_1("fifo0_feed5_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_2("fifo0_feed5_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_3("fifo0_feed5_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_4("fifo0_feed5_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_5("fifo0_feed5_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_6("fifo0_feed5_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_7("fifo0_feed5_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_8("fifo0_feed5_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed5_9("fifo0_feed5_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_0("fifo0_feed6_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_1("fifo0_feed6_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_2("fifo0_feed6_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_3("fifo0_feed6_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_4("fifo0_feed6_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_5("fifo0_feed6_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_6("fifo0_feed6_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_7("fifo0_feed6_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_8("fifo0_feed6_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed6_9("fifo0_feed6_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_0("fifo0_feed7_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_1("fifo0_feed7_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_2("fifo0_feed7_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_3("fifo0_feed7_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_4("fifo0_feed7_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_5("fifo0_feed7_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_6("fifo0_feed7_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_7("fifo0_feed7_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_8("fifo0_feed7_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed7_9("fifo0_feed7_9");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_0("fifo0_feed8_0");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_1("fifo0_feed8_1");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_2("fifo0_feed8_2");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_3("fifo0_feed8_3");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_4("fifo0_feed8_4");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_5("fifo0_feed8_5");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_6("fifo0_feed8_6");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_7("fifo0_feed8_7");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_8("fifo0_feed8_8");
  tapa::stream<U1_Data0PEChannelType, 2> fifo0_feed8_9("fifo0_feed8_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_0("fifo1_feed0_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_1("fifo1_feed0_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_2("fifo1_feed0_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_3("fifo1_feed0_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_4("fifo1_feed0_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_5("fifo1_feed0_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_6("fifo1_feed0_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_7("fifo1_feed0_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_8("fifo1_feed0_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed0_9("fifo1_feed0_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_0("fifo1_feed1_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_1("fifo1_feed1_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_2("fifo1_feed1_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_3("fifo1_feed1_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_4("fifo1_feed1_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_5("fifo1_feed1_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_6("fifo1_feed1_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_7("fifo1_feed1_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_8("fifo1_feed1_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed1_9("fifo1_feed1_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_0("fifo1_feed2_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_1("fifo1_feed2_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_2("fifo1_feed2_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_3("fifo1_feed2_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_4("fifo1_feed2_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_5("fifo1_feed2_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_6("fifo1_feed2_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_7("fifo1_feed2_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_8("fifo1_feed2_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed2_9("fifo1_feed2_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_0("fifo1_feed3_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_1("fifo1_feed3_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_2("fifo1_feed3_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_3("fifo1_feed3_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_4("fifo1_feed3_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_5("fifo1_feed3_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_6("fifo1_feed3_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_7("fifo1_feed3_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_8("fifo1_feed3_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed3_9("fifo1_feed3_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_0("fifo1_feed4_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_1("fifo1_feed4_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_2("fifo1_feed4_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_3("fifo1_feed4_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_4("fifo1_feed4_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_5("fifo1_feed4_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_6("fifo1_feed4_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_7("fifo1_feed4_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_8("fifo1_feed4_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed4_9("fifo1_feed4_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_0("fifo1_feed5_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_1("fifo1_feed5_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_2("fifo1_feed5_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_3("fifo1_feed5_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_4("fifo1_feed5_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_5("fifo1_feed5_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_6("fifo1_feed5_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_7("fifo1_feed5_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_8("fifo1_feed5_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed5_9("fifo1_feed5_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_0("fifo1_feed6_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_1("fifo1_feed6_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_2("fifo1_feed6_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_3("fifo1_feed6_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_4("fifo1_feed6_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_5("fifo1_feed6_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_6("fifo1_feed6_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_7("fifo1_feed6_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_8("fifo1_feed6_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed6_9("fifo1_feed6_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_0("fifo1_feed7_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_1("fifo1_feed7_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_2("fifo1_feed7_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_3("fifo1_feed7_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_4("fifo1_feed7_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_5("fifo1_feed7_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_6("fifo1_feed7_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_7("fifo1_feed7_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_8("fifo1_feed7_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed7_9("fifo1_feed7_9");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_0("fifo1_feed8_0");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_1("fifo1_feed8_1");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_2("fifo1_feed8_2");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_3("fifo1_feed8_3");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_4("fifo1_feed8_4");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_5("fifo1_feed8_5");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_6("fifo1_feed8_6");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_7("fifo1_feed8_7");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_8("fifo1_feed8_8");
  tapa::stream<U1_Data1PEChannelType, 2> fifo1_feed8_9("fifo1_feed8_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_0("fifo2_collect0_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_1("fifo2_collect0_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_2("fifo2_collect0_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_3("fifo2_collect0_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_4("fifo2_collect0_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_5("fifo2_collect0_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_6("fifo2_collect0_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_7("fifo2_collect0_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_8("fifo2_collect0_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect0_9("fifo2_collect0_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_0("fifo2_collect1_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_1("fifo2_collect1_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_2("fifo2_collect1_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_3("fifo2_collect1_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_4("fifo2_collect1_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_5("fifo2_collect1_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_6("fifo2_collect1_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_7("fifo2_collect1_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_8("fifo2_collect1_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect1_9("fifo2_collect1_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_0("fifo2_collect2_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_1("fifo2_collect2_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_2("fifo2_collect2_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_3("fifo2_collect2_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_4("fifo2_collect2_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_5("fifo2_collect2_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_6("fifo2_collect2_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_7("fifo2_collect2_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_8("fifo2_collect2_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect2_9("fifo2_collect2_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_0("fifo2_collect3_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_1("fifo2_collect3_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_2("fifo2_collect3_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_3("fifo2_collect3_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_4("fifo2_collect3_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_5("fifo2_collect3_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_6("fifo2_collect3_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_7("fifo2_collect3_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_8("fifo2_collect3_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect3_9("fifo2_collect3_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_0("fifo2_collect4_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_1("fifo2_collect4_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_2("fifo2_collect4_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_3("fifo2_collect4_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_4("fifo2_collect4_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_5("fifo2_collect4_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_6("fifo2_collect4_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_7("fifo2_collect4_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_8("fifo2_collect4_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect4_9("fifo2_collect4_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_0("fifo2_collect5_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_1("fifo2_collect5_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_2("fifo2_collect5_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_3("fifo2_collect5_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_4("fifo2_collect5_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_5("fifo2_collect5_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_6("fifo2_collect5_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_7("fifo2_collect5_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_8("fifo2_collect5_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect5_9("fifo2_collect5_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_0("fifo2_collect6_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_1("fifo2_collect6_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_2("fifo2_collect6_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_3("fifo2_collect6_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_4("fifo2_collect6_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_5("fifo2_collect6_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_6("fifo2_collect6_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_7("fifo2_collect6_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_8("fifo2_collect6_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect6_9("fifo2_collect6_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_0("fifo2_collect7_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_1("fifo2_collect7_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_2("fifo2_collect7_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_3("fifo2_collect7_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_4("fifo2_collect7_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_5("fifo2_collect7_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_6("fifo2_collect7_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_7("fifo2_collect7_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_8("fifo2_collect7_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect7_9("fifo2_collect7_9");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_0("fifo2_collect8_0");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_1("fifo2_collect8_1");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_2("fifo2_collect8_2");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_3("fifo2_collect8_3");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_4("fifo2_collect8_4");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_5("fifo2_collect8_5");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_6("fifo2_collect8_6");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_7("fifo2_collect8_7");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_8("fifo2_collect8_8");
  tapa::stream<U1_Data2PEChannelType, 2> fifo2_collect8_9("fifo2_collect8_9");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer0("fifo0_transfer0");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer1("fifo0_transfer1");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer2("fifo0_transfer2");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer3("fifo0_transfer3");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer4("fifo0_transfer4");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer5("fifo0_transfer5");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer6("fifo0_transfer6");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer7("fifo0_transfer7");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer8("fifo0_transfer8");
  tapa::stream<U1_Data0TransferChannelType, 2> fifo0_transfer9("fifo0_transfer9");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer0("fifo1_transfer0");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer1("fifo1_transfer1");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer2("fifo1_transfer2");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer3("fifo1_transfer3");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer4("fifo1_transfer4");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer5("fifo1_transfer5");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer6("fifo1_transfer6");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer7("fifo1_transfer7");
  tapa::stream<U1_Data1TransferChannelType, 2> fifo1_transfer8("fifo1_transfer8");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer0("fifo2_transfer0");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer1("fifo2_transfer1");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer2("fifo2_transfer2");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer3("fifo2_transfer3");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer4("fifo2_transfer4");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer5("fifo2_transfer5");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer6("fifo2_transfer6");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer7("fifo2_transfer7");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer8("fifo2_transfer8");
  tapa::stream<U1_Data2TransferChannelType, 2> fifo2_transfer9("fifo2_transfer9");
  tapa::stream<uint, 16> fifo_DataFeed0Head_config_out0("fifo_DataFeed0Head_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Head_config_out1("fifo_DataFeed0Head_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed1Head_config_out0("fifo_DataFeed1Head_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine0_config_out0("fifo_DataFeed0Engine0_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine0_config_out1("fifo_DataFeed0Engine0_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine1_config_out0("fifo_DataFeed0Engine1_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine1_config_out1("fifo_DataFeed0Engine1_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine2_config_out0("fifo_DataFeed0Engine2_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine2_config_out1("fifo_DataFeed0Engine2_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine3_config_out0("fifo_DataFeed0Engine3_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine3_config_out1("fifo_DataFeed0Engine3_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine4_config_out0("fifo_DataFeed0Engine4_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine4_config_out1("fifo_DataFeed0Engine4_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine5_config_out0("fifo_DataFeed0Engine5_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine5_config_out1("fifo_DataFeed0Engine5_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine6_config_out0("fifo_DataFeed0Engine6_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine6_config_out1("fifo_DataFeed0Engine6_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine7_config_out0("fifo_DataFeed0Engine7_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed0Engine7_config_out1("fifo_DataFeed0Engine7_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed0Engine8_config_out1("fifo_DataFeed0Engine8_config_out1");
  tapa::stream<uint, 16> fifo_DataFeed1Engine0_config_out0("fifo_DataFeed1Engine0_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine1_config_out0("fifo_DataFeed1Engine1_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine2_config_out0("fifo_DataFeed1Engine2_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine3_config_out0("fifo_DataFeed1Engine3_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine4_config_out0("fifo_DataFeed1Engine4_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine5_config_out0("fifo_DataFeed1Engine5_config_out0");
  tapa::stream<uint, 16> fifo_DataFeed1Engine6_config_out0("fifo_DataFeed1Engine6_config_out0");

  tapa::stream<uint, 16> fifo_DataCollect2Engine0_config_out("fifo_DataFeed2Engine0_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine1_config_out("fifo_DataFeed2Engine1_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine2_config_out("fifo_DataFeed2Engine2_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine3_config_out("fifo_DataFeed2Engine3_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine4_config_out("fifo_DataFeed2Engine4_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine5_config_out("fifo_DataFeed2Engine5_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine6_config_out("fifo_DataFeed2Engine6_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine7_config_out("fifo_DataFeed2Engine7_config_out0");
  tapa::stream<uint, 16> fifo_DataCollect2Engine8_config_out("fifo_DataFeed2Engine8_config_out0");

  tapa::stream<uint, 2> fifo_PE0_0_op0_config_out("fifo_PE0_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_0_op1_config_out("fifo_PE0_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_0_compute_config_out("fifo_PE0_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_0_res_config_out("fifo_PE0_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_1_op0_config_out("fifo_PE0_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_1_op1_config_out("fifo_PE0_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_1_compute_config_out("fifo_PE0_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_1_res_config_out("fifo_PE0_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_2_op0_config_out("fifo_PE0_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_2_op1_config_out("fifo_PE0_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_2_compute_config_out("fifo_PE0_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_2_res_config_out("fifo_PE0_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_3_op0_config_out("fifo_PE0_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_3_op1_config_out("fifo_PE0_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_3_compute_config_out("fifo_PE0_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_3_res_config_out("fifo_PE0_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_4_op0_config_out("fifo_PE0_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_4_op1_config_out("fifo_PE0_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_4_compute_config_out("fifo_PE0_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_4_res_config_out("fifo_PE0_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_5_op0_config_out("fifo_PE0_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_5_op1_config_out("fifo_PE0_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_5_compute_config_out("fifo_PE0_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_5_res_config_out("fifo_PE0_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_6_op0_config_out("fifo_PE0_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_6_op1_config_out("fifo_PE0_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_6_compute_config_out("fifo_PE0_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_6_res_config_out("fifo_PE0_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_7_op0_config_out("fifo_PE0_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_7_op1_config_out("fifo_PE0_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_7_compute_config_out("fifo_PE0_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_7_res_config_out("fifo_PE0_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE0_8_op0_config_out("fifo_PE0_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE0_8_op1_config_out("fifo_PE0_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE0_8_compute_config_out("fifo_PE0_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE0_8_res_config_out("fifo_PE0_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_0_op0_config_out("fifo_PE1_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_0_op1_config_out("fifo_PE1_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_0_compute_config_out("fifo_PE1_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_0_res_config_out("fifo_PE1_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_1_op0_config_out("fifo_PE1_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_1_op1_config_out("fifo_PE1_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_1_compute_config_out("fifo_PE1_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_1_res_config_out("fifo_PE1_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_2_op0_config_out("fifo_PE1_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_2_op1_config_out("fifo_PE1_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_2_compute_config_out("fifo_PE1_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_2_res_config_out("fifo_PE1_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_3_op0_config_out("fifo_PE1_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_3_op1_config_out("fifo_PE1_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_3_compute_config_out("fifo_PE1_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_3_res_config_out("fifo_PE1_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_4_op0_config_out("fifo_PE1_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_4_op1_config_out("fifo_PE1_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_4_compute_config_out("fifo_PE1_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_4_res_config_out("fifo_PE1_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_5_op0_config_out("fifo_PE1_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_5_op1_config_out("fifo_PE1_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_5_compute_config_out("fifo_PE1_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_5_res_config_out("fifo_PE1_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_6_op0_config_out("fifo_PE1_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_6_op1_config_out("fifo_PE1_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_6_compute_config_out("fifo_PE1_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_6_res_config_out("fifo_PE1_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_7_op0_config_out("fifo_PE1_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_7_op1_config_out("fifo_PE1_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_7_compute_config_out("fifo_PE1_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_7_res_config_out("fifo_PE1_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE1_8_op0_config_out("fifo_PE1_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE1_8_op1_config_out("fifo_PE1_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE1_8_compute_config_out("fifo_PE1_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE1_8_res_config_out("fifo_PE1_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_0_op0_config_out("fifo_PE2_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_0_op1_config_out("fifo_PE2_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_0_compute_config_out("fifo_PE2_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_0_res_config_out("fifo_PE2_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_1_op0_config_out("fifo_PE2_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_1_op1_config_out("fifo_PE2_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_1_compute_config_out("fifo_PE2_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_1_res_config_out("fifo_PE2_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_2_op0_config_out("fifo_PE2_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_2_op1_config_out("fifo_PE2_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_2_compute_config_out("fifo_PE2_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_2_res_config_out("fifo_PE2_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_3_op0_config_out("fifo_PE2_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_3_op1_config_out("fifo_PE2_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_3_compute_config_out("fifo_PE2_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_3_res_config_out("fifo_PE2_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_4_op0_config_out("fifo_PE2_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_4_op1_config_out("fifo_PE2_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_4_compute_config_out("fifo_PE2_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_4_res_config_out("fifo_PE2_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_5_op0_config_out("fifo_PE2_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_5_op1_config_out("fifo_PE2_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_5_compute_config_out("fifo_PE2_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_5_res_config_out("fifo_PE2_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_6_op0_config_out("fifo_PE2_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_6_op1_config_out("fifo_PE2_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_6_compute_config_out("fifo_PE2_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_6_res_config_out("fifo_PE2_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_7_op0_config_out("fifo_PE2_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_7_op1_config_out("fifo_PE2_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_7_compute_config_out("fifo_PE2_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_7_res_config_out("fifo_PE2_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE2_8_op0_config_out("fifo_PE2_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE2_8_op1_config_out("fifo_PE2_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE2_8_compute_config_out("fifo_PE2_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE2_8_res_config_out("fifo_PE2_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_0_op0_config_out("fifo_PE3_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_0_op1_config_out("fifo_PE3_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_0_compute_config_out("fifo_PE3_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_0_res_config_out("fifo_PE3_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_1_op0_config_out("fifo_PE3_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_1_op1_config_out("fifo_PE3_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_1_compute_config_out("fifo_PE3_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_1_res_config_out("fifo_PE3_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_2_op0_config_out("fifo_PE3_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_2_op1_config_out("fifo_PE3_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_2_compute_config_out("fifo_PE3_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_2_res_config_out("fifo_PE3_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_3_op0_config_out("fifo_PE3_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_3_op1_config_out("fifo_PE3_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_3_compute_config_out("fifo_PE3_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_3_res_config_out("fifo_PE3_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_4_op0_config_out("fifo_PE3_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_4_op1_config_out("fifo_PE3_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_4_compute_config_out("fifo_PE3_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_4_res_config_out("fifo_PE3_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_5_op0_config_out("fifo_PE3_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_5_op1_config_out("fifo_PE3_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_5_compute_config_out("fifo_PE3_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_5_res_config_out("fifo_PE3_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_6_op0_config_out("fifo_PE3_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_6_op1_config_out("fifo_PE3_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_6_compute_config_out("fifo_PE3_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_6_res_config_out("fifo_PE3_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_7_op0_config_out("fifo_PE3_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_7_op1_config_out("fifo_PE3_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_7_compute_config_out("fifo_PE3_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_7_res_config_out("fifo_PE3_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE3_8_op0_config_out("fifo_PE3_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE3_8_op1_config_out("fifo_PE3_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE3_8_compute_config_out("fifo_PE3_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE3_8_res_config_out("fifo_PE3_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_0_op0_config_out("fifo_PE4_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_0_op1_config_out("fifo_PE4_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_0_compute_config_out("fifo_PE4_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_0_res_config_out("fifo_PE4_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_1_op0_config_out("fifo_PE4_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_1_op1_config_out("fifo_PE4_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_1_compute_config_out("fifo_PE4_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_1_res_config_out("fifo_PE4_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_2_op0_config_out("fifo_PE4_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_2_op1_config_out("fifo_PE4_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_2_compute_config_out("fifo_PE4_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_2_res_config_out("fifo_PE4_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_3_op0_config_out("fifo_PE4_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_3_op1_config_out("fifo_PE4_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_3_compute_config_out("fifo_PE4_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_3_res_config_out("fifo_PE4_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_4_op0_config_out("fifo_PE4_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_4_op1_config_out("fifo_PE4_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_4_compute_config_out("fifo_PE4_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_4_res_config_out("fifo_PE4_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_5_op0_config_out("fifo_PE4_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_5_op1_config_out("fifo_PE4_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_5_compute_config_out("fifo_PE4_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_5_res_config_out("fifo_PE4_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_6_op0_config_out("fifo_PE4_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_6_op1_config_out("fifo_PE4_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_6_compute_config_out("fifo_PE4_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_6_res_config_out("fifo_PE4_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_7_op0_config_out("fifo_PE4_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_7_op1_config_out("fifo_PE4_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_7_compute_config_out("fifo_PE4_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_7_res_config_out("fifo_PE4_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE4_8_op0_config_out("fifo_PE4_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE4_8_op1_config_out("fifo_PE4_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE4_8_compute_config_out("fifo_PE4_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE4_8_res_config_out("fifo_PE4_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_0_op0_config_out("fifo_PE5_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_0_op1_config_out("fifo_PE5_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_0_compute_config_out("fifo_PE5_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_0_res_config_out("fifo_PE5_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_1_op0_config_out("fifo_PE5_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_1_op1_config_out("fifo_PE5_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_1_compute_config_out("fifo_PE5_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_1_res_config_out("fifo_PE5_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_2_op0_config_out("fifo_PE5_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_2_op1_config_out("fifo_PE5_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_2_compute_config_out("fifo_PE5_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_2_res_config_out("fifo_PE5_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_3_op0_config_out("fifo_PE5_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_3_op1_config_out("fifo_PE5_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_3_compute_config_out("fifo_PE5_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_3_res_config_out("fifo_PE5_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_4_op0_config_out("fifo_PE5_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_4_op1_config_out("fifo_PE5_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_4_compute_config_out("fifo_PE5_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_4_res_config_out("fifo_PE5_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_5_op0_config_out("fifo_PE5_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_5_op1_config_out("fifo_PE5_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_5_compute_config_out("fifo_PE5_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_5_res_config_out("fifo_PE5_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_6_op0_config_out("fifo_PE5_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_6_op1_config_out("fifo_PE5_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_6_compute_config_out("fifo_PE5_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_6_res_config_out("fifo_PE5_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_7_op0_config_out("fifo_PE5_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_7_op1_config_out("fifo_PE5_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_7_compute_config_out("fifo_PE5_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_7_res_config_out("fifo_PE5_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE5_8_op0_config_out("fifo_PE5_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE5_8_op1_config_out("fifo_PE5_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE5_8_compute_config_out("fifo_PE5_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE5_8_res_config_out("fifo_PE5_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_0_op0_config_out("fifo_PE6_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_0_op1_config_out("fifo_PE6_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_0_compute_config_out("fifo_PE6_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_0_res_config_out("fifo_PE6_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_1_op0_config_out("fifo_PE6_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_1_op1_config_out("fifo_PE6_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_1_compute_config_out("fifo_PE6_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_1_res_config_out("fifo_PE6_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_2_op0_config_out("fifo_PE6_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_2_op1_config_out("fifo_PE6_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_2_compute_config_out("fifo_PE6_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_2_res_config_out("fifo_PE6_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_3_op0_config_out("fifo_PE6_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_3_op1_config_out("fifo_PE6_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_3_compute_config_out("fifo_PE6_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_3_res_config_out("fifo_PE6_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_4_op0_config_out("fifo_PE6_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_4_op1_config_out("fifo_PE6_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_4_compute_config_out("fifo_PE6_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_4_res_config_out("fifo_PE6_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_5_op0_config_out("fifo_PE6_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_5_op1_config_out("fifo_PE6_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_5_compute_config_out("fifo_PE6_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_5_res_config_out("fifo_PE6_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_6_op0_config_out("fifo_PE6_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_6_op1_config_out("fifo_PE6_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_6_compute_config_out("fifo_PE6_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_6_res_config_out("fifo_PE6_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_7_op0_config_out("fifo_PE6_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_7_op1_config_out("fifo_PE6_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_7_compute_config_out("fifo_PE6_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_7_res_config_out("fifo_PE6_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE6_8_op0_config_out("fifo_PE6_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE6_8_op1_config_out("fifo_PE6_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE6_8_compute_config_out("fifo_PE6_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE6_8_res_config_out("fifo_PE6_8_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_0_op0_config_out("fifo_PE7_0_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_0_op1_config_out("fifo_PE7_0_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_0_compute_config_out("fifo_PE7_0_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_0_res_config_out("fifo_PE7_0_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_1_op0_config_out("fifo_PE7_1_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_1_op1_config_out("fifo_PE7_1_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_1_compute_config_out("fifo_PE7_1_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_1_res_config_out("fifo_PE7_1_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_2_op0_config_out("fifo_PE7_2_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_2_op1_config_out("fifo_PE7_2_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_2_compute_config_out("fifo_PE7_2_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_2_res_config_out("fifo_PE7_2_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_3_op0_config_out("fifo_PE7_3_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_3_op1_config_out("fifo_PE7_3_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_3_compute_config_out("fifo_PE7_3_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_3_res_config_out("fifo_PE7_3_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_4_op0_config_out("fifo_PE7_4_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_4_op1_config_out("fifo_PE7_4_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_4_compute_config_out("fifo_PE7_4_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_4_res_config_out("fifo_PE7_4_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_5_op0_config_out("fifo_PE7_5_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_5_op1_config_out("fifo_PE7_5_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_5_compute_config_out("fifo_PE7_5_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_5_res_config_out("fifo_PE7_5_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_6_op0_config_out("fifo_PE7_6_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_6_op1_config_out("fifo_PE7_6_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_6_compute_config_out("fifo_PE7_6_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_6_res_config_out("fifo_PE7_6_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_7_op0_config_out("fifo_PE7_7_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_7_op1_config_out("fifo_PE7_7_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_7_compute_config_out("fifo_PE7_7_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_7_res_config_out("fifo_PE7_7_res_config_out");
  tapa::stream<uint, 2> fifo_PE7_8_op0_config_out("fifo_PE7_8_op0_config_out");
  tapa::stream<uint, 2> fifo_PE7_8_op1_config_out("fifo_PE7_8_op1_config_out");
  tapa::stream<uint, 2> fifo_PE7_8_compute_config_out("fifo_PE7_8_compute_config_out");
  tapa::stream<uint, 2> fifo_PE7_8_res_config_out("fifo_PE7_8_res_config_out");

  tapa::stream<U1_Data0PEChannelType, 2> PE0_0_fifo0_local("PE0_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_0_fifo1_local("PE0_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_0_fifo2_local("PE0_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_1_fifo0_local("PE0_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_1_fifo1_local("PE0_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_1_fifo2_local("PE0_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_2_fifo0_local("PE0_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_2_fifo1_local("PE0_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_2_fifo2_local("PE0_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_3_fifo0_local("PE0_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_3_fifo1_local("PE0_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_3_fifo2_local("PE0_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_4_fifo0_local("PE0_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_4_fifo1_local("PE0_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_4_fifo2_local("PE0_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_5_fifo0_local("PE0_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_5_fifo1_local("PE0_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_5_fifo2_local("PE0_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_6_fifo0_local("PE0_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_6_fifo1_local("PE0_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_6_fifo2_local("PE0_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_7_fifo0_local("PE0_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_7_fifo1_local("PE0_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_7_fifo2_local("PE0_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE0_8_fifo0_local("PE0_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE0_8_fifo1_local("PE0_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE0_8_fifo2_local("PE0_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_0_fifo0_local("PE1_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_0_fifo1_local("PE1_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_0_fifo2_local("PE1_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_1_fifo0_local("PE1_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_1_fifo1_local("PE1_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_1_fifo2_local("PE1_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_2_fifo0_local("PE1_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_2_fifo1_local("PE1_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_2_fifo2_local("PE1_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_3_fifo0_local("PE1_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_3_fifo1_local("PE1_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_3_fifo2_local("PE1_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_4_fifo0_local("PE1_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_4_fifo1_local("PE1_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_4_fifo2_local("PE1_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_5_fifo0_local("PE1_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_5_fifo1_local("PE1_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_5_fifo2_local("PE1_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_6_fifo0_local("PE1_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_6_fifo1_local("PE1_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_6_fifo2_local("PE1_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_7_fifo0_local("PE1_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_7_fifo1_local("PE1_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_7_fifo2_local("PE1_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE1_8_fifo0_local("PE1_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE1_8_fifo1_local("PE1_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE1_8_fifo2_local("PE1_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_0_fifo0_local("PE2_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_0_fifo1_local("PE2_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_0_fifo2_local("PE2_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_1_fifo0_local("PE2_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_1_fifo1_local("PE2_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_1_fifo2_local("PE2_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_2_fifo0_local("PE2_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_2_fifo1_local("PE2_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_2_fifo2_local("PE2_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_3_fifo0_local("PE2_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_3_fifo1_local("PE2_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_3_fifo2_local("PE2_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_4_fifo0_local("PE2_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_4_fifo1_local("PE2_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_4_fifo2_local("PE2_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_5_fifo0_local("PE2_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_5_fifo1_local("PE2_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_5_fifo2_local("PE2_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_6_fifo0_local("PE2_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_6_fifo1_local("PE2_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_6_fifo2_local("PE2_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_7_fifo0_local("PE2_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_7_fifo1_local("PE2_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_7_fifo2_local("PE2_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE2_8_fifo0_local("PE2_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE2_8_fifo1_local("PE2_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE2_8_fifo2_local("PE2_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_0_fifo0_local("PE3_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_0_fifo1_local("PE3_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_0_fifo2_local("PE3_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_1_fifo0_local("PE3_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_1_fifo1_local("PE3_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_1_fifo2_local("PE3_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_2_fifo0_local("PE3_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_2_fifo1_local("PE3_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_2_fifo2_local("PE3_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_3_fifo0_local("PE3_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_3_fifo1_local("PE3_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_3_fifo2_local("PE3_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_4_fifo0_local("PE3_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_4_fifo1_local("PE3_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_4_fifo2_local("PE3_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_5_fifo0_local("PE3_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_5_fifo1_local("PE3_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_5_fifo2_local("PE3_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_6_fifo0_local("PE3_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_6_fifo1_local("PE3_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_6_fifo2_local("PE3_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_7_fifo0_local("PE3_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_7_fifo1_local("PE3_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_7_fifo2_local("PE3_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE3_8_fifo0_local("PE3_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE3_8_fifo1_local("PE3_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE3_8_fifo2_local("PE3_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_0_fifo0_local("PE4_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_0_fifo1_local("PE4_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_0_fifo2_local("PE4_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_1_fifo0_local("PE4_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_1_fifo1_local("PE4_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_1_fifo2_local("PE4_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_2_fifo0_local("PE4_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_2_fifo1_local("PE4_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_2_fifo2_local("PE4_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_3_fifo0_local("PE4_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_3_fifo1_local("PE4_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_3_fifo2_local("PE4_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_4_fifo0_local("PE4_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_4_fifo1_local("PE4_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_4_fifo2_local("PE4_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_5_fifo0_local("PE4_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_5_fifo1_local("PE4_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_5_fifo2_local("PE4_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_6_fifo0_local("PE4_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_6_fifo1_local("PE4_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_6_fifo2_local("PE4_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_7_fifo0_local("PE4_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_7_fifo1_local("PE4_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_7_fifo2_local("PE4_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE4_8_fifo0_local("PE4_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE4_8_fifo1_local("PE4_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE4_8_fifo2_local("PE4_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_0_fifo0_local("PE5_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_0_fifo1_local("PE5_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_0_fifo2_local("PE5_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_1_fifo0_local("PE5_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_1_fifo1_local("PE5_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_1_fifo2_local("PE5_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_2_fifo0_local("PE5_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_2_fifo1_local("PE5_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_2_fifo2_local("PE5_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_3_fifo0_local("PE5_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_3_fifo1_local("PE5_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_3_fifo2_local("PE5_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_4_fifo0_local("PE5_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_4_fifo1_local("PE5_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_4_fifo2_local("PE5_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_5_fifo0_local("PE5_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_5_fifo1_local("PE5_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_5_fifo2_local("PE5_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_6_fifo0_local("PE5_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_6_fifo1_local("PE5_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_6_fifo2_local("PE5_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_7_fifo0_local("PE5_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_7_fifo1_local("PE5_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_7_fifo2_local("PE5_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE5_8_fifo0_local("PE5_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE5_8_fifo1_local("PE5_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE5_8_fifo2_local("PE5_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_0_fifo0_local("PE6_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_0_fifo1_local("PE6_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_0_fifo2_local("PE6_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_1_fifo0_local("PE6_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_1_fifo1_local("PE6_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_1_fifo2_local("PE6_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_2_fifo0_local("PE6_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_2_fifo1_local("PE6_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_2_fifo2_local("PE6_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_3_fifo0_local("PE6_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_3_fifo1_local("PE6_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_3_fifo2_local("PE6_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_4_fifo0_local("PE6_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_4_fifo1_local("PE6_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_4_fifo2_local("PE6_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_5_fifo0_local("PE6_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_5_fifo1_local("PE6_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_5_fifo2_local("PE6_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_6_fifo0_local("PE6_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_6_fifo1_local("PE6_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_6_fifo2_local("PE6_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_7_fifo0_local("PE6_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_7_fifo1_local("PE6_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_7_fifo2_local("PE6_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE6_8_fifo0_local("PE6_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE6_8_fifo1_local("PE6_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE6_8_fifo2_local("PE6_8_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_0_fifo0_local("PE7_0_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_0_fifo1_local("PE7_0_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_0_fifo2_local("PE7_0_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_1_fifo0_local("PE7_1_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_1_fifo1_local("PE7_1_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_1_fifo2_local("PE7_1_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_2_fifo0_local("PE7_2_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_2_fifo1_local("PE7_2_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_2_fifo2_local("PE7_2_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_3_fifo0_local("PE7_3_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_3_fifo1_local("PE7_3_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_3_fifo2_local("PE7_3_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_4_fifo0_local("PE7_4_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_4_fifo1_local("PE7_4_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_4_fifo2_local("PE7_4_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_5_fifo0_local("PE7_5_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_5_fifo1_local("PE7_5_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_5_fifo2_local("PE7_5_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_6_fifo0_local("PE7_6_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_6_fifo1_local("PE7_6_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_6_fifo2_local("PE7_6_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_7_fifo0_local("PE7_7_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_7_fifo1_local("PE7_7_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_7_fifo2_local("PE7_7_fifo2_local");
  tapa::stream<U1_Data0PEChannelType, 2> PE7_8_fifo0_local("PE7_8_fifo0_local");
  tapa::stream<U1_Data1PEChannelType, 2> PE7_8_fifo1_local("PE7_8_fifo1_local");
  tapa::stream<U1_Data2PEChannelType, 2> PE7_8_fifo2_local("PE7_8_fifo2_local");

  tapa::stream<CinLoadData0Type, 128> fifo_data_bypass("fifo_data_bypass");
  tapa::stream<uint, 2> fifo_config_bypass("fifo_config_bypass");
  //data fifos
  tapa::stream<CinLoadData0Type, 128> cin_load_to_SA_0("cin_load_to_SA_0");
  tapa::stream<CinLoadData0Type, 128> weight_load_to_SA_0("weight_load_to_SA_0");
  tapa::stream<CinLoadData0Type, 128> bias_load_to_act_and_bn_0("bias_load_to_act_and_bn_0");
  tapa::stream<CinLoadData0Type, 128> bias_load_to_act_and_bn_1("bias_load_to_act_and_bn_1");
  tapa::stream<CinLoadData0Type, 128> cin_load_prev_to_pool_0("cin_load_prev_to_pool_0");
  tapa::stream<CinLoadData0Type, 128> SA_to_upsample_0("SA_to_upsample_0");
  tapa::stream<CinLoadData0Type, 128> pool_to_concat_0("pool_to_concat_0");
  tapa::stream<CinLoadData0Type, 128> upsample_to_concat_0("upsample_to_concat_0");
  tapa::stream<CinLoadData0Type, 128> concat_to_add_0("concat_to_add_0");
  tapa::stream<CinLoadData0Type, 128> concat_to_add_1("concat_to_add_1");
  tapa::stream<CinLoadData0Type, 128> add_to_act_and_bn_0("add_to_act_and_bn_0");
  tapa::stream<CinLoadData0Type, 128> act_and_bn_to_cout_write_0("act_and_bn_to_cout_write_0");
  //instruction fifos
  tapa::stream<ConfigInst,16> config_cin_load_to_weight_load("config_cin_load_to_weight_load");
  tapa::stream<ConfigInst,16> config_weight_load_to_bias_load("config_weight_load_to_bias_load");
  tapa::stream<ConfigInst,16> config_bias_load_to_cin_load_prev("config_bias_load_to_cin_load_prev");
  tapa::stream<ConfigInst,16> config_cin_load_prev_to_SA("config_cin_load_prev_to_SA");
  tapa::stream<ConfigInst,16> config_SA_to_pool("config_SA_to_pool");
  tapa::stream<ConfigInst,16> config_pool_to_upsample("config_pool_to_upsample");
  tapa::stream<ConfigInst,16> config_upsample_to_concat("config_upsample_to_concat");
  tapa::stream<ConfigInst,16> config_concat_to_add("config_concat_to_add");
  tapa::stream<ConfigInst,16> config_add_to_act_and_bn("config_add_to_act_and_bn");
  tapa::stream<ConfigInst,16> config_act_and_bn_to_cout_write("config_act_and_bn_to_cout_write");
  //synchronization fifos
  tapa::stream<int> cin_to_cout_sync("cin_to_cout_sync");
  tapa::stream<int> cout_to_cin_sync("cout_to_cin_sync");
  tapa::task()
  .invoke(cin_load, 
  		start_inst, end_inst,
  		dram_b0, 
  		layer_config,
  		cin_load_to_SA_0, 
  		config_cin_load_to_weight_load
  , cout_to_cin_sync, cin_to_cout_sync
  )
  .invoke(weight_load, 
  		start_inst, end_inst,
  		dram_weights, 
  		config_cin_load_to_weight_load,
  		weight_load_to_SA_0, 
  		config_weight_load_to_bias_load
  )
  .invoke(bias_load, 
  		start_inst, end_inst,
  		dram_biases, 
  		config_weight_load_to_bias_load,
  		bias_load_to_act_and_bn_0, 
  		bias_load_to_act_and_bn_1, 
  		config_bias_load_to_cin_load_prev
  )
  .invoke(cin_load_prev, 
  		start_inst, end_inst,
  		dram_b0, 
  		config_bias_load_to_cin_load_prev,
  		cin_load_prev_to_pool_0, 
  		config_cin_load_prev_to_SA
  )
  .invoke(U1_DataFeed0Head,
    start_inst, end_inst,
    cin_load_to_SA_0,
    fifo0_transfer0,
    config_cin_load_prev_to_SA,
    config_SA_to_pool,
    fifo_DataFeed0Head_config_out0, fifo_DataFeed0Head_config_out1,
    fifo_data_bypass,
    fifo_config_bypass
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer0,
    fifo0_transfer1,
    fifo0_feed0_0,
    0,
    fifo_DataFeed0Head_config_out0,
    fifo_DataFeed0Engine0_config_out0,
    fifo_DataFeed0Engine0_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer1,
    fifo0_transfer2,
    fifo0_feed0_1,
    1,
    fifo_DataFeed0Engine0_config_out0,
    fifo_DataFeed0Engine1_config_out0,
    fifo_DataFeed0Engine1_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer2,
    fifo0_transfer3,
    fifo0_feed0_2,
    2,
    fifo_DataFeed0Engine1_config_out0,
    fifo_DataFeed0Engine2_config_out0,
    fifo_DataFeed0Engine2_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer3,
    fifo0_transfer4,
    fifo0_feed0_3,
    3,
    fifo_DataFeed0Engine2_config_out0,
    fifo_DataFeed0Engine3_config_out0,
    fifo_DataFeed0Engine3_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer4,
    fifo0_transfer5,
    fifo0_feed0_4,
    4,
    fifo_DataFeed0Engine3_config_out0,
    fifo_DataFeed0Engine4_config_out0,
    fifo_DataFeed0Engine4_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer5,
    fifo0_transfer6,
    fifo0_feed0_5,
    5,
    fifo_DataFeed0Engine4_config_out0,
    fifo_DataFeed0Engine5_config_out0,
    fifo_DataFeed0Engine5_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer6,
    fifo0_transfer7,
    fifo0_feed0_6,
    6,
    fifo_DataFeed0Engine5_config_out0,
    fifo_DataFeed0Engine6_config_out0,
    fifo_DataFeed0Engine6_config_out1
  )
  .invoke(U1_DataFeed0Engine0_wrapper,
    fifo0_transfer7,
    fifo0_transfer8,
    fifo0_feed0_7,
    7,
    fifo_DataFeed0Engine6_config_out0,
    fifo_DataFeed0Engine7_config_out0,
    fifo_DataFeed0Engine7_config_out1
  )
  .invoke(U1_DataFeed0EngineLast,
    fifo0_transfer8,
    fifo0_feed0_8,
    8,
    fifo_DataFeed0Engine7_config_out0,
    fifo_DataFeed0Engine8_config_out1
  )
  .invoke(U1_DataFeed1Head,
    weight_load_to_SA_0,
    fifo1_transfer0,
    fifo_DataFeed0Head_config_out1, fifo_DataFeed1Head_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer0,
    fifo1_transfer1,
    fifo1_feed0_0,
    0,
    fifo_DataFeed1Head_config_out0,
    fifo_DataFeed1Engine0_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer1,
    fifo1_transfer2,
    fifo1_feed1_0,
    1,
    fifo_DataFeed1Engine0_config_out0,
    fifo_DataFeed1Engine1_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer2,
    fifo1_transfer3,
    fifo1_feed2_0,
    2,
    fifo_DataFeed1Engine1_config_out0,
    fifo_DataFeed1Engine2_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer3,
    fifo1_transfer4,
    fifo1_feed3_0,
    3,
    fifo_DataFeed1Engine2_config_out0,
    fifo_DataFeed1Engine3_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer4,
    fifo1_transfer5,
    fifo1_feed4_0,
    4,
    fifo_DataFeed1Engine3_config_out0,
    fifo_DataFeed1Engine4_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer5,
    fifo1_transfer6,
    fifo1_feed5_0,
    5,
    fifo_DataFeed1Engine4_config_out0,
    fifo_DataFeed1Engine5_config_out0
  )
  .invoke(U1_DataFeed1Engine0_wrapper,
    fifo1_transfer6,
    fifo1_transfer7,
    fifo1_feed6_0,
    6,
    fifo_DataFeed1Engine5_config_out0,
    fifo_DataFeed1Engine6_config_out0
  )
  .invoke(U1_DataFeed1EngineLast,
    fifo1_transfer7,
    fifo1_feed7_0,
    7,
    fifo_DataFeed1Engine6_config_out0
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_0,
    fifo0_feed1_0,
    PE0_0_fifo0_local,
    fifo_DataFeed0Engine0_config_out1,
    fifo_PE0_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_0,
    fifo1_feed0_1,
    PE0_0_fifo1_local,
    fifo_PE0_0_op0_config_out,
    fifo_PE0_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_0_fifo0_local,
    PE0_0_fifo1_local,
    PE0_0_fifo2_local,
    fifo_PE0_0_op1_config_out,
    fifo_PE0_0_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_0_fifo2_local,
    fifo2_collect0_0,
    0,
    0,
    fifo_PE0_0_compute_config_out,
    fifo_PE0_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_1,
    fifo0_feed1_1,
    PE0_1_fifo0_local,
    fifo_DataFeed0Engine1_config_out1,
    fifo_PE0_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_1,
    fifo1_feed0_2,
    PE0_1_fifo1_local,
    fifo_PE0_1_op0_config_out,
    fifo_PE0_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_1_fifo0_local,
    PE0_1_fifo1_local,
    PE0_1_fifo2_local,
    fifo_PE0_1_op1_config_out,
    fifo_PE0_1_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_1_fifo2_local,
    fifo2_collect0_1,
    0,
    1,
    fifo_PE0_1_compute_config_out,
    fifo_PE0_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_2,
    fifo0_feed1_2,
    PE0_2_fifo0_local,
    fifo_DataFeed0Engine2_config_out1,
    fifo_PE0_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_2,
    fifo1_feed0_3,
    PE0_2_fifo1_local,
    fifo_PE0_2_op0_config_out,
    fifo_PE0_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_2_fifo0_local,
    PE0_2_fifo1_local,
    PE0_2_fifo2_local,
    fifo_PE0_2_op1_config_out,
    fifo_PE0_2_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_2_fifo2_local,
    fifo2_collect0_2,
    0,
    2,
    fifo_PE0_2_compute_config_out,
    fifo_PE0_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_3,
    fifo0_feed1_3,
    PE0_3_fifo0_local,
    fifo_DataFeed0Engine3_config_out1,
    fifo_PE0_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_3,
    fifo1_feed0_4,
    PE0_3_fifo1_local,
    fifo_PE0_3_op0_config_out,
    fifo_PE0_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_3_fifo0_local,
    PE0_3_fifo1_local,
    PE0_3_fifo2_local,
    fifo_PE0_3_op1_config_out,
    fifo_PE0_3_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_3_fifo2_local,
    fifo2_collect0_3,
    0,
    3,
    fifo_PE0_3_compute_config_out,
    fifo_PE0_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_4,
    fifo0_feed1_4,
    PE0_4_fifo0_local,
    fifo_DataFeed0Engine4_config_out1,
    fifo_PE0_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_4,
    fifo1_feed0_5,
    PE0_4_fifo1_local,
    fifo_PE0_4_op0_config_out,
    fifo_PE0_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_4_fifo0_local,
    PE0_4_fifo1_local,
    PE0_4_fifo2_local,
    fifo_PE0_4_op1_config_out,
    fifo_PE0_4_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_4_fifo2_local,
    fifo2_collect0_4,
    0,
    4,
    fifo_PE0_4_compute_config_out,
    fifo_PE0_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_5,
    fifo0_feed1_5,
    PE0_5_fifo0_local,
    fifo_DataFeed0Engine5_config_out1,
    fifo_PE0_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_5,
    fifo1_feed0_6,
    PE0_5_fifo1_local,
    fifo_PE0_5_op0_config_out,
    fifo_PE0_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_5_fifo0_local,
    PE0_5_fifo1_local,
    PE0_5_fifo2_local,
    fifo_PE0_5_op1_config_out,
    fifo_PE0_5_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_5_fifo2_local,
    fifo2_collect0_5,
    0,
    5,
    fifo_PE0_5_compute_config_out,
    fifo_PE0_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_6,
    fifo0_feed1_6,
    PE0_6_fifo0_local,
    fifo_DataFeed0Engine6_config_out1,
    fifo_PE0_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_6,
    fifo1_feed0_7,
    PE0_6_fifo1_local,
    fifo_PE0_6_op0_config_out,
    fifo_PE0_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_6_fifo0_local,
    PE0_6_fifo1_local,
    PE0_6_fifo2_local,
    fifo_PE0_6_op1_config_out,
    fifo_PE0_6_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_6_fifo2_local,
    fifo2_collect0_6,
    0,
    6,
    fifo_PE0_6_compute_config_out,
    fifo_PE0_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_7,
    fifo0_feed1_7,
    PE0_7_fifo0_local,
    fifo_DataFeed0Engine7_config_out1,
    fifo_PE0_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed0_7,
    fifo1_feed0_8,
    PE0_7_fifo1_local,
    fifo_PE0_7_op0_config_out,
    fifo_PE0_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_7_fifo0_local,
    PE0_7_fifo1_local,
    PE0_7_fifo2_local,
    fifo_PE0_7_op1_config_out,
    fifo_PE0_7_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_7_fifo2_local,
    fifo2_collect0_7,
    0,
    7,
    fifo_PE0_7_compute_config_out,
    fifo_PE0_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed0_8,
    fifo0_feed1_8,
    PE0_8_fifo0_local,
    fifo_DataFeed0Engine8_config_out1,
    fifo_PE0_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed0_8,
    PE0_8_fifo1_local,
    fifo_PE0_8_op0_config_out,
    fifo_PE0_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE0_8_fifo0_local,
    PE0_8_fifo1_local,
    PE0_8_fifo2_local,
    fifo_PE0_8_op1_config_out,
    fifo_PE0_8_compute_config_out
  )
  .invoke(U1_res_transfer_first_wrapper,
    PE0_8_fifo2_local,
    fifo2_collect0_8,
    0,
    8,
    fifo_PE0_8_compute_config_out,
    fifo_PE0_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_0,
    fifo0_feed2_0,
    PE1_0_fifo0_local,
    fifo_PE0_0_res_config_out,
    fifo_PE1_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_0,
    fifo1_feed1_1,
    PE1_0_fifo1_local,
    fifo_PE1_0_op0_config_out,
    fifo_PE1_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_0_fifo0_local,
    PE1_0_fifo1_local,
    PE1_0_fifo2_local,
    fifo_PE1_0_op1_config_out,
    fifo_PE1_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_0_fifo2_local,
    fifo2_collect0_0,
    fifo2_collect1_0,
    1,
    0,
    fifo_PE1_0_compute_config_out,
    fifo_PE1_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_1,
    fifo0_feed2_1,
    PE1_1_fifo0_local,
    fifo_PE0_1_res_config_out,
    fifo_PE1_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_1,
    fifo1_feed1_2,
    PE1_1_fifo1_local,
    fifo_PE1_1_op0_config_out,
    fifo_PE1_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_1_fifo0_local,
    PE1_1_fifo1_local,
    PE1_1_fifo2_local,
    fifo_PE1_1_op1_config_out,
    fifo_PE1_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_1_fifo2_local,
    fifo2_collect0_1,
    fifo2_collect1_1,
    1,
    1,
    fifo_PE1_1_compute_config_out,
    fifo_PE1_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_2,
    fifo0_feed2_2,
    PE1_2_fifo0_local,
    fifo_PE0_2_res_config_out,
    fifo_PE1_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_2,
    fifo1_feed1_3,
    PE1_2_fifo1_local,
    fifo_PE1_2_op0_config_out,
    fifo_PE1_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_2_fifo0_local,
    PE1_2_fifo1_local,
    PE1_2_fifo2_local,
    fifo_PE1_2_op1_config_out,
    fifo_PE1_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_2_fifo2_local,
    fifo2_collect0_2,
    fifo2_collect1_2,
    1,
    2,
    fifo_PE1_2_compute_config_out,
    fifo_PE1_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_3,
    fifo0_feed2_3,
    PE1_3_fifo0_local,
    fifo_PE0_3_res_config_out,
    fifo_PE1_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_3,
    fifo1_feed1_4,
    PE1_3_fifo1_local,
    fifo_PE1_3_op0_config_out,
    fifo_PE1_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_3_fifo0_local,
    PE1_3_fifo1_local,
    PE1_3_fifo2_local,
    fifo_PE1_3_op1_config_out,
    fifo_PE1_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_3_fifo2_local,
    fifo2_collect0_3,
    fifo2_collect1_3,
    1,
    3,
    fifo_PE1_3_compute_config_out,
    fifo_PE1_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_4,
    fifo0_feed2_4,
    PE1_4_fifo0_local,
    fifo_PE0_4_res_config_out,
    fifo_PE1_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_4,
    fifo1_feed1_5,
    PE1_4_fifo1_local,
    fifo_PE1_4_op0_config_out,
    fifo_PE1_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_4_fifo0_local,
    PE1_4_fifo1_local,
    PE1_4_fifo2_local,
    fifo_PE1_4_op1_config_out,
    fifo_PE1_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_4_fifo2_local,
    fifo2_collect0_4,
    fifo2_collect1_4,
    1,
    4,
    fifo_PE1_4_compute_config_out,
    fifo_PE1_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_5,
    fifo0_feed2_5,
    PE1_5_fifo0_local,
    fifo_PE0_5_res_config_out,
    fifo_PE1_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_5,
    fifo1_feed1_6,
    PE1_5_fifo1_local,
    fifo_PE1_5_op0_config_out,
    fifo_PE1_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_5_fifo0_local,
    PE1_5_fifo1_local,
    PE1_5_fifo2_local,
    fifo_PE1_5_op1_config_out,
    fifo_PE1_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_5_fifo2_local,
    fifo2_collect0_5,
    fifo2_collect1_5,
    1,
    5,
    fifo_PE1_5_compute_config_out,
    fifo_PE1_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_6,
    fifo0_feed2_6,
    PE1_6_fifo0_local,
    fifo_PE0_6_res_config_out,
    fifo_PE1_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_6,
    fifo1_feed1_7,
    PE1_6_fifo1_local,
    fifo_PE1_6_op0_config_out,
    fifo_PE1_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_6_fifo0_local,
    PE1_6_fifo1_local,
    PE1_6_fifo2_local,
    fifo_PE1_6_op1_config_out,
    fifo_PE1_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_6_fifo2_local,
    fifo2_collect0_6,
    fifo2_collect1_6,
    1,
    6,
    fifo_PE1_6_compute_config_out,
    fifo_PE1_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_7,
    fifo0_feed2_7,
    PE1_7_fifo0_local,
    fifo_PE0_7_res_config_out,
    fifo_PE1_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed1_7,
    fifo1_feed1_8,
    PE1_7_fifo1_local,
    fifo_PE1_7_op0_config_out,
    fifo_PE1_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_7_fifo0_local,
    PE1_7_fifo1_local,
    PE1_7_fifo2_local,
    fifo_PE1_7_op1_config_out,
    fifo_PE1_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_7_fifo2_local,
    fifo2_collect0_7,
    fifo2_collect1_7,
    1,
    7,
    fifo_PE1_7_compute_config_out,
    fifo_PE1_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed1_8,
    fifo0_feed2_8,
    PE1_8_fifo0_local,
    fifo_PE0_8_res_config_out,
    fifo_PE1_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed1_8,
    PE1_8_fifo1_local,
    fifo_PE1_8_op0_config_out,
    fifo_PE1_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE1_8_fifo0_local,
    PE1_8_fifo1_local,
    PE1_8_fifo2_local,
    fifo_PE1_8_op1_config_out,
    fifo_PE1_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE1_8_fifo2_local,
    fifo2_collect0_8,
    fifo2_collect1_8,
    1,
    8,
    fifo_PE1_8_compute_config_out,
    fifo_PE1_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_0,
    fifo0_feed3_0,
    PE2_0_fifo0_local,
    fifo_PE1_0_res_config_out,
    fifo_PE2_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_0,
    fifo1_feed2_1,
    PE2_0_fifo1_local,
    fifo_PE2_0_op0_config_out,
    fifo_PE2_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_0_fifo0_local,
    PE2_0_fifo1_local,
    PE2_0_fifo2_local,
    fifo_PE2_0_op1_config_out,
    fifo_PE2_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_0_fifo2_local,
    fifo2_collect1_0,
    fifo2_collect2_0,
    2,
    0,
    fifo_PE2_0_compute_config_out,
    fifo_PE2_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_1,
    fifo0_feed3_1,
    PE2_1_fifo0_local,
    fifo_PE1_1_res_config_out,
    fifo_PE2_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_1,
    fifo1_feed2_2,
    PE2_1_fifo1_local,
    fifo_PE2_1_op0_config_out,
    fifo_PE2_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_1_fifo0_local,
    PE2_1_fifo1_local,
    PE2_1_fifo2_local,
    fifo_PE2_1_op1_config_out,
    fifo_PE2_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_1_fifo2_local,
    fifo2_collect1_1,
    fifo2_collect2_1,
    2,
    1,
    fifo_PE2_1_compute_config_out,
    fifo_PE2_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_2,
    fifo0_feed3_2,
    PE2_2_fifo0_local,
    fifo_PE1_2_res_config_out,
    fifo_PE2_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_2,
    fifo1_feed2_3,
    PE2_2_fifo1_local,
    fifo_PE2_2_op0_config_out,
    fifo_PE2_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_2_fifo0_local,
    PE2_2_fifo1_local,
    PE2_2_fifo2_local,
    fifo_PE2_2_op1_config_out,
    fifo_PE2_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_2_fifo2_local,
    fifo2_collect1_2,
    fifo2_collect2_2,
    2,
    2,
    fifo_PE2_2_compute_config_out,
    fifo_PE2_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_3,
    fifo0_feed3_3,
    PE2_3_fifo0_local,
    fifo_PE1_3_res_config_out,
    fifo_PE2_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_3,
    fifo1_feed2_4,
    PE2_3_fifo1_local,
    fifo_PE2_3_op0_config_out,
    fifo_PE2_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_3_fifo0_local,
    PE2_3_fifo1_local,
    PE2_3_fifo2_local,
    fifo_PE2_3_op1_config_out,
    fifo_PE2_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_3_fifo2_local,
    fifo2_collect1_3,
    fifo2_collect2_3,
    2,
    3,
    fifo_PE2_3_compute_config_out,
    fifo_PE2_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_4,
    fifo0_feed3_4,
    PE2_4_fifo0_local,
    fifo_PE1_4_res_config_out,
    fifo_PE2_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_4,
    fifo1_feed2_5,
    PE2_4_fifo1_local,
    fifo_PE2_4_op0_config_out,
    fifo_PE2_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_4_fifo0_local,
    PE2_4_fifo1_local,
    PE2_4_fifo2_local,
    fifo_PE2_4_op1_config_out,
    fifo_PE2_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_4_fifo2_local,
    fifo2_collect1_4,
    fifo2_collect2_4,
    2,
    4,
    fifo_PE2_4_compute_config_out,
    fifo_PE2_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_5,
    fifo0_feed3_5,
    PE2_5_fifo0_local,
    fifo_PE1_5_res_config_out,
    fifo_PE2_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_5,
    fifo1_feed2_6,
    PE2_5_fifo1_local,
    fifo_PE2_5_op0_config_out,
    fifo_PE2_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_5_fifo0_local,
    PE2_5_fifo1_local,
    PE2_5_fifo2_local,
    fifo_PE2_5_op1_config_out,
    fifo_PE2_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_5_fifo2_local,
    fifo2_collect1_5,
    fifo2_collect2_5,
    2,
    5,
    fifo_PE2_5_compute_config_out,
    fifo_PE2_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_6,
    fifo0_feed3_6,
    PE2_6_fifo0_local,
    fifo_PE1_6_res_config_out,
    fifo_PE2_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_6,
    fifo1_feed2_7,
    PE2_6_fifo1_local,
    fifo_PE2_6_op0_config_out,
    fifo_PE2_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_6_fifo0_local,
    PE2_6_fifo1_local,
    PE2_6_fifo2_local,
    fifo_PE2_6_op1_config_out,
    fifo_PE2_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_6_fifo2_local,
    fifo2_collect1_6,
    fifo2_collect2_6,
    2,
    6,
    fifo_PE2_6_compute_config_out,
    fifo_PE2_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_7,
    fifo0_feed3_7,
    PE2_7_fifo0_local,
    fifo_PE1_7_res_config_out,
    fifo_PE2_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed2_7,
    fifo1_feed2_8,
    PE2_7_fifo1_local,
    fifo_PE2_7_op0_config_out,
    fifo_PE2_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_7_fifo0_local,
    PE2_7_fifo1_local,
    PE2_7_fifo2_local,
    fifo_PE2_7_op1_config_out,
    fifo_PE2_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_7_fifo2_local,
    fifo2_collect1_7,
    fifo2_collect2_7,
    2,
    7,
    fifo_PE2_7_compute_config_out,
    fifo_PE2_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed2_8,
    fifo0_feed3_8,
    PE2_8_fifo0_local,
    fifo_PE1_8_res_config_out,
    fifo_PE2_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed2_8,
    PE2_8_fifo1_local,
    fifo_PE2_8_op0_config_out,
    fifo_PE2_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE2_8_fifo0_local,
    PE2_8_fifo1_local,
    PE2_8_fifo2_local,
    fifo_PE2_8_op1_config_out,
    fifo_PE2_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE2_8_fifo2_local,
    fifo2_collect1_8,
    fifo2_collect2_8,
    2,
    8,
    fifo_PE2_8_compute_config_out,
    fifo_PE2_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_0,
    fifo0_feed4_0,
    PE3_0_fifo0_local,
    fifo_PE2_0_res_config_out,
    fifo_PE3_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_0,
    fifo1_feed3_1,
    PE3_0_fifo1_local,
    fifo_PE3_0_op0_config_out,
    fifo_PE3_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_0_fifo0_local,
    PE3_0_fifo1_local,
    PE3_0_fifo2_local,
    fifo_PE3_0_op1_config_out,
    fifo_PE3_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_0_fifo2_local,
    fifo2_collect2_0,
    fifo2_collect3_0,
    3,
    0,
    fifo_PE3_0_compute_config_out,
    fifo_PE3_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_1,
    fifo0_feed4_1,
    PE3_1_fifo0_local,
    fifo_PE2_1_res_config_out,
    fifo_PE3_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_1,
    fifo1_feed3_2,
    PE3_1_fifo1_local,
    fifo_PE3_1_op0_config_out,
    fifo_PE3_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_1_fifo0_local,
    PE3_1_fifo1_local,
    PE3_1_fifo2_local,
    fifo_PE3_1_op1_config_out,
    fifo_PE3_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_1_fifo2_local,
    fifo2_collect2_1,
    fifo2_collect3_1,
    3,
    1,
    fifo_PE3_1_compute_config_out,
    fifo_PE3_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_2,
    fifo0_feed4_2,
    PE3_2_fifo0_local,
    fifo_PE2_2_res_config_out,
    fifo_PE3_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_2,
    fifo1_feed3_3,
    PE3_2_fifo1_local,
    fifo_PE3_2_op0_config_out,
    fifo_PE3_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_2_fifo0_local,
    PE3_2_fifo1_local,
    PE3_2_fifo2_local,
    fifo_PE3_2_op1_config_out,
    fifo_PE3_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_2_fifo2_local,
    fifo2_collect2_2,
    fifo2_collect3_2,
    3,
    2,
    fifo_PE3_2_compute_config_out,
    fifo_PE3_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_3,
    fifo0_feed4_3,
    PE3_3_fifo0_local,
    fifo_PE2_3_res_config_out,
    fifo_PE3_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_3,
    fifo1_feed3_4,
    PE3_3_fifo1_local,
    fifo_PE3_3_op0_config_out,
    fifo_PE3_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_3_fifo0_local,
    PE3_3_fifo1_local,
    PE3_3_fifo2_local,
    fifo_PE3_3_op1_config_out,
    fifo_PE3_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_3_fifo2_local,
    fifo2_collect2_3,
    fifo2_collect3_3,
    3,
    3,
    fifo_PE3_3_compute_config_out,
    fifo_PE3_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_4,
    fifo0_feed4_4,
    PE3_4_fifo0_local,
    fifo_PE2_4_res_config_out,
    fifo_PE3_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_4,
    fifo1_feed3_5,
    PE3_4_fifo1_local,
    fifo_PE3_4_op0_config_out,
    fifo_PE3_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_4_fifo0_local,
    PE3_4_fifo1_local,
    PE3_4_fifo2_local,
    fifo_PE3_4_op1_config_out,
    fifo_PE3_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_4_fifo2_local,
    fifo2_collect2_4,
    fifo2_collect3_4,
    3,
    4,
    fifo_PE3_4_compute_config_out,
    fifo_PE3_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_5,
    fifo0_feed4_5,
    PE3_5_fifo0_local,
    fifo_PE2_5_res_config_out,
    fifo_PE3_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_5,
    fifo1_feed3_6,
    PE3_5_fifo1_local,
    fifo_PE3_5_op0_config_out,
    fifo_PE3_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_5_fifo0_local,
    PE3_5_fifo1_local,
    PE3_5_fifo2_local,
    fifo_PE3_5_op1_config_out,
    fifo_PE3_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_5_fifo2_local,
    fifo2_collect2_5,
    fifo2_collect3_5,
    3,
    5,
    fifo_PE3_5_compute_config_out,
    fifo_PE3_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_6,
    fifo0_feed4_6,
    PE3_6_fifo0_local,
    fifo_PE2_6_res_config_out,
    fifo_PE3_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_6,
    fifo1_feed3_7,
    PE3_6_fifo1_local,
    fifo_PE3_6_op0_config_out,
    fifo_PE3_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_6_fifo0_local,
    PE3_6_fifo1_local,
    PE3_6_fifo2_local,
    fifo_PE3_6_op1_config_out,
    fifo_PE3_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_6_fifo2_local,
    fifo2_collect2_6,
    fifo2_collect3_6,
    3,
    6,
    fifo_PE3_6_compute_config_out,
    fifo_PE3_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_7,
    fifo0_feed4_7,
    PE3_7_fifo0_local,
    fifo_PE2_7_res_config_out,
    fifo_PE3_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed3_7,
    fifo1_feed3_8,
    PE3_7_fifo1_local,
    fifo_PE3_7_op0_config_out,
    fifo_PE3_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_7_fifo0_local,
    PE3_7_fifo1_local,
    PE3_7_fifo2_local,
    fifo_PE3_7_op1_config_out,
    fifo_PE3_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_7_fifo2_local,
    fifo2_collect2_7,
    fifo2_collect3_7,
    3,
    7,
    fifo_PE3_7_compute_config_out,
    fifo_PE3_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed3_8,
    fifo0_feed4_8,
    PE3_8_fifo0_local,
    fifo_PE2_8_res_config_out,
    fifo_PE3_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed3_8,
    PE3_8_fifo1_local,
    fifo_PE3_8_op0_config_out,
    fifo_PE3_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE3_8_fifo0_local,
    PE3_8_fifo1_local,
    PE3_8_fifo2_local,
    fifo_PE3_8_op1_config_out,
    fifo_PE3_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE3_8_fifo2_local,
    fifo2_collect2_8,
    fifo2_collect3_8,
    3,
    8,
    fifo_PE3_8_compute_config_out,
    fifo_PE3_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_0,
    fifo0_feed5_0,
    PE4_0_fifo0_local,
    fifo_PE3_0_res_config_out,
    fifo_PE4_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_0,
    fifo1_feed4_1,
    PE4_0_fifo1_local,
    fifo_PE4_0_op0_config_out,
    fifo_PE4_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_0_fifo0_local,
    PE4_0_fifo1_local,
    PE4_0_fifo2_local,
    fifo_PE4_0_op1_config_out,
    fifo_PE4_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_0_fifo2_local,
    fifo2_collect3_0,
    fifo2_collect4_0,
    4,
    0,
    fifo_PE4_0_compute_config_out,
    fifo_PE4_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_1,
    fifo0_feed5_1,
    PE4_1_fifo0_local,
    fifo_PE3_1_res_config_out,
    fifo_PE4_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_1,
    fifo1_feed4_2,
    PE4_1_fifo1_local,
    fifo_PE4_1_op0_config_out,
    fifo_PE4_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_1_fifo0_local,
    PE4_1_fifo1_local,
    PE4_1_fifo2_local,
    fifo_PE4_1_op1_config_out,
    fifo_PE4_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_1_fifo2_local,
    fifo2_collect3_1,
    fifo2_collect4_1,
    4,
    1,
    fifo_PE4_1_compute_config_out,
    fifo_PE4_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_2,
    fifo0_feed5_2,
    PE4_2_fifo0_local,
    fifo_PE3_2_res_config_out,
    fifo_PE4_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_2,
    fifo1_feed4_3,
    PE4_2_fifo1_local,
    fifo_PE4_2_op0_config_out,
    fifo_PE4_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_2_fifo0_local,
    PE4_2_fifo1_local,
    PE4_2_fifo2_local,
    fifo_PE4_2_op1_config_out,
    fifo_PE4_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_2_fifo2_local,
    fifo2_collect3_2,
    fifo2_collect4_2,
    4,
    2,
    fifo_PE4_2_compute_config_out,
    fifo_PE4_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_3,
    fifo0_feed5_3,
    PE4_3_fifo0_local,
    fifo_PE3_3_res_config_out,
    fifo_PE4_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_3,
    fifo1_feed4_4,
    PE4_3_fifo1_local,
    fifo_PE4_3_op0_config_out,
    fifo_PE4_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_3_fifo0_local,
    PE4_3_fifo1_local,
    PE4_3_fifo2_local,
    fifo_PE4_3_op1_config_out,
    fifo_PE4_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_3_fifo2_local,
    fifo2_collect3_3,
    fifo2_collect4_3,
    4,
    3,
    fifo_PE4_3_compute_config_out,
    fifo_PE4_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_4,
    fifo0_feed5_4,
    PE4_4_fifo0_local,
    fifo_PE3_4_res_config_out,
    fifo_PE4_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_4,
    fifo1_feed4_5,
    PE4_4_fifo1_local,
    fifo_PE4_4_op0_config_out,
    fifo_PE4_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_4_fifo0_local,
    PE4_4_fifo1_local,
    PE4_4_fifo2_local,
    fifo_PE4_4_op1_config_out,
    fifo_PE4_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_4_fifo2_local,
    fifo2_collect3_4,
    fifo2_collect4_4,
    4,
    4,
    fifo_PE4_4_compute_config_out,
    fifo_PE4_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_5,
    fifo0_feed5_5,
    PE4_5_fifo0_local,
    fifo_PE3_5_res_config_out,
    fifo_PE4_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_5,
    fifo1_feed4_6,
    PE4_5_fifo1_local,
    fifo_PE4_5_op0_config_out,
    fifo_PE4_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_5_fifo0_local,
    PE4_5_fifo1_local,
    PE4_5_fifo2_local,
    fifo_PE4_5_op1_config_out,
    fifo_PE4_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_5_fifo2_local,
    fifo2_collect3_5,
    fifo2_collect4_5,
    4,
    5,
    fifo_PE4_5_compute_config_out,
    fifo_PE4_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_6,
    fifo0_feed5_6,
    PE4_6_fifo0_local,
    fifo_PE3_6_res_config_out,
    fifo_PE4_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_6,
    fifo1_feed4_7,
    PE4_6_fifo1_local,
    fifo_PE4_6_op0_config_out,
    fifo_PE4_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_6_fifo0_local,
    PE4_6_fifo1_local,
    PE4_6_fifo2_local,
    fifo_PE4_6_op1_config_out,
    fifo_PE4_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_6_fifo2_local,
    fifo2_collect3_6,
    fifo2_collect4_6,
    4,
    6,
    fifo_PE4_6_compute_config_out,
    fifo_PE4_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_7,
    fifo0_feed5_7,
    PE4_7_fifo0_local,
    fifo_PE3_7_res_config_out,
    fifo_PE4_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed4_7,
    fifo1_feed4_8,
    PE4_7_fifo1_local,
    fifo_PE4_7_op0_config_out,
    fifo_PE4_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_7_fifo0_local,
    PE4_7_fifo1_local,
    PE4_7_fifo2_local,
    fifo_PE4_7_op1_config_out,
    fifo_PE4_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_7_fifo2_local,
    fifo2_collect3_7,
    fifo2_collect4_7,
    4,
    7,
    fifo_PE4_7_compute_config_out,
    fifo_PE4_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed4_8,
    fifo0_feed5_8,
    PE4_8_fifo0_local,
    fifo_PE3_8_res_config_out,
    fifo_PE4_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed4_8,
    PE4_8_fifo1_local,
    fifo_PE4_8_op0_config_out,
    fifo_PE4_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE4_8_fifo0_local,
    PE4_8_fifo1_local,
    PE4_8_fifo2_local,
    fifo_PE4_8_op1_config_out,
    fifo_PE4_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE4_8_fifo2_local,
    fifo2_collect3_8,
    fifo2_collect4_8,
    4,
    8,
    fifo_PE4_8_compute_config_out,
    fifo_PE4_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_0,
    fifo0_feed6_0,
    PE5_0_fifo0_local,
    fifo_PE4_0_res_config_out,
    fifo_PE5_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_0,
    fifo1_feed5_1,
    PE5_0_fifo1_local,
    fifo_PE5_0_op0_config_out,
    fifo_PE5_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_0_fifo0_local,
    PE5_0_fifo1_local,
    PE5_0_fifo2_local,
    fifo_PE5_0_op1_config_out,
    fifo_PE5_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_0_fifo2_local,
    fifo2_collect4_0,
    fifo2_collect5_0,
    5,
    0,
    fifo_PE5_0_compute_config_out,
    fifo_PE5_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_1,
    fifo0_feed6_1,
    PE5_1_fifo0_local,
    fifo_PE4_1_res_config_out,
    fifo_PE5_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_1,
    fifo1_feed5_2,
    PE5_1_fifo1_local,
    fifo_PE5_1_op0_config_out,
    fifo_PE5_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_1_fifo0_local,
    PE5_1_fifo1_local,
    PE5_1_fifo2_local,
    fifo_PE5_1_op1_config_out,
    fifo_PE5_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_1_fifo2_local,
    fifo2_collect4_1,
    fifo2_collect5_1,
    5,
    1,
    fifo_PE5_1_compute_config_out,
    fifo_PE5_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_2,
    fifo0_feed6_2,
    PE5_2_fifo0_local,
    fifo_PE4_2_res_config_out,
    fifo_PE5_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_2,
    fifo1_feed5_3,
    PE5_2_fifo1_local,
    fifo_PE5_2_op0_config_out,
    fifo_PE5_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_2_fifo0_local,
    PE5_2_fifo1_local,
    PE5_2_fifo2_local,
    fifo_PE5_2_op1_config_out,
    fifo_PE5_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_2_fifo2_local,
    fifo2_collect4_2,
    fifo2_collect5_2,
    5,
    2,
    fifo_PE5_2_compute_config_out,
    fifo_PE5_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_3,
    fifo0_feed6_3,
    PE5_3_fifo0_local,
    fifo_PE4_3_res_config_out,
    fifo_PE5_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_3,
    fifo1_feed5_4,
    PE5_3_fifo1_local,
    fifo_PE5_3_op0_config_out,
    fifo_PE5_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_3_fifo0_local,
    PE5_3_fifo1_local,
    PE5_3_fifo2_local,
    fifo_PE5_3_op1_config_out,
    fifo_PE5_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_3_fifo2_local,
    fifo2_collect4_3,
    fifo2_collect5_3,
    5,
    3,
    fifo_PE5_3_compute_config_out,
    fifo_PE5_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_4,
    fifo0_feed6_4,
    PE5_4_fifo0_local,
    fifo_PE4_4_res_config_out,
    fifo_PE5_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_4,
    fifo1_feed5_5,
    PE5_4_fifo1_local,
    fifo_PE5_4_op0_config_out,
    fifo_PE5_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_4_fifo0_local,
    PE5_4_fifo1_local,
    PE5_4_fifo2_local,
    fifo_PE5_4_op1_config_out,
    fifo_PE5_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_4_fifo2_local,
    fifo2_collect4_4,
    fifo2_collect5_4,
    5,
    4,
    fifo_PE5_4_compute_config_out,
    fifo_PE5_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_5,
    fifo0_feed6_5,
    PE5_5_fifo0_local,
    fifo_PE4_5_res_config_out,
    fifo_PE5_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_5,
    fifo1_feed5_6,
    PE5_5_fifo1_local,
    fifo_PE5_5_op0_config_out,
    fifo_PE5_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_5_fifo0_local,
    PE5_5_fifo1_local,
    PE5_5_fifo2_local,
    fifo_PE5_5_op1_config_out,
    fifo_PE5_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_5_fifo2_local,
    fifo2_collect4_5,
    fifo2_collect5_5,
    5,
    5,
    fifo_PE5_5_compute_config_out,
    fifo_PE5_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_6,
    fifo0_feed6_6,
    PE5_6_fifo0_local,
    fifo_PE4_6_res_config_out,
    fifo_PE5_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_6,
    fifo1_feed5_7,
    PE5_6_fifo1_local,
    fifo_PE5_6_op0_config_out,
    fifo_PE5_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_6_fifo0_local,
    PE5_6_fifo1_local,
    PE5_6_fifo2_local,
    fifo_PE5_6_op1_config_out,
    fifo_PE5_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_6_fifo2_local,
    fifo2_collect4_6,
    fifo2_collect5_6,
    5,
    6,
    fifo_PE5_6_compute_config_out,
    fifo_PE5_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_7,
    fifo0_feed6_7,
    PE5_7_fifo0_local,
    fifo_PE4_7_res_config_out,
    fifo_PE5_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed5_7,
    fifo1_feed5_8,
    PE5_7_fifo1_local,
    fifo_PE5_7_op0_config_out,
    fifo_PE5_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_7_fifo0_local,
    PE5_7_fifo1_local,
    PE5_7_fifo2_local,
    fifo_PE5_7_op1_config_out,
    fifo_PE5_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_7_fifo2_local,
    fifo2_collect4_7,
    fifo2_collect5_7,
    5,
    7,
    fifo_PE5_7_compute_config_out,
    fifo_PE5_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed5_8,
    fifo0_feed6_8,
    PE5_8_fifo0_local,
    fifo_PE4_8_res_config_out,
    fifo_PE5_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed5_8,
    PE5_8_fifo1_local,
    fifo_PE5_8_op0_config_out,
    fifo_PE5_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE5_8_fifo0_local,
    PE5_8_fifo1_local,
    PE5_8_fifo2_local,
    fifo_PE5_8_op1_config_out,
    fifo_PE5_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE5_8_fifo2_local,
    fifo2_collect4_8,
    fifo2_collect5_8,
    5,
    8,
    fifo_PE5_8_compute_config_out,
    fifo_PE5_8_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_0,
    fifo0_feed7_0,
    PE6_0_fifo0_local,
    fifo_PE5_0_res_config_out,
    fifo_PE6_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_0,
    fifo1_feed6_1,
    PE6_0_fifo1_local,
    fifo_PE6_0_op0_config_out,
    fifo_PE6_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_0_fifo0_local,
    PE6_0_fifo1_local,
    PE6_0_fifo2_local,
    fifo_PE6_0_op1_config_out,
    fifo_PE6_0_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_0_fifo2_local,
    fifo2_collect5_0,
    fifo2_collect6_0,
    6,
    0,
    fifo_PE6_0_compute_config_out,
    fifo_PE6_0_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_1,
    fifo0_feed7_1,
    PE6_1_fifo0_local,
    fifo_PE5_1_res_config_out,
    fifo_PE6_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_1,
    fifo1_feed6_2,
    PE6_1_fifo1_local,
    fifo_PE6_1_op0_config_out,
    fifo_PE6_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_1_fifo0_local,
    PE6_1_fifo1_local,
    PE6_1_fifo2_local,
    fifo_PE6_1_op1_config_out,
    fifo_PE6_1_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_1_fifo2_local,
    fifo2_collect5_1,
    fifo2_collect6_1,
    6,
    1,
    fifo_PE6_1_compute_config_out,
    fifo_PE6_1_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_2,
    fifo0_feed7_2,
    PE6_2_fifo0_local,
    fifo_PE5_2_res_config_out,
    fifo_PE6_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_2,
    fifo1_feed6_3,
    PE6_2_fifo1_local,
    fifo_PE6_2_op0_config_out,
    fifo_PE6_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_2_fifo0_local,
    PE6_2_fifo1_local,
    PE6_2_fifo2_local,
    fifo_PE6_2_op1_config_out,
    fifo_PE6_2_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_2_fifo2_local,
    fifo2_collect5_2,
    fifo2_collect6_2,
    6,
    2,
    fifo_PE6_2_compute_config_out,
    fifo_PE6_2_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_3,
    fifo0_feed7_3,
    PE6_3_fifo0_local,
    fifo_PE5_3_res_config_out,
    fifo_PE6_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_3,
    fifo1_feed6_4,
    PE6_3_fifo1_local,
    fifo_PE6_3_op0_config_out,
    fifo_PE6_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_3_fifo0_local,
    PE6_3_fifo1_local,
    PE6_3_fifo2_local,
    fifo_PE6_3_op1_config_out,
    fifo_PE6_3_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_3_fifo2_local,
    fifo2_collect5_3,
    fifo2_collect6_3,
    6,
    3,
    fifo_PE6_3_compute_config_out,
    fifo_PE6_3_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_4,
    fifo0_feed7_4,
    PE6_4_fifo0_local,
    fifo_PE5_4_res_config_out,
    fifo_PE6_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_4,
    fifo1_feed6_5,
    PE6_4_fifo1_local,
    fifo_PE6_4_op0_config_out,
    fifo_PE6_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_4_fifo0_local,
    PE6_4_fifo1_local,
    PE6_4_fifo2_local,
    fifo_PE6_4_op1_config_out,
    fifo_PE6_4_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_4_fifo2_local,
    fifo2_collect5_4,
    fifo2_collect6_4,
    6,
    4,
    fifo_PE6_4_compute_config_out,
    fifo_PE6_4_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_5,
    fifo0_feed7_5,
    PE6_5_fifo0_local,
    fifo_PE5_5_res_config_out,
    fifo_PE6_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_5,
    fifo1_feed6_6,
    PE6_5_fifo1_local,
    fifo_PE6_5_op0_config_out,
    fifo_PE6_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_5_fifo0_local,
    PE6_5_fifo1_local,
    PE6_5_fifo2_local,
    fifo_PE6_5_op1_config_out,
    fifo_PE6_5_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_5_fifo2_local,
    fifo2_collect5_5,
    fifo2_collect6_5,
    6,
    5,
    fifo_PE6_5_compute_config_out,
    fifo_PE6_5_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_6,
    fifo0_feed7_6,
    PE6_6_fifo0_local,
    fifo_PE5_6_res_config_out,
    fifo_PE6_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_6,
    fifo1_feed6_7,
    PE6_6_fifo1_local,
    fifo_PE6_6_op0_config_out,
    fifo_PE6_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_6_fifo0_local,
    PE6_6_fifo1_local,
    PE6_6_fifo2_local,
    fifo_PE6_6_op1_config_out,
    fifo_PE6_6_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_6_fifo2_local,
    fifo2_collect5_6,
    fifo2_collect6_6,
    6,
    6,
    fifo_PE6_6_compute_config_out,
    fifo_PE6_6_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_7,
    fifo0_feed7_7,
    PE6_7_fifo0_local,
    fifo_PE5_7_res_config_out,
    fifo_PE6_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed6_7,
    fifo1_feed6_8,
    PE6_7_fifo1_local,
    fifo_PE6_7_op0_config_out,
    fifo_PE6_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_7_fifo0_local,
    PE6_7_fifo1_local,
    PE6_7_fifo2_local,
    fifo_PE6_7_op1_config_out,
    fifo_PE6_7_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_7_fifo2_local,
    fifo2_collect5_7,
    fifo2_collect6_7,
    6,
    7,
    fifo_PE6_7_compute_config_out,
    fifo_PE6_7_res_config_out
  )
  .invoke(U1_op0_transfer_wrapper,
    fifo0_feed6_8,
    fifo0_feed7_8,
    PE6_8_fifo0_local,
    fifo_PE5_8_res_config_out,
    fifo_PE6_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed6_8,
    PE6_8_fifo1_local,
    fifo_PE6_8_op0_config_out,
    fifo_PE6_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE6_8_fifo0_local,
    PE6_8_fifo1_local,
    PE6_8_fifo2_local,
    fifo_PE6_8_op1_config_out,
    fifo_PE6_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE6_8_fifo2_local,
    fifo2_collect5_8,
    fifo2_collect6_8,
    6,
    8,
    fifo_PE6_8_compute_config_out,
    fifo_PE6_8_res_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_0,
    PE7_0_fifo0_local,
    fifo_PE6_0_res_config_out,
    fifo_PE7_0_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_0,
    fifo1_feed7_1,
    PE7_0_fifo1_local,
    fifo_PE7_0_op0_config_out,
    fifo_PE7_0_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_0_fifo0_local,
    PE7_0_fifo1_local,
    PE7_0_fifo2_local,
    fifo_PE7_0_op1_config_out,
    fifo_PE7_0_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_0_fifo2_local,
    fifo2_collect6_0,
    fifo2_collect7_0,
    7,
    0,
    fifo_PE7_0_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_1,
    PE7_1_fifo0_local,
    fifo_PE6_1_res_config_out,
    fifo_PE7_1_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_1,
    fifo1_feed7_2,
    PE7_1_fifo1_local,
    fifo_PE7_1_op0_config_out,
    fifo_PE7_1_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_1_fifo0_local,
    PE7_1_fifo1_local,
    PE7_1_fifo2_local,
    fifo_PE7_1_op1_config_out,
    fifo_PE7_1_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_1_fifo2_local,
    fifo2_collect6_1,
    fifo2_collect7_1,
    7,
    1,
    fifo_PE7_1_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_2,
    PE7_2_fifo0_local,
    fifo_PE6_2_res_config_out,
    fifo_PE7_2_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_2,
    fifo1_feed7_3,
    PE7_2_fifo1_local,
    fifo_PE7_2_op0_config_out,
    fifo_PE7_2_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_2_fifo0_local,
    PE7_2_fifo1_local,
    PE7_2_fifo2_local,
    fifo_PE7_2_op1_config_out,
    fifo_PE7_2_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_2_fifo2_local,
    fifo2_collect6_2,
    fifo2_collect7_2,
    7,
    2,
    fifo_PE7_2_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_3,
    PE7_3_fifo0_local,
    fifo_PE6_3_res_config_out,
    fifo_PE7_3_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_3,
    fifo1_feed7_4,
    PE7_3_fifo1_local,
    fifo_PE7_3_op0_config_out,
    fifo_PE7_3_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_3_fifo0_local,
    PE7_3_fifo1_local,
    PE7_3_fifo2_local,
    fifo_PE7_3_op1_config_out,
    fifo_PE7_3_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_3_fifo2_local,
    fifo2_collect6_3,
    fifo2_collect7_3,
    7,
    3,
    fifo_PE7_3_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_4,
    PE7_4_fifo0_local,
    fifo_PE6_4_res_config_out,
    fifo_PE7_4_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_4,
    fifo1_feed7_5,
    PE7_4_fifo1_local,
    fifo_PE7_4_op0_config_out,
    fifo_PE7_4_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_4_fifo0_local,
    PE7_4_fifo1_local,
    PE7_4_fifo2_local,
    fifo_PE7_4_op1_config_out,
    fifo_PE7_4_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_4_fifo2_local,
    fifo2_collect6_4,
    fifo2_collect7_4,
    7,
    4,
    fifo_PE7_4_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_5,
    PE7_5_fifo0_local,
    fifo_PE6_5_res_config_out,
    fifo_PE7_5_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_5,
    fifo1_feed7_6,
    PE7_5_fifo1_local,
    fifo_PE7_5_op0_config_out,
    fifo_PE7_5_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_5_fifo0_local,
    PE7_5_fifo1_local,
    PE7_5_fifo2_local,
    fifo_PE7_5_op1_config_out,
    fifo_PE7_5_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_5_fifo2_local,
    fifo2_collect6_5,
    fifo2_collect7_5,
    7,
    5,
    fifo_PE7_5_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_6,
    PE7_6_fifo0_local,
    fifo_PE6_6_res_config_out,
    fifo_PE7_6_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_6,
    fifo1_feed7_7,
    PE7_6_fifo1_local,
    fifo_PE7_6_op0_config_out,
    fifo_PE7_6_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_6_fifo0_local,
    PE7_6_fifo1_local,
    PE7_6_fifo2_local,
    fifo_PE7_6_op1_config_out,
    fifo_PE7_6_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_6_fifo2_local,
    fifo2_collect6_6,
    fifo2_collect7_6,
    7,
    6,
    fifo_PE7_6_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_7,
    PE7_7_fifo0_local,
    fifo_PE6_7_res_config_out,
    fifo_PE7_7_op0_config_out
  )
  .invoke(U1_op1_transfer_wrapper,
    fifo1_feed7_7,
    fifo1_feed7_8,
    PE7_7_fifo1_local,
    fifo_PE7_7_op0_config_out,
    fifo_PE7_7_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_7_fifo0_local,
    PE7_7_fifo1_local,
    PE7_7_fifo2_local,
    fifo_PE7_7_op1_config_out,
    fifo_PE7_7_compute_config_out
  )
  .invoke(U1_res_transfer_last,
    PE7_7_fifo2_local,
    fifo2_collect6_7,
    fifo2_collect7_7,
    7,
    7,
    fifo_PE7_7_compute_config_out
  )
  .invoke(U1_op0_transfer_last_wrapper,
    fifo0_feed7_8,
    PE7_8_fifo0_local,
    fifo_PE6_8_res_config_out,
    fifo_PE7_8_op0_config_out
  )
  .invoke(U1_op1_transfer_last_wrapper,
    fifo1_feed7_8,
    PE7_8_fifo1_local,
    fifo_PE7_8_op0_config_out,
    fifo_PE7_8_op1_config_out
  )
  .invoke(U1_compute_wrapper,
    PE7_8_fifo0_local,
    PE7_8_fifo1_local,
    PE7_8_fifo2_local,
    fifo_PE7_8_op1_config_out,
    fifo_PE7_8_compute_config_out
  )
  .invoke(U1_res_transfer_wrapper,
    PE7_8_fifo2_local,
    fifo2_collect6_8,
    fifo2_collect7_8,
    7,
    8,
    fifo_PE7_8_compute_config_out,
    fifo_PE7_8_res_config_out
  )
  .invoke(U1_DataCollect2EngineLast,
    fifo2_transfer0,
    fifo2_collect7_8,
    8,
    fifo_PE7_8_res_config_out,
    fifo_DataCollect2Engine8_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer0,
    fifo2_transfer1,
    fifo2_collect7_7,
    7,
    fifo_DataCollect2Engine8_config_out,
    fifo_DataCollect2Engine7_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer1,
    fifo2_transfer2,
    fifo2_collect7_6,
    6,
    fifo_DataCollect2Engine7_config_out,
    fifo_DataCollect2Engine6_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer2,
    fifo2_transfer3,
    fifo2_collect7_5,
    5,
    fifo_DataCollect2Engine6_config_out,
    fifo_DataCollect2Engine5_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer3,
    fifo2_transfer4,
    fifo2_collect7_4,
    4,
    fifo_DataCollect2Engine5_config_out,
    fifo_DataCollect2Engine4_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer4,
    fifo2_transfer5,
    fifo2_collect7_3,
    3,
    fifo_DataCollect2Engine4_config_out,
    fifo_DataCollect2Engine3_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer5,
    fifo2_transfer6,
    fifo2_collect7_2,
    2,
    fifo_DataCollect2Engine3_config_out,
    fifo_DataCollect2Engine2_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer6,
    fifo2_transfer7,
    fifo2_collect7_1,
    1,
    fifo_DataCollect2Engine2_config_out,
    fifo_DataCollect2Engine1_config_out
  )
  .invoke(U1_DataCollect2Engine0_wrapper,
    fifo2_transfer7,
    fifo2_transfer8,
    fifo2_collect7_0,
    0,
    fifo_DataCollect2Engine1_config_out,
    fifo_DataCollect2Engine0_config_out
  )
  .invoke(U1_DataCollect2Head,
    fifo_data_bypass,
    fifo_config_bypass,
    SA_to_upsample_0,
    fifo2_transfer8,
    fifo_DataCollect2Engine0_config_out
  )
  .invoke(pool, 
  		start_inst, end_inst,
  		cin_load_prev_to_pool_0, 
  		config_SA_to_pool,
  		pool_to_concat_0, 
  		config_pool_to_upsample
  )
  .invoke(upsample, 
  		start_inst, end_inst,
  		SA_to_upsample_0, 
  		config_pool_to_upsample,
  		upsample_to_concat_0, 
  		config_upsample_to_concat
  )
  .invoke(concat, 
  		start_inst, end_inst,
  		pool_to_concat_0, 
  		upsample_to_concat_0, 
  		config_upsample_to_concat,
  		concat_to_add_0, 
  		concat_to_add_1, 
  		config_concat_to_add
  )
  .invoke(add, 
  		start_inst, end_inst,
  		concat_to_add_0, 
  		concat_to_add_1, 
  		config_concat_to_add,
  		add_to_act_and_bn_0, 
  		config_add_to_act_and_bn
  )
  .invoke(act_and_bn, 
  		start_inst, end_inst,
  		bias_load_to_act_and_bn_0, 
  		bias_load_to_act_and_bn_1, 
  		add_to_act_and_bn_0, 
  		config_add_to_act_and_bn,
  		act_and_bn_to_cout_write_0, 
  		config_act_and_bn_to_cout_write
  )
  .invoke(cout_write, 
  		start_inst, end_inst,
  		act_and_bn_to_cout_write_0, 
  		config_act_and_bn_to_cout_write,
  		dram_b0, 
  		cin_to_cout_sync, cout_to_cin_sync
  );
}
